# Story 6.2: 内容闸门（双边证据/失败路径/反喊单）

## Status
Approved

## Story
**作为** 系统（Validator），  
**我希望** 对 Report v1 JSON 执行内容闸门校验（证据数量、失败路径、反“喊单”等），  
**以便** 不合规报告被阻断并返回明确失败原因。

Epic Context: 对应 Epic 6「Validator 与补搜闭环」的 E6-S2。  
[Source: prd/epic-plan.md#Epic 6：Validator 与补搜闭环]

Dependencies: 依赖 E6-S1（Schema 校验与错误码返回）与 Report v1 JSON 输出稳定。  
[Source: prd/epic-plan.md#Epic 6：Validator 与补搜闭环]  
[Source: prd/appendices/report-v1-schema.md#附录 B：Report v1 JSON Schema（0–100 概率）]

## Acceptance Criteria
1. `context.resolution_rules_raw` 不能为空；否则阻断并返回错误码。  
   [Source: prd/appendices/validator.md#F2. 内容闸门（失败则阻断发布）]
2. `disagreement_map.pro` 与 `disagreement_map.con` 各 ≥ 2；不足则阻断并给出“证据不足”原因。  
   [Source: prd/appendices/validator.md#F2. 内容闸门（失败则阻断发布）]
3. `priced_vs_new` 中每条必须包含 `source_type` 且值域为五选一（官方公告/主流媒体/社交讨论/链上数据/市场行为）。  
   [Source: prd/appendices/validator.md#F2. 内容闸门（失败则阻断发布）]
4. `failure_modes` 至少 2 条，且每条 `observable_signals` 非空且长度 ≥ 阈值（默认建议 ≥ 20 字，可配置）。  
   [Source: prd/appendices/validator.md#F2. 内容闸门（失败则阻断发布）]
5. 引用 URL 最低线：总计 ≥ 4 个不同 URL，且域名不全相同；不足则阻断。  
   [Source: prd/appendices/validator.md#F2. 内容闸门（失败则阻断发布）]
6. 反“喊单”黑名单命中即阻断（buy/long/short/重仓/梭哈/建议下注 等）。  
   [Source: prd/appendices/validator.md#F2. 内容闸门（失败则阻断发布）]  
   [Source: prd/prd-core.md#B5. 成功指标（Week 1 可观察）]
7. 若 `sentiment.samples` 为空，则 `sentiment.bias` 与 `sentiment.relation` 必须为 `unknown`；否则阻断。  
   [Source: prd/appendices/validator.md#F2. 内容闸门（失败则阻断发布）]
8. `ai_vs_market.drivers` 长度 1–3，且不得出现“喊单”措辞；违规则阻断。  
   [Source: prd/appendices/validator.md#F2. 内容闸门（失败则阻断发布）]

## Tasks / Subtasks
- [ ] Task 1：实现内容闸门规则与错误码映射（AC: 1-8）  
  [Source: prd/appendices/validator.md#F2. 内容闸门（失败则阻断发布）]  
  [Source: architecture/coding-standards.md#6.1 统一 AppError]
  - [ ] Subtask 1.1：在 `src/validator/gates.ts` 实现各项规则检查
  - [ ] Subtask 1.2：为每条规则配置明确 `VALIDATOR_*` 错误码与可读 message/suggestion
  - [ ] Subtask 1.3：黑名单词表可配置/可扩展（至少含 buy/long/short/梭哈/重仓/建议下注）
- [ ] Task 2：在 Validator 入口聚合闸门结果（AC: 1-8）  
  [Source: architecture/source-tree.md#1) 源码目录结构（AI Signal Bot）]
  - [ ] Subtask 2.1：`validateReport()` 在 schema 通过后执行内容闸门
  - [ ] Subtask 2.2：首个失败即返回（避免多重冲突），保留 `suggestion` 以提示补搜
- [ ] Task 3：补充内容闸门测试（AC: 1-8）  
  [Source: architecture/coding-standards.md#11.3 单元测试范围（必须覆盖“各种情况”)]
  - [ ] Subtask 3.1：覆盖每条闸门规则的失败/通过用例
  - [ ] Subtask 3.2：覆盖黑名单触发与 drivers 违规的阻断路径

## Dev Notes
### Previous Story Insights
No specific guidance found in architecture docs.  
[Source: architecture/architecture-core.md]

### Data Models
- Report v1 JSON 字段约束见 schema（evidenceItem/source_type 等）。  
  [Source: prd/appendices/report-v1-schema.md#附录 B：Report v1 JSON Schema（0–100 概率）]

### API Specifications
- Validator 返回 `{ok, code, message, suggestion}`，失败则阻断发布。  
  [Source: prd/appendices/validator.md#F3. 失败原因返回格式（建议）]

### Component Specifications
- 反“喊单”黑名单与内容闸门在 Validator 侧实施。  
  [Source: prd/appendices/validator.md#F2. 内容闸门（失败则阻断发布）]
- 错误码遵循 `VALIDATOR_*` 命名规范与 AppError 结构。  
  [Source: architecture/coding-standards.md#6.1 统一 AppError]  
  [Source: architecture/coding-standards.md#6.2 错误码命名规范（便于聚合)]

### File Locations
- `src/validator/gates.ts`：内容闸门规则实现。  
  [Source: architecture/source-tree.md#1) 源码目录结构（AI Signal Bot）]
- `src/validator/index.ts`：Validator 入口聚合。  
  [Source: architecture/source-tree.md#1) 源码目录结构（AI Signal Bot）]

### Testing Requirements
- 单测覆盖所有分支/边界/错误路径。  
  [Source: architecture/coding-standards.md#11.3 单元测试范围（必须覆盖“各种情况”)]

### Technical Constraints
- 黑名单词命中即阻断，避免任何下注建议。  
  [Source: prd/prd-core.md#B5. 成功指标（Week 1 可观察）]

### Project Structure Notes
- `docs/architecture/unified-project-structure.md` 未找到；使用 `docs/architecture/source-tree.md` 作为目录结构依据。  
  [Source: architecture/source-tree.md#1) 源码目录结构（AI Signal Bot）]

## Change Log
| Date       | Version | Description | Author |
| ---------- | ------- | ----------- | ------ |
| 2026-01-27 | 0.1     | 创建故事草稿 | Bob    |
| 2026-01-27 | 0.2     | 校验通过，状态调整为 Approved | Winston |

## Dev Agent Record
### Agent Model Used

### Debug Log References

### Completion Notes List

### File List

## QA Results
