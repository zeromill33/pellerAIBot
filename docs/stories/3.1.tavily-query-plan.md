# Story 3.1: Tavily A/B/C 查询生成规则与默认参数落地

## Status
Done

## Story
**作为** 系统（Query Strategy/Orchestrator），  
**我希望** 基于 MarketContext 生成 Tavily A/B/C 车道的 query plan，并落地默认参数配置，  
**以便** 后续检索步骤可以稳定、可配置地获取多车道证据。

Epic Context: 对应 Epic 3「Tavily 多车道检索」的 E3-S1。  
[Source: prd/epic-plan.md#Epic 3：Tavily 多车道检索]

Dependencies: E2-S1（Gamma 市场元数据 → MarketContext）。  
[Source: prd/epic-plan.md#Epic 2：市场数据采集与流动性代理]

## Acceptance Criteria
1. Query plan 生成使用输入字段：`title`、`description`、`resolution_rules_raw`、`end_time`（可选 `category`），并输出 A/B/C 三车道的查询文本。  
   [Source: prd/appendices/tavily-query-generator.md#D2 输入字段]
2. A/B/C 车道语义与用途严格对应：A=Update、B=Primary、C=Counter，并分别使用对应车道的模板生成查询。  
   [Source: prd/appendices/tavily-query-generator.md#D1 车道定义（Week 1 默认 A+B+C，D 条件触发）]  
   [Source: prd/appendices/tavily-query-generator.md#D4 Query 模板（按车道）]
3. Query 生成遵循“短而准”原则（建议单条 < 400 chars），并包含基于 `subject_entities`/`action`/`object`/`time_anchor` 组合而成的关键信息。  
   [Source: prd/appendices/tavily-query-generator.md#D3 实体抽取（最小可行）]
4. Tavily 默认参数配置符合附录 D 与配置规范：全局 `include_raw_content`/`include_answer`/`auto_parameters`，以及 A/B/C 车道的 `search_depth`/`max_results`/`time_range`（其中 C 默认 advanced）；本故事采用 PRD/配置示例的默认值（`include_raw_content=true`）。  
   [Source: prd/appendices/tavily-query-generator.md#D5 Tavily 参数默认值（配置化）]  
   [Source: prd/appendices/config.md#tavily]  
   [Source: architecture/providers/tavily.md#C.2 核心参数（MVP 推荐值）]
5. 默认仅生成 A/B/C query plan；D 车道保持条件触发模式，不在本故事内启用。  
   [Source: prd/appendices/tavily-query-generator.md#D1 车道定义（Week 1 默认 A+B+C，D 条件触发）]  
   [Source: prd/appendices/tavily-query-generator.md#D6 触发补搜（节省额度的控制策略）]
6. 当输入字段缺失或为空时，Query 生成需降级为仅使用可用字段且避免生成空 query；无法生成时返回标准化 `AppError`。  
   [Source: prd/appendices/tavily-query-generator.md#D2 输入字段]  
   [Source: architecture/coding-standards.md#6.1 统一 AppError]
7. 验收示例：当 `title`/`description` 为空但 `resolution_rules_raw` 或 `end_time` 可用时，仍能生成 A/B/C 的非空 query（含 time anchor）。  
   [Source: prd/appendices/tavily-query-generator.md#D2 输入字段]  
   [Source: prd/appendices/tavily-query-generator.md#D3 实体抽取（最小可行）]
8. 验收示例：当 `title`、`description`、`resolution_rules_raw`、`end_time` 均为空时，QueryStrategy 需返回 `AppError`（code 命名遵循 `STEP_*` 规范）。  
   [Source: prd/appendices/tavily-query-generator.md#D2 输入字段]  
   [Source: architecture/coding-standards.md#6.1 统一 AppError]  
   [Source: architecture/coding-standards.md#6.2 错误码命名规范（便于聚合）]

## Tasks / Subtasks
- [x] Task 1：实现/更新 QueryStrategy 生成 A/B/C 车道 query plan（AC: 1, 2, 3, 5）  
  [Source: architecture/architecture-core.md#4.1 主流程（单事件）]  
  [Source: architecture/coding-standards.md#2.1 Step 文件命名与顺序编排]  
  [Source: architecture/coding-standards.md#2.2 Step 统一接口（强约束）]  
  [Source: architecture/coding-standards.md#6.1 统一 AppError]
  - [x] Subtask 1.1：在 `query.plan.build.step.ts` 中根据 MarketContext 构建 A/B/C 查询文本
  - [x] Subtask 1.2：将 query plan 写入 ctx，供 `search.tavily.step.ts` 消费
  - [x] Subtask 1.3：如需，更新 `src/orchestrator/types.ts` 中 query plan 相关 DTO
  - [x] Subtask 1.4：输入字段为空时做降级处理，确保不生成空 query；不可生成时抛 `AppError`
- [x] Task 2：落地 Tavily A/B/C 默认参数与配置化加载（AC: 4）  
  [Source: architecture/source-tree.md#1) 源码目录结构（AI Signal Bot）]  
  [Source: architecture/coding-standards.md#7.1 配置加载与校验（启动期失败）]
  - [x] Subtask 2.1：在 `src/config/defaults.ts`/`config.schema.ts` 中补齐 Tavily lane 默认值
  - [x] Subtask 2.2：在 `src/providers/tavily/lanes.ts` 中读取配置并生成 lane 参数
  - [x] Subtask 2.3：将 `include_raw_content` 默认值设置为 `true` 并记录配置覆盖行为
- [x] Task 3：补充测试覆盖 Query plan 与 lane 默认参数（AC: 1-4）  
  [Source: architecture/tech-stack.md#9) 测试策略]  
  [Source: architecture/coding-standards.md#11.4 Provider 集成测试（外部依赖：必须有“可回放”测试）]  
  [Source: architecture/coding-standards.md#11.8 可重复性（Determinism）要求]
  - [x] Subtask 3.1：新增/更新单元测试验证 A/B/C query 生成与长度约束
  - [x] Subtask 3.2：新增/更新测试验证 Tavily lane 默认参数与配置覆盖行为
  - [x] Subtask 3.3：新增/更新测试覆盖输入字段缺失时的降级与错误路径
  - [x] Subtask 3.4：新增/更新测试覆盖空输入时 `STEP_*` 错误码返回
  - [x] Subtask 3.5：新增/更新测试覆盖 `include_raw_content=true` 默认值

## Dev Notes
### Previous Story Insights
No specific guidance found in architecture docs.  
[Source: architecture/architecture-core.md]

### Data Models
- `MarketContext` 包含 `title`、`description`、`resolution_rules_raw`、`end_time` 等字段，可用于 Query 生成输入。  
  [Source: architecture/architecture-core.md#3.2 核心数据结构（内部标准化 DTO）]
- `TavilyLaneResult` 结构包含 `lane`、`query`、`results[{title,url,domain,published_at,raw_content}]`。  
  [Source: architecture/architecture-core.md#3.2 核心数据结构（内部标准化 DTO）]

### API Specifications
- `SearchProvider` 提供 `search`/`batchSearch` 接口，Week 1 使用 Tavily。  
  [Source: architecture/architecture-core.md#3.1 Provider 接口清单（概览）]
- 主流程中 QueryStrategy 在 Tavily 多车道检索之前执行。  
  [Source: architecture/architecture-core.md#4.1 主流程（单事件）]

### Component Specifications
- Step 文件命名与顺序仅在 `pipeline.ts` 中声明，Step 需实现统一接口（`id`/`run`/`requires`/`produces`）。  
  [Source: architecture/coding-standards.md#2.1 Step 文件命名与顺序编排]  
  [Source: architecture/coding-standards.md#2.2 Step 统一接口（强约束）]
- Tavily 调用采用 `POST /search`，鉴权使用 `Authorization: Bearer tvly-...`。  
  [Source: architecture/providers/tavily.md#C.1 Base URL 与鉴权]
- Tavily 关键参数包括 `query`、`search_depth`、`max_results`、`include_raw_content`、`include_answer`。  
  [Source: architecture/providers/tavily.md#C.2 核心参数（MVP 推荐值）]
- 多车道策略默认 A/B/C，D 为条件触发且需执行 2–3 类查询。  
  [Source: architecture/providers/tavily.md#C.3 多查询 vs 单查询：如何“既有效又省额度”]

### Parameter Decision
- `include_raw_content` 采用 PRD/配置示例默认值 `true`；架构附录给出的 Week 1 默认值为 `false`，此处以 PRD 为准并记录冲突。  
  [Source: prd/appendices/config.md#tavily]  
  [Source: architecture/providers/tavily.md#C.2 核心参数（MVP 推荐值）]

### Edge Cases / 验收示例
- `title`/`description` 缺失：使用 `resolution_rules_raw` 与 `end_time` 构造 query（避免空字符串）。  
  [Source: prd/appendices/tavily-query-generator.md#D2 输入字段]  
  [Source: prd/appendices/tavily-query-generator.md#D3 实体抽取（最小可行）]
- 全部输入字段缺失：返回 `AppError`（遵循错误码命名规范），且不得生成空 query。  
  [Source: architecture/coding-standards.md#6.1 统一 AppError]  
  [Source: architecture/coding-standards.md#6.2 错误码命名规范（便于聚合）]

### Environment Variables
- `TAVILY_API_KEY` 仅通过环境变量注入（不写入 repo/日志/DB），并在配置加载时绑定到 Tavily 相关配置字段。  
  [Source: architecture/coding-standards.md#7.2 Secrets 管理]  
  [Source: architecture/architecture-core.md#9 安全与合规（Week 1 必须做到的“底线”）]  
  [Source: prd/appendices/config.md#tavily]

### File Locations
建议按现有结构实现/修改下列位置：  
- `src/orchestrator/steps/query.plan.build.step.ts`（QueryStrategy 生成 query plan）  
- `src/orchestrator/steps/search.tavily.step.ts`（消费 query plan 并调用 Tavily）  
- `src/orchestrator/pipeline.ts`（Step 顺序唯一声明处）  
- `src/orchestrator/types.ts`（Query plan 相关 DTO）  
- `src/providers/tavily/lanes.ts`（A/B/C/D 车道参数与策略）  
- `src/config/defaults.ts`、`src/config/config.schema.ts`（配置默认值与校验）  
[Source: architecture/source-tree.md#1) 源码目录结构（AI Signal Bot）]

### Testing Requirements
- 单元测试覆盖 Query Strategy 规则与参数；集成测试使用 recorded fixtures。  
  [Source: architecture/tech-stack.md#9) 测试策略]  
  [Source: architecture/coding-standards.md#11.4 Provider 集成测试（外部依赖：必须有“可回放”测试）]
- 测试需保证可重复性（固定时间/随机）。  
  [Source: architecture/coding-standards.md#11.8 可重复性（Determinism）要求]
- 关键场景：  
  - `title/description` 缺失但 `resolution_rules_raw` 或 `end_time` 存在时，A/B/C 均生成非空 query  
  - 全部输入字段缺失时，返回 `AppError` 且错误码符合 `STEP_*` 规范  
  - `include_raw_content` 默认值为 `true` 且可被配置覆盖  
  [Source: prd/appendices/tavily-query-generator.md#D2 输入字段]  
  [Source: architecture/coding-standards.md#6.2 错误码命名规范（便于聚合）]  
  [Source: prd/appendices/config.md#tavily]
- E2E：按 `docs/stories/9.5.e2e-pipeline-regression.md` 的入口与规范执行，在 fake providers 的 E2E 路径中覆盖 Query Plan A/B/C 生成与输出可观测性（至少包含 `step_id`、`event_slug`）。  
  [Source: docs/stories/9.5.e2e-pipeline-regression.md#Acceptance Criteria]  
  [Source: architecture/coding-standards.md#11.7 端到端 E2E（最小 smoke，保证“交互闭环”）]  
  [Source: architecture/coding-standards.md#9.1 结构化日志（必须）]

### Technical Constraints
- TypeScript 严格模式、Node.js 18+/20、ESM 模块制式。  
  [Source: architecture/tech-stack.md#2) 语言与运行时]
- 配置需在启动期通过 schema 校验，避免运行中发现缺字段。  
  [Source: architecture/coding-standards.md#7.1 配置加载与校验（启动期失败）]

### Project Structure Notes
- `docs/architecture/unified-project-structure.md` 未找到；使用 `docs/architecture/source-tree.md` 作为目录结构依据。  
  [Source: architecture/source-tree.md#1) 源码目录结构（AI Signal Bot）]
- `docs/architecture/testing-strategy.md` 未找到；使用 `tech-stack.md` 与 `coding-standards.md` 中的测试策略说明。  
  [Source: architecture/tech-stack.md#9) 测试策略]  
  [Source: architecture/coding-standards.md#11.4 Provider 集成测试（外部依赖：必须有“可回放”测试）]

## Change Log
| Date       | Version | Description | Author |
| ---------- | ------- | ----------- | ------ |
| 2026-01-24 | 0.1     | 创建故事草稿 | Bob |
| 2026-01-26 | 0.2     | 实现 Tavily A/B/C 查询计划与默认参数配置 | James |
| 2026-01-26 | 0.3     | 修复空描述回退逻辑并补测试 | James |

## Dev Agent Record
### Agent Model Used
- GPT-5

### Debug Log References
- `npm test`

### Completion Notes List
- 新增 Tavily A/B/C query plan 生成与降级逻辑，补齐空输入 AppError。
- 添加 Tavily 默认参数与 lane 配置解析，支持配置覆盖。
- 扩展 MarketContext 与错误码，补齐 Query plan/Lane 参数测试覆盖。
- 修复 description 为空时回退到规则/标题信息，避免查询过泛。

### File List
- src/config/config.schema.ts
- src/config/defaults.ts
- src/config/load.ts
- src/orchestrator/errors.ts
- src/orchestrator/types.ts
- src/orchestrator/steps/query.plan.build.step.ts
- src/providers/tavily/lanes.ts
- tests/config.test.ts
- tests/orchestrator/query-plan.step.test.ts
- tests/providers/tavily/lanes.test.ts

## QA Results
