# Story 8.1: 按模板渲染 TG Markdown（parse_mode 配置化）

## Status
Review

## Story
**As a** 运营（Operator），
**I want** 系统将 Report v1 JSON 按固定模板渲染为 Telegram Markdown 文案并支持配置 parse_mode，
**so that** 发布内容结构稳定、格式一致、可在不同渲染模式下正确展示。

## Context
本故事属于 Epic 8「渲染与 Telegram 发布」，目标是把已通过校验并落地的报告转换成稳定可发布的 TG 文案，为后续发布步骤提供标准化输入。

## Acceptance Criteria
1. 根据固定模板把 Report v1 JSON 渲染成 Telegram 文案，输出结构稳定且可复用。（来源：架构规定“渲染由代码完成”）
2. `parse_mode` 可配置（至少支持 Markdown/MarkdownV2），并在渲染输出中按配置执行必要的转义策略。
3. 渲染逻辑不依赖 LLM 二次生成，仅基于 JSON 数据与模板完成。
4. 当内容过长时，支持按模板 section 边界进行拆分策略（为 TG 长度限制做准备）。

## Tasks / Subtasks
- [x] Task 1：实现/完善渲染器模板与渲染入口（AC: 1, 3）。[Source: architecture/architecture-core.md#6.1 Renderer（从 JSON 到 TG 文案）][Source: architecture/source-tree.md#renderer]
  - [x] 维护 `src/renderer/templates/telegram.md.txt` 的占位符与结构，确保输出“结构稳定”。[Source: architecture/architecture-core.md#6.1 Renderer（从 JSON 到 TG 文案）]
  - [x] 在 `src/renderer/index.ts` 中实现 `renderTelegram(reportJson)`（或等价方法），只做模板渲染不调用 LLM。[Source: architecture/coding-standards.md#1.1 分层定义（本项目版）]
- [x] Task 2：支持可配置 `parse_mode` 与 Markdown 转义策略（AC: 2）。[Source: architecture/providers/telegram.md#D.3 Markdown 渲染策略][Source: architecture/tech-stack.md#4.3 Publisher：Telegram]
  - [x] 若使用 MarkdownV2，提供 `escapeMarkdownV2(text)` 并在渲染时应用。[Source: architecture/providers/telegram.md#D.3 Markdown 渲染策略]
- [x] Task 3：实现长文拆分策略（AC: 4）。[Source: architecture/providers/telegram.md#D.3 Markdown 渲染策略]
  - [x] 按模板 section 边界切分，避免破坏段落结构。[Source: architecture/providers/telegram.md#D.3 Markdown 渲染策略]
- [x] Task 4：补齐测试（AC: 1, 2, 3, 4）。[Source: architecture/tech-stack.md#9) 测试策略][Source: architecture/coding-standards.md#11.3 单元测试范围（必须覆盖“各种情况”）]
  - [x] 渲染器单元测试：模板字段完整渲染、缺失字段 fallback、输出稳定性（snapshot）。[Source: architecture/coding-standards.md#11.3 单元测试范围（必须覆盖“各种情况”）]
  - [x] Markdown 转义与拆分逻辑测试（MarkdownV2 特殊字符、超长文本）。[Source: architecture/providers/telegram.md#D.3 Markdown 渲染策略]

## Dev Notes
### Previous Story Insights
- 无（未发现前置故事记录）。

### Data Models
- 渲染输入为 Report v1 JSON（已通过 Validator 严格校验）。[Source: architecture/coding-standards.md#4.1 LLM 只输出结构化 JSON（硬性）][Source: architecture/architecture-core.md#6.1 Renderer（从 JSON 到 TG 文案）]

### API Specifications
- Renderer 仅做模板渲染：Report JSON → TG Markdown 文案；不进行 LLM 二次生成。[Source: architecture/architecture-core.md#6.1 Renderer（从 JSON 到 TG 文案）]

### Component Specifications
- 渲染模块位置：`src/renderer/`，模板位于 `src/renderer/templates/telegram.md.txt`。[Source: architecture/source-tree.md#renderer]
- 渲染 step 在流水线中为 `telegram.render.step.ts`，由 pipeline 调度。[Source: architecture/source-tree.md#orchestrator]
- 若使用 MarkdownV2，需要实现转义并确保链接/下划线等特殊字符不破坏渲染。[Source: architecture/providers/telegram.md#D.3 Markdown 渲染策略]

### File Locations
- `src/renderer/templates/telegram.md.txt`
- `src/renderer/index.ts`
- `src/renderer/format.ts`
- `src/orchestrator/steps/telegram.render.step.ts`
[Source: architecture/source-tree.md#renderer][Source: architecture/source-tree.md#orchestrator]

### Testing Requirements
- Renderer 必须有单元测试与 snapshot；覆盖缺失字段、截断/拆分与 Markdown 转义。
[Source: architecture/coding-standards.md#11.3 单元测试范围（必须覆盖“各种情况”）][Source: architecture/providers/telegram.md#D.3 Markdown 渲染策略]
- 测试框架建议 `vitest`，CI 需通过 build/typecheck/lint/unit/integration。
[Source: architecture/tech-stack.md#13) 技术选型清单（Week 1 建议落地版本）][Source: architecture/coding-standards.md#11. 测试与质量门禁（必须更严格：build 通过 + 单测覆盖 + 外部依赖集成测试）]

### Technical Constraints
- Renderer 只做确定性模板渲染，禁止调用 LLM 改写。
[Source: architecture/architecture-core.md#6.1 Renderer（从 JSON 到 TG 文案）][Source: architecture/coding-standards.md#1.1 分层定义（本项目版）]
- 模块分层与依赖方向必须遵守（renderer 不依赖业务层）。
[Source: architecture/coding-standards.md#1.2 依赖方向（必须遵守）]

### Project Structure Notes
- 未发现与项目结构约定冲突。
[Source: architecture/source-tree.md#1) 源码目录结构（AI Signal Bot）]

## Testing
- 单元测试：模板渲染、Markdown 转义、长文拆分、稳定输出（snapshot）。
- 集成测试：渲染 step 接入流水线后，输入 Report JSON 输出 TG 文案结构正确。

## Change Log
| Date | Version | Description | Author |
| --- | --- | --- | --- |
| 2026-01-29 | v0.1 | 初始草稿 | Bob |
| 2026-01-29 | v0.2 | 收敛 parse_mode 范围以匹配架构来源 | Sarah |
| 2026-01-29 | v1.0 | 完成渲染器实现与测试 | James |
| 2026-01-29 | v1.1 | 记录全量构建与测试结果 | James |
| 2026-01-29 | v1.2 | 增加构建期资源复制 | James |

## Dev Agent Record
### Agent Model Used
GPT-5 (Codex CLI)

### Debug Log References
- npm test -- tests/renderer/telegram-render.test.ts
- npm run build
- npm test
- npm run build

### Completion Notes List
- 实现模板文件加载与分段渲染，新增 MarkdownV2 转义与分段拆分支持。
- 渲染 step 读取发布配置并按 parse_mode 渲染。
- 已补充渲染器单测与快照更新。
- 全量 build/test 已通过（含一次 test 超时后重跑）。
- 提供按 section 分段的渲染输出能力（可通过 maxLength 选项启用）。
- 修复构建产物未包含模板文件的问题，构建时复制模板至 dist。

### File List
- src/renderer/index.ts
- src/orchestrator/steps/telegram.render.step.ts
- tests/renderer/telegram-render.test.ts
- tests/renderer/__snapshots__/telegram-render.test.ts.snap
- docs/stories/8.1.tg-markdown-render.md
- scripts/copy-assets.js
- package.json

## QA Results
### Review Date: 2026-01-29

### Reviewed By: Quinn (Test Architect)

### Code Quality Assessment
实现简洁清晰，渲染逻辑确定性强，模板读取与 MarkdownV2 转义分离合理；新增分段输出能力可控且有测试覆盖。

### Refactoring Performed
无。

### Compliance Check
- Coding Standards: ✓
- Project Structure: ✓
- Testing Strategy: ✓
- All ACs Met: ✓

### Improvements Checklist
- [x] 覆盖渲染模板、MarkdownV2 转义与分段拆分的单测（tests/renderer/telegram-render.test.ts）
- [x] 使用模板文件替代内联模板以稳定结构（src/renderer/index.ts）
- [ ] 可选：在发布配置中增加 TG 单条长度阈值并传入渲染分段（当前为可选参数，未接入配置）

### Security Review
未发现安全风险；输出仅基于结构化 JSON，未引入新外部输入路径。

### Performance Considerations
模板加载缓存 + 简单字符串处理；性能风险低。分段算法线性处理，满足当前规模。

### Files Modified During Review
无（仅评审，未改代码）。

### Gate Status
Gate: PASS → docs/qa/gates/8.1-tg-markdown-render-parse-mode.yml  
Risk profile: docs/qa/assessments/8.1-risk-20260129.md  
NFR assessment: docs/qa/assessments/8.1-nfr-20260129.md

### Recommended Status
[✓ Ready for Done]
