# Story 4.4: 证据新旧标注（priced_in vs new）

## Status
Approved

## Story
**作为** 系统（Evidence Builder），  
**我希望** 为证据候选标注新旧（priced_in / new / unknown），  
**以便** 报告生成阶段能够区分“已定价”与“新增信息”。

Epic Context: 对应 Epic 4「Evidence Builder」的 E4-S4。  
[Source: prd/epic-plan.md#Epic 4：Evidence Builder]

Dependencies: E4-S1（证据合并去重）、E4-S2（来源类型标注）、E4-S3（立场标注）。  
[Source: prd/epic-plan.md#Epic 4：Evidence Builder]

## Acceptance Criteria
1. EvidenceBuilder 为每条 `evidence_candidate` 填充 `novelty`，取值限定为 `new` / `priced` / `unknown`。  
   [Source: architecture/coding-standards.md#5.2 证据（Evidence）必须带来源与归因]
2. `new` 判定满足任一条件：  
   - `published_at` ≤ 48h  
   - 内容包含强时效线索（如 `today/just/breaking/minutes ago` 等）  
   - 市场 24h 变化显著（建议阈值：≥ 8%，且阈值可配置）  
   [Source: prd/appendices/evidence-builder.md#E5. priced-in vs new（Week 1 规则）]
3. `priced` 判定满足任一条件：  
   - 同一事实 ≥ 3 个来源重复转述（基于去重聚合结果）  
   - `published_at` > 72h 且市场 24h 相对稳定（变化 < 阈值）  
   [Source: prd/appendices/evidence-builder.md#E5. priced-in vs new（Week 1 规则）]
4. 市场 24h 变化使用 `price_context.signals.change_24h`（由 Pricing 计算），并确保阈值配置化。  
   [Source: architecture/architecture-core.md#3.2 核心数据结构（内部标准化 DTO）]  
   [Source: architecture/providers/polymarket-pricing.md#J.4 领域模型映射（Pricing → 内部 DTO）]  
   [Source: prd/appendices/evidence-builder.md#E5. priced-in vs new（Week 1 规则）]
5. 无法满足 `new` 或 `priced` 判定条件时，`novelty` 必须为 `unknown`。  
   [Source: architecture/coding-standards.md#5.2 证据（Evidence）必须带来源与归因]

## Tasks / Subtasks
- [ ] Task 1：在 EvidenceBuilder 中实现 novelty 标注规则（AC: 1-5）  
  [Source: prd/appendices/evidence-builder.md#E5. priced-in vs new（Week 1 规则）]
  - [ ] Subtask 1.1：根据 `published_at` 与时效关键词判定 `new`
  - [ ] Subtask 1.2：结合去重聚合的重复转述数量判定 `priced`
  - [ ] Subtask 1.3：基于 `price_context.signals.change_24h` 与阈值判定 `new/priced`
  - [ ] Subtask 1.4：无判定时设置 `unknown`
- [ ] Task 2：落地 novelty 阈值配置与校验（AC: 2-4）  
  [Source: architecture/coding-standards.md#7.1 配置加载与校验（启动期失败）]
  - [ ] Subtask 2.1：在 `config.defaults.ts` 与 `config.schema.ts` 中补齐阈值默认值与校验
- [ ] Task 3：补充 novelty 标注测试覆盖（AC: 1-5）  
  [Source: architecture/tech-stack.md#9) 测试策略]  
  [Source: architecture/coding-standards.md#11.3 单元测试范围（必须覆盖“各种情况”)]  
  [Source: architecture/coding-standards.md#11.8 可重复性（Determinism）要求]
  - [ ] Subtask 3.1：单测覆盖 48h/72h 边界与时效关键词判定
  - [ ] Subtask 3.2：单测覆盖重复转述 ≥3 与价格稳定/波动阈值判定
  - [ ] Subtask 3.3：单测覆盖 `unknown` 默认路径

## Dev Notes
### Previous Story Insights
No specific guidance found in architecture docs.  
[Source: architecture/architecture-core.md]

### Data Models
- `EvidenceCandidate` 含 `novelty` 字段（new/priced/unknown）。  
  [Source: architecture/coding-standards.md#5.2 证据（Evidence）必须带来源与归因]
- `PriceContext.signals.change_24h` 提供 24h 变化信号。  
  [Source: architecture/architecture-core.md#3.2 核心数据结构（内部标准化 DTO）]  
  [Source: architecture/providers/polymarket-pricing.md#J.4 领域模型映射（Pricing → 内部 DTO）]

### API Specifications
- EvidenceBuilder 位于 Tavily 检索之后，产出 evidence_candidates 供后续步骤使用。  
  [Source: architecture/architecture-core.md#4.1 主流程（单事件）]

### Component Specifications
- Pricing 信号用途为 priced-in vs new 的补充输入，不作为单独事实来源。  
  [Source: architecture/providers/polymarket-pricing.md#J.1 用途与职责边界]
- Step 文件命名与顺序编排仅在 `pipeline.ts` 声明；Step 需实现统一接口（`id`/`run`/`requires`/`produces`）。  
  [Source: architecture/coding-standards.md#2.1 Step 文件命名与顺序编排]  
  [Source: architecture/coding-standards.md#2.2 Step 统一接口（强约束）]

### File Locations
建议按现有结构实现/修改下列位置：  
- `src/orchestrator/steps/evidence.build.step.ts`（EvidenceBuilder step）  
- `src/orchestrator/types.ts`（EvidenceCandidate DTO）  
- `src/config/defaults.ts`、`src/config/config.schema.ts`（阈值默认值与校验）  
- `src/storage/sqlite/evidence.repo.ts`（Evidence 表落地）  
[Source: architecture/source-tree.md#1) 源码目录结构（AI Signal Bot）]

### Testing Requirements
- 单元测试需覆盖 novelty 判定与边界情况。  
  [Source: architecture/tech-stack.md#9) 测试策略]  
  [Source: architecture/coding-standards.md#11.3 单元测试范围（必须覆盖“各种情况”）]
- 测试需保证可重复性（固定时间/随机）。  
  [Source: architecture/coding-standards.md#11.8 可重复性（Determinism）要求]

### Technical Constraints
- Node.js 18+/20、TypeScript strict、ESM 模块制式。  
  [Source: architecture/tech-stack.md#2) 语言与运行时]

### Project Structure Notes
- `docs/architecture/unified-project-structure.md` 未找到；使用 `docs/architecture/source-tree.md` 作为目录结构依据。  
  [Source: architecture/source-tree.md#1) 源码目录结构（AI Signal Bot）]
- `docs/architecture/testing-strategy.md` 未找到；使用 `tech-stack.md` 与 `coding-standards.md` 中测试策略说明。  
  [Source: architecture/tech-stack.md#9) 测试策略]  
  [Source: architecture/coding-standards.md#11.3 单元测试范围（必须覆盖“各种情况”）]

## Change Log
| Date       | Version | Description | Author |
| ---------- | ------- | ----------- | ------ |
| 2026-01-26 | 0.1     | 创建故事草稿 | Bob    |
| 2026-01-26 | 0.2     | 提升为 Approved | Bob    |

## Dev Agent Record
### Agent Model Used
- TBD

### Debug Log References
- TBD

### Completion Notes List
- TBD

### File List
- TBD

## QA Results
