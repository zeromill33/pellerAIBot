# Story 7.1: Event/Evidence/Report 三表落地

## Status
Draft

## Story
**作为** 系统（StorageAdapter），  
**我希望** 将 Event/Evidence/Report 三表落地并在验证后写入，  
**以便** 报告可回溯、可审计，并支持后续运营回查与发布。

Epic Context: 对应 Epic 7「数据落地与运营校验」的 E7-S1。  
[Source: prd/epic-plan.md#Epic 7：数据落地与运营校验]

Dependencies: 依赖 Report v1 生成与 Validator 结果，且在发布前必须落地三表。  
[Source: prd/prd-core.md#P0 必交付]  
[Source: architecture/architecture-core.md#4.1 主流程（单事件）]

## Acceptance Criteria
1. 在 Validator 通过后，必须写入 Event/Evidence/Report 三表（发布前已落地）。  
   [Source: prd/prd-core.md#P0 必交付]  
   [Source: architecture/architecture-core.md#4.1 主流程（单事件）]
2. 三表字段必须对齐 PRD 附录 H 字段字典（Event/Evidence/Report）。  
   [Source: prd/appendices/notion-sheet-fields.md#附录 H：Notion/Sheet 字段字典（三表）]
3. StorageAdapter 支持 Week 1 SQLite 落地，Notion/Sheet 作为可选异步导出，不作为真相源。  
   [Source: architecture/providers/storage.md#F.1 Week 1 推荐：SQLite（本地）]  
   [Source: architecture/providers/storage.md#F.2 预留：Google Sheets / Notion（可选）]
4. Report 保存时必须记录 `status`（ready/blocked/published）与 `validator_code/message`（若失败）。  
   [Source: architecture/architecture-core.md#7.2 数据表（SQLite 逻辑模型）]
5. Evidence 落地需保留 `source_type/url/domain/published_at/claim/stance/novelty/repeated/strength` 等追溯字段。  
   [Source: prd/appendices/notion-sheet-fields.md#H2. Evidence 表字段]

## Tasks / Subtasks
- [ ] Task 1：实现 StorageAdapter 三表写入（AC: 1-5）  
  [Source: architecture/providers/storage.md#F.1 Week 1 推荐：SQLite（本地）]
  - [ ] Subtask 1.1：在 `src/storage/sqlite/event.repo.ts` upsert Event 字段
  - [ ] Subtask 1.2：在 `src/storage/sqlite/evidence.repo.ts` 批量写入 Evidence 字段
  - [ ] Subtask 1.3：在 `src/storage/sqlite/report.repo.ts` 保存 Report（含 status/validator_code/message）
- [ ] Task 2：在 pipeline 中落地存储步骤（AC: 1,4）  
  [Source: architecture/source-tree.md#1) 源码目录结构（AI Signal Bot）]
  - [ ] Subtask 2.1：在 `src/orchestrator/steps/persist.step.ts` 调用 StorageAdapter 保存三表
  - [ ] Subtask 2.2：Validator 失败时也落地报告（status=blocked + reason）
- [ ] Task 3：补充存储落地测试（AC: 1-5）  
  [Source: architecture/tech-stack.md#9) 测试策略]
  - [ ] Subtask 3.1：使用 sqlite test db 验证三表写入与字段映射
  - [ ] Subtask 3.2：覆盖 validator 失败与 success 的落地路径

## Dev Notes
### Previous Story Insights
No specific guidance found in architecture docs.  
[Source: architecture/architecture-core.md]

### Data Models
- Event/Evidence/Report 字段字典见 PRD 附录 H。  
  [Source: prd/appendices/notion-sheet-fields.md#附录 H：Notion/Sheet 字段字典（三表）]
- SQLite 逻辑模型包含 Event/Evidence/Report 与 status/validator 字段。  
  [Source: architecture/architecture-core.md#7.2 数据表（SQLite 逻辑模型）]

### API Specifications
- StorageAdapter：`upsertEvent` / `appendEvidence` / `saveReport`（Week 1 SQLite）。  
  [Source: architecture/source-tree.md#1) 源码目录结构（AI Signal Bot）]

### Component Specifications
- SQLite 为真相源；Notion/Sheet 仅作为可视化导出。  
  [Source: architecture/providers/storage.md#F.2 预留：Google Sheets / Notion（可选）]

### File Locations
- `src/storage/sqlite/event.repo.ts` / `evidence.repo.ts` / `report.repo.ts`：三表落地。  
  [Source: architecture/source-tree.md#1) 源码目录结构（AI Signal Bot）]
- `src/orchestrator/steps/persist.step.ts`：落地步骤入口。  
  [Source: architecture/source-tree.md#1) 源码目录结构（AI Signal Bot）]

### Testing Requirements
- 参考单元/集成测试策略。  
  [Source: architecture/tech-stack.md#9) 测试策略]

### Technical Constraints
- 发布前必须落地；失败也应记录以便复盘。  
  [Source: prd/prd-core.md#P0 必交付]

### Project Structure Notes
- `docs/architecture/unified-project-structure.md` 未找到；使用 `docs/architecture/source-tree.md` 作为目录结构依据。  
  [Source: architecture/source-tree.md#1) 源码目录结构（AI Signal Bot）]

## Change Log
| Date       | Version | Description | Author |
| ---------- | ------- | ----------- | ------ |
| 2026-01-27 | 0.1     | 创建故事草稿 | Bob    |

## Dev Agent Record
### Agent Model Used

### Debug Log References

### Completion Notes List

### File List

## QA Results
