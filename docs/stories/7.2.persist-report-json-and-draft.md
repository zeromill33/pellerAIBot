# Story 7.2: 保存 report_json 与渲染文案草稿并记录状态

## Status
Done

## Story
**作为** 系统（Renderer/StorageAdapter），  
**我希望** 在 Validator 通过后保存 Report v1 JSON 与渲染后的 TG 文案草稿，并记录状态，  
**以便** 后续发布与运营审核可用。

Epic Context: 对应 Epic 7「数据落地与运营校验」的 E7-S2。  
[Source: prd/epic-plan.md#Epic 7：数据落地与运营校验]

Dependencies: 依赖 E7-S1（三表落地）与 Report v1 生成/校验完成。  
[Source: prd/epic-plan.md#Epic 7：数据落地与运营校验]  
[Source: architecture/architecture-core.md#4.1 主流程（单事件）]

## Acceptance Criteria
1. Validator 通过后必须保存 `report_json`（完整 Report v1 JSON）与 `tg_post_text`（渲染文案）。  
   [Source: prd/appendices/notion-sheet-fields.md#H3. Report 表字段]  
   [Source: architecture/architecture-core.md#6.1 Renderer（从 JSON 到 TG 文案）]
2. Renderer 必须基于模板进行字符串渲染，保持结构层级与标题编号；不得由 LLM 直接产出 TG 文本。  
   [Source: architecture/architecture-core.md#6.1 Renderer（从 JSON 到 TG 文案）]
3. 当 `resolution_rules_raw` 过长时，渲染文案需截断并提示“以市场页原文为准”。  
   [Source: architecture/architecture-core.md#6.1 Renderer（从 JSON 到 TG 文案）]
4. Report 存储应包含 `status` 字段（ready/blocked/published），初次通过应为 `ready`。  
   [Source: architecture/architecture-core.md#7.2 数据表（SQLite 逻辑模型）]  
   [Source: prd/appendices/notion-sheet-fields.md#H3. Report 表字段]

## Tasks / Subtasks
- [x] Task 1：渲染 TG 文案并保存 report_json/tg_post_text（AC: 1-4）  
  [Source: architecture/architecture-core.md#6.1 Renderer（从 JSON 到 TG 文案）]
  - [x] Subtask 1.1：在 `src/renderer/index.ts` 使用模板渲染 Report v1 JSON
  - [x] Subtask 1.2：对 `resolution_rules_raw` 进行长度截断并提示原文来源
  - [x] Subtask 1.3：在 `src/storage/sqlite/report.repo.ts` 保存 `report_json` 与 `tg_post_text`
- [x] Task 2：在 pipeline 中落地渲染与存储步骤（AC: 1-4）  
  [Source: architecture/source-tree.md#1) 源码目录结构（AI Signal Bot）]
  - [x] Subtask 2.1：在 `src/orchestrator/steps/telegram.render.step.ts` 调用 Renderer
  - [x] Subtask 2.2：在 `persist.step.ts`/存储层记录 `status=ready` 与渲染文案
- [x] Task 3：补充渲染与落地测试（AC: 1-4）  
  [Source: architecture/tech-stack.md#9) 测试策略]
  - [x] Subtask 3.1：验证渲染模板输出稳定（可 snapshot）
  - [x] Subtask 3.2：覆盖 `resolution_rules_raw` 超长截断场景

## Dev Notes
### Previous Story Insights
No specific guidance found in architecture docs.  
[Source: architecture/architecture-core.md]

### Data Models
- Report 表字段包含 `report_json` 与 `tg_post_text`。  
  [Source: prd/appendices/notion-sheet-fields.md#H3. Report 表字段]

### API Specifications
- Renderer：JSON → TG Markdown 文案（模板渲染）。  
  [Source: architecture/architecture-core.md#6.1 Renderer（从 JSON 到 TG 文案）]

### Component Specifications
- Renderer 只做模板渲染，不调用 LLM。  
  [Source: architecture/architecture-core.md#6.1 Renderer（从 JSON 到 TG 文案）]
- 渲染输出需保留结构层级与标题编号。  
  [Source: architecture/architecture-core.md#6.1 Renderer（从 JSON 到 TG 文案）]

### File Locations
- `src/renderer/templates/telegram.md.txt`：TG 渲染模板。  
  [Source: architecture/source-tree.md#1) 源码目录结构（AI Signal Bot）]
- `src/renderer/index.ts`：渲染入口。  
  [Source: architecture/source-tree.md#1) 源码目录结构（AI Signal Bot）]
- `src/orchestrator/steps/telegram.render.step.ts`：渲染 step。  
  [Source: architecture/source-tree.md#1) 源码目录结构（AI Signal Bot）]
- `src/storage/sqlite/report.repo.ts`：Report 落地含 `report_json`/`tg_post_text`。  
  [Source: architecture/source-tree.md#1) 源码目录结构（AI Signal Bot）]

### Testing Requirements
- 渲染输出可做 snapshot 测试，保证稳定性。  
  [Source: architecture/coding-standards.md#11.8 可重复性（Determinism）要求]

### Technical Constraints
- `status` 必须准确（ready/blocked/published）。  
  [Source: architecture/architecture-core.md#7.2 数据表（SQLite 逻辑模型）]

### Project Structure Notes
- `docs/architecture/unified-project-structure.md` 未找到；使用 `docs/architecture/source-tree.md` 作为目录结构依据。  
  [Source: architecture/source-tree.md#1) 源码目录结构（AI Signal Bot）]
- `docs/architecture/testing-strategy.md` 未找到；测试策略参考 `tech-stack.md` 与 `coding-standards.md`。  
  [Source: architecture/tech-stack.md#9) 测试策略]

## Change Log
| Date       | Version | Description | Author |
| ---------- | ------- | ----------- | ------ |
| 2026-01-27 | 0.1     | 创建故事草稿 | Bob    |

## Dev Agent Record
### Agent Model Used
GPT-5 (Codex CLI)

### Debug Log References
- npm test

### Completion Notes List
- 实现 Renderer 模板渲染与规则截断提示。
- Pipeline 增加 telegram.render step，persist 时保存 tg_post_text。
- 增加渲染 snapshot 与截断测试。

### File List
- src/renderer/index.ts
- src/renderer/templates/telegram.md.txt
- src/orchestrator/steps/telegram.render.step.ts
- src/orchestrator/pipeline.ts
- src/orchestrator/errors.ts
- tests/renderer/telegram-render.test.ts
- tests/renderer/__snapshots__/telegram-render.test.ts.snap

## QA Results
