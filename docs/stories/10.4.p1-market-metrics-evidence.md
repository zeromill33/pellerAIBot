# Story 10.4: P1 市场行为证据化（Market Metrics）

## Status
Ready for Review

## Story
**作为** 系统（Evidence/LLM 输入管道），  
**我希望** 将市场行为指标转化为可审计的 evidence 条目，  
**以便** 报告不再仅以市场链接充当证据、并提供可量化的市场信号。

Epic Context: Epic 10「报告质量优化（P0/P1）」的 P1 市场行为证据化。  
[Source: architecture/report_quality_P0_P1_implementation.md#P1-2 “市场行为”证据结构化：Market Metrics]

Dependencies: 依赖 MarketContext/ClobSnapshot/PriceContext 已可用。  
[Source: architecture/architecture-core.md#3.2 核心数据结构（内部标准化 DTO）]

## Acceptance Criteria
1. Report v1 JSON 的 `disagreement_map` 中必须至少包含 1 条 `source_type="市场行为"` 的 evidenceItem，且 claim 中包含可引用的数值指标（如 24h 价格变化、spread、墙等），不再仅贴市场链接。  
   [Source: architecture/report_quality_P0_P1_implementation.md#P1-2 “市场行为”证据结构化：Market Metrics]
2. 用代码侧派生的市场指标（`price_context.signals`、`clob_snapshot`）生成 `market_metrics_summary` 并作为 LLM 输入，确保指标与采集数据一致。  
   [Source: architecture/report_quality_P0_P1_implementation.md#P1-2 “市场行为”证据结构化：Market Metrics]
3. 若市场指标不可用（如价格历史缺失），LLM 输出必须降级为“指标不可用原因说明”或跳过该 evidence，不得输出虚构数值。  
   [Source: architecture/coding-standards.md#4.3 反幻觉策略（必须落地）]
4. 为市场行为证据化补充单元测试，覆盖指标可用/不可用/边界值分支。  
   [Source: architecture/coding-standards.md#11.3 单元测试范围（必须覆盖“各种情况”)]

## Tasks / Subtasks
- [x] Task 1：构建 `market_metrics_summary` 并注入 LLM 输入（AC: 1, 2, 3）  
  [Source: architecture/source-tree.md#1) 源码目录结构（AI Signal Bot）]
  - [x] Subtask 1.1：在 `src/orchestrator/steps/report.generate.step.ts` 构建 `market_metrics_summary`（来自 `price_context.signals` 与 `clob_snapshot`）
  - [x] Subtask 1.2：更新 `prompts/report_v1_generate.prompt.txt`，要求输出至少 1 条 `source_type="市场行为"` evidenceItem，并引用上述指标
  - [x] Subtask 1.3：指标缺失时输出“不可用原因”或跳过该 evidence，不输出虚构数值
- [x] Task 2：必要时补充字段/DTO（AC: 2）  
  [Source: architecture/report_quality_P0_P1_implementation.md#P1-2 “市场行为”证据结构化：Market Metrics]
  - [x] Subtask 2.1：若需要新增 `market_metrics_summary` 类型，更新 `src/providers/llm/types.ts` 的 LLM 输入结构
- [x] Task 3：测试覆盖（AC: 4）  
  [Source: architecture/coding-standards.md#11.3 单元测试范围（必须覆盖“各种情况”)]
  - [x] Subtask 3.1：覆盖 market evidence 生成成功/降级/缺失数据分支

## Dev Notes
### Previous Story Insights
当前最高 story 10.3 为 Draft（非 Done），存在流程风险但不阻断本条起草。  
[Source: architecture/architecture-core.md#4.1 主流程（单事件）]

### Data Models
- `ClobSnapshot` 含 spread/midpoint/book_top_levels/notable_walls。  
  [Source: architecture/architecture-core.md#3.2 核心数据结构（内部标准化 DTO）]
- `PriceContext.signals` 提供 change_1h/change_4h/change_24h 等。  
  [Source: architecture/architecture-core.md#3.2 核心数据结构（内部标准化 DTO）]

### API Specifications
- `report.generate.step.ts` 负责组装 LLM 输入；新增 `market_metrics_summary` 应在此处注入。  
  [Source: architecture/source-tree.md#1) 源码目录结构（AI Signal Bot）]

### Component Specifications
- Evidence 需带 `source_type/url/domain/published_at/claim/stance/novelty` 等字段，新增字段需保持向后兼容。  
  [Source: architecture/coding-standards.md#5.2 证据（Evidence）必须带来源与归因]

### File Locations
- `src/orchestrator/steps/evidence.build.step.ts`：Evidence 生成与归一化。  
  [Source: architecture/source-tree.md#1) 源码目录结构（AI Signal Bot）]
- `src/orchestrator/types.ts`：EvidenceCandidate/MarketSignal DTO。  
  [Source: architecture/source-tree.md#1) 源码目录结构（AI Signal Bot）]

### Project Structure Notes
未找到 `docs/architecture/unified-project-structure.md` 与 `docs/architecture/testing-strategy.md`，本 story 以 `source-tree.md` 与 `coding-standards.md` 为结构/测试依据。  
[Source: architecture/source-tree.md#1) 源码目录结构（AI Signal Bot）]  
[Source: architecture/coding-standards.md#11. 测试与质量门禁（必须更严格：build 通过 + 单测覆盖 + 外部依赖集成测试）]

### Testing Requirements
- 单元测试必须覆盖分支/边界/错误路径，建议表驱动用例。  
  [Source: architecture/coding-standards.md#11.3 单元测试范围（必须覆盖“各种情况”)]
- 测试需可重复，避免依赖外网。  
  [Source: architecture/coding-standards.md#11.8 可重复性（Determinism）要求]

## Change Log
| Date       | Version | Description | Author |
| ---------- | ------- | ----------- | ------ |
| 2026-01-30 | v0.1    | 初稿（P1 市场行为证据化） | Bob (SM) |
| 2026-01-30 | v0.2    | 注入 market_metrics_summary 与测试覆盖 | James (Dev) |

## Dev Agent Record
### Agent Model Used
GPT-5 (Codex CLI)

### Debug Log References
无

### Completion Notes List
- 构建 market_metrics_summary（price signals + clob metrics）并注入 LLM 输入。
- 更新报告 prompt，强制至少 1 条“市场行为”证据并说明不可用原因。
- 增补 report.generate 与 LLM provider 测试覆盖可用/不可用分支。

### File List
- src/orchestrator/steps/report.generate.step.ts
- src/providers/llm/types.ts
- src/providers/llm/index.ts
- prompts/report_v1_generate.prompt.txt
- tests/orchestrator/report-generate.step.test.ts
- tests/providers/llm/provider.test.ts

## QA Results
