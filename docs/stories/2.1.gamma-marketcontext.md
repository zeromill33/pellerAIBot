# Story 2.1: Gamma 拉取事件与市场元数据并映射为 MarketContext

## Status
Approved

## Story
**作为** 系统（Pipeline），  
**我希望** 能从 Polymarket Gamma API 按 slug 拉取事件与市场元数据并映射为标准化的 `MarketContext`，  
**以便** 为后续订单簿拉取、证据构建与报告生成提供稳定输入。

Dependencies: E1-S1 多链接输入解析与 slug 提取。

## Acceptance Criteria
1. 通过 Gamma API 按 `slug` 精确获取事件信息，并在内部映射为 `MarketContext`。
2. 能通过 `event_id` 拉取关联 markets，并选择合适的主 market（默认交易量最高或运营指定）。
3. `MarketContext` 至少包含：title/description/resolution_rules_raw/end_time/outcomePrices/clobTokenIds 等关键字段。
4. 对 Gamma API 的限流/重试按规范处理（429/5xx/网络错误），并使用缓存避免重复调用。
5. 当 `/events` 返回 0 条或多于 1 条时，需返回结构化错误并中止该事件流程。
6. 当 `/markets` 返回空数组或缺少必要字段时，需返回结构化错误并中止该事件流程。

## Tasks / Subtasks
- [ ] 实现或完善 `MarketProvider.getEventBySlug(slug)`，拉取 `/events` 并校验唯一性（AC: 1）  
  - [ ] 使用 `GET /events?slug=...&limit=1`  
  - [ ] 将事件字段映射为 `MarketContext`（基础字段）  
  - [ ] 处理 0 条或多条结果的错误返回  
  [Source: architecture/providers/polymarket-gamma.md#A.3 关键端点（本 MVP 会用到）]  
  [Source: architecture/providers/polymarket-gamma.md#A.4 领域模型映射（Gamma → 内部 DTO）]
- [ ] 实现或完善 `listMarketsByEvent(eventId)`，拉取 `/markets?event_id=...` 并选择主 market（AC: 2, 3）  
  - [ ] 默认选交易量最高或按运营指定 market/token  
  - [ ] 提取 `outcomePrices`、`clobTokenIds` 等字段  
  - [ ] 当返回为空或字段缺失时返回结构化错误  
  [Source: architecture/providers/polymarket-gamma.md#A.3 关键端点（本 MVP 会用到）]  
  [Source: architecture/providers/polymarket-gamma.md#A.4 领域模型映射（Gamma → 内部 DTO）]
- [ ] 按 Provider 通用规范实现超时、重试、退避与缓存（AC: 4）  
  - [ ] 仅对 `429/5xx/网络错误` 重试，最多 3 次  
  - [ ] 事件元数据缓存 TTL=6h、markets 缓存 TTL=10m（可配置）  
  [Source: architecture/providers/provider-guidelines.md#I.1 统一的 HTTP Client 封装]  
  [Source: architecture/providers/provider-guidelines.md#I.2 缓存与去重]  
  [Source: architecture/providers/polymarket-gamma.md#A.7 建议的缓存 Key]
- [ ] 补充 Provider 级单测/集成测试（200/429/字段缺失）与 fixture（AC: 4）  
  [Source: architecture/providers/provider-guidelines.md#I.3 Mock 与集成测试]  
  [Source: architecture/coding-standards.md#11.4 Provider 集成测试（外部依赖：必须有“可回放”测试）]

## Dev Notes
### Previous Story Insights
No specific guidance found in architecture docs.  
[Source: architecture/architecture-core.md]

### Data Models
- `MarketContext` 字段建议：`event_id, slug, title, description, resolution_rules_raw, end_time, markets[]`  
  markets 中包含 `market_id, outcomes, outcomePrices, clobTokenIds, volume, liquidity`。  
  [Source: architecture/providers/polymarket-gamma.md#A.4 领域模型映射（Gamma → 内部 DTO）]

### API Specifications
- Base URL：`https://gamma-api.polymarket.com`（无需 API Key）  
  [Source: architecture/providers/polymarket-gamma.md#A.2 Base URL 与鉴权]
- `GET /events`：按 `slug` 精确查 1 个事件（`limit=1`）  
  [Source: architecture/providers/polymarket-gamma.md#A.3 关键端点（本 MVP 会用到）]
- `GET /markets`：按 `event_id` 拉取关联 markets  
  [Source: architecture/providers/polymarket-gamma.md#A.3 关键端点（本 MVP 会用到）]

### Component Specifications
- Provider 必须包含超时、重试、退避与可观测性打点（provider/endpoint/status/latency/cache_hit）。  
  [Source: architecture/providers/provider-guidelines.md#I.1 统一的 HTTP Client 封装]
- Provider 输出 DTO 必须稳定且最小化，禁止穿透原始响应。  
  [Source: architecture/coding-standards.md#3.5 Provider 输出必须“最小化、稳定化”]

### File Locations
建议按现有结构实现/修改下列位置：  
- `src/providers/polymarket/`（Gamma client/mapper/policy/index）  
- `src/orchestrator/types.ts`（MarketContext DTO 若需扩展）  
[Source: architecture/source-tree.md#1) 源码目录结构（AI Signal Bot）]

### Testing Requirements
- Provider 测试需包含 200/429/字段缺失三类场景，并使用 fixtures + mock。  
  [Source: architecture/providers/provider-guidelines.md#I.3 Mock 与集成测试]  
  [Source: architecture/coding-standards.md#11.5 Provider 必测的“故障注入”场景]

### Technical Constraints
- TypeScript 严格模式、ESM 模块制式，避免使用 `any`。  
  [Source: architecture/tech-stack.md#2) 语言与运行时]
- 外部请求必须设置 timeout，避免无限重试。  
  [Source: architecture/coding-standards.md#3.2 超时 / 重试 / 退避（硬性要求）]

### Project Structure Notes
Provider 实现应位于 `src/providers/polymarket/`，不应被 Orchestrator 以外层级绕过调用。  
[Source: architecture/coding-standards.md#1.2 依赖方向（必须遵守）]  
[Source: architecture/source-tree.md#1) 源码目录结构（AI Signal Bot）]

## Change Log
| Date       | Version | Description | Author |
| ---------- | ------- | ----------- | ------ |
| 2026-01-23 | 0.1     | 创建故事草稿 | Bob |

## Dev Agent Record
### Agent Model Used

### Debug Log References

### Completion Notes List

### File List

## QA Results
