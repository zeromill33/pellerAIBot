# Story 9.5: 端到端 E2E 流水线回归测试（阶段性补齐）

## Status
Review

## Story
**作为** 研发/质量负责人，  
**我希望** 能用真实 Polymarket event URL 运行端到端流水线回归，并看到每个 step 的输入/输出（可配置停在当前实现的最后一步；当前至少覆盖到 liquidity proxy 相关 step），  
**以便** 随着新 story 推进持续补齐覆盖、及时发现链路问题。

Epic Context: 对应 Epic 9「配置、限流与运营文档」的质量与回归保障补充。[Source: prd/epic-plan.md#Epic 9：配置、限流与运营文档]  
Dependencies: 依赖已实现的单事件 pipeline steps（至少覆盖主流程前半段）。

## Acceptance Criteria
1. 提供一条 E2E 回归入口（测试命令或脚本），输入真实 Polymarket event URL，按 `pipeline.ts` 中的 step 顺序执行主流程，可配置停止步（默认当前最后一步）；当前已实现 step 顺序为 `market.fetch` → `market.signals` → `market.orderbook.fetch` → `market.liquidity.proxy`（以 `src/orchestrator/pipeline.ts` 为准），确保后续 story 可继续扩展覆盖范围。  
   [Source: architecture/architecture-core.md#4.1 主流程（单事件）]  
   [Source: src/orchestrator/pipeline.ts]
2. E2E 运行时对每个 step 输出可读的输入/输出摘要（至少包含 step 名称、event_slug、request_id/run_id 与关键字段），便于定位阶段性结果。  
   [Source: architecture/coding-standards.md#2.3 数据项目必须具备：幂等与可回放]  
   [Source: architecture/tech-stack.md#8) 可观测性（Week 1 最小可用）]
3. E2E 默认使用 fake provider/fixtures，不依赖真实外网 API；仅在显式开启 `TEST_LIVE=1` 且具备必要密钥时运行 live 真实链路，且 CI 默认不跑 live。  
   [Source: architecture/coding-standards.md#11.4 Provider 集成测试（外部依赖：必须有“可回放”测试）]  
   [Source: architecture/coding-standards.md#11.9 Flaky 控制（必须）]
4. E2E 不应向真实 TG Channel 发布；需使用 FakePublisher 或 sandbox TG channel，确保回归不会影响线上运营。  
   [Source: architecture/coding-standards.md#11.7 端到端 E2E（最小 smoke，保证“交互闭环”）]  
   [Source: architecture/tech-stack.md#9) 测试策略]
5. 提供 `test:e2e` 或等价测试命令用于本地回归（非默认 CI），并明确其运行前置条件（是否需要 live 模式）。  
   [Source: architecture/coding-standards.md#11.1 CI 质量门禁（PR 必须通过）]
6. Fake 模式 E2E 必须断言闭环结果：`status` 正确、storage 三表落地完整；失败时回执包含 `error_code` 与 `suggestion`。  
   [Source: architecture/coding-standards.md#11.7 端到端 E2E（最小 smoke，保证“交互闭环”）]
7. E2E 必须保证可重复性（固定时间/随机）；涉及 Renderer 输出时使用 snapshot 或等价断言机制。  
   [Source: architecture/coding-standards.md#11.8 可重复性（Determinism）要求]
8. E2E 路径必须实际执行 pipeline steps，不可在测试环境直接短路为 success。  
   [Source: architecture/coding-standards.md#11.7 端到端 E2E（最小 smoke，保证“交互闭环”）]

## Tasks / Subtasks
- [x] Task 1：新增 E2E 回归入口与 step 级别可观测输出（AC: 1, 2, 8）  
  [Source: architecture/architecture-core.md#4.1 主流程（单事件）]  
  [Source: architecture/coding-standards.md#2.1 Step 文件命名与顺序编排]  
  [Source: architecture/tech-stack.md#8) 可观测性（Week 1 最小可用）]
  - [x] Subtask 1.1：从 `pipeline.ts` 读取 step 顺序并支持“停止在指定 step”的配置
  - [x] Subtask 1.2：对每个 step 输出结构化日志（包含 step_id、event_slug、request_id、run_id 与关键字段摘要）
  - [x] Subtask 1.3：确保 E2E 路径执行真实 pipeline steps（不因测试环境短路）  
- [x] Task 2：补齐 E2E 的 fake/live 双模式与断言（AC: 3, 4, 6, 7）  
  [Source: architecture/coding-standards.md#11.4 Provider 集成测试（外部依赖：必须有“可回放”测试）]  
  [Source: architecture/coding-standards.md#11.7 端到端 E2E（最小 smoke，保证“交互闭环”）]  
  [Source: architecture/coding-standards.md#11.8 可重复性（Determinism）要求]
  - [x] Subtask 2.1：默认走 fake provider/fixtures，确保回归不依赖外网与真实 TG
  - [x] Subtask 2.2：仅在 `TEST_LIVE=1` 时启用 live 请求，并明确所需密钥与风险提示
  - [x] Subtask 2.3：固定时间/随机输入，保证 fake 模式可重复性
  - [x] Subtask 2.4：增加 Error Case 测试（如 `market.fetch` 失败），验证 `status: "failed"` 与错误回执字段
- [x] Task 3：补充 E2E 回归测试与运行入口说明（AC: 5）  
  [Source: architecture/coding-standards.md#11.1 CI 质量门禁（PR 必须通过）]
  - [x] Subtask 3.1：新增 `test:e2e`（或等价）本地回归命令
  - [x] Subtask 3.2：记录 live/非 live 的运行前置条件与约束

## Dev Notes
### Previous Story Insights
No specific guidance found in architecture docs.  
[Source: architecture/architecture-core.md]

### Data Models
- 运行链路需贯穿 `request_id`、`run_id`、`event_slug` 以满足回放与追踪要求。  
  [Source: architecture/coding-standards.md#2.3 数据项目必须具备：幂等与可回放]

### API Specifications
- 单事件主流程 step 顺序以 `pipeline.ts` 中的编排为准。  
  [Source: architecture/coding-standards.md#2.1 Step 文件命名与顺序编排]  
  [Source: architecture/source-tree.md#1) 源码目录结构（AI Signal Bot）]
- 主流程步骤定义见 4.1（URL→slug、Gamma/CLOB/Pricing、Tavily、多车道检索、EvidenceBuilder、LLM、Validator、Storage/Renderer/Publisher）。  
  [Source: architecture/architecture-core.md#4.1 主流程（单事件）]

### Component Specifications
- Step 必须使用稳定 `step_id`，并通过 pipeline 编排执行。  
  [Source: architecture/coding-standards.md#2.1 Step 文件命名与顺序编排]  
  [Source: architecture/coding-standards.md#2.2 Step 统一接口（强约束）]
- E2E 需使用 FakePublisher 或 sandbox TG channel，避免影响线上发布。  
  [Source: architecture/coding-standards.md#11.7 端到端 E2E（最小 smoke，保证“交互闭环”）]  
  [Source: architecture/tech-stack.md#9) 测试策略]

### Step 输出摘要格式示例
示例（JSON 行日志，仅示意字段；必须包含结构化日志必备字段，输入/输出体现为 DTO key 摘要，可按实现调整字段名）：  
```json
{
  "service": "orchestrator",
  "step_id": "market.liquidity.proxy",
  "request_id": "req_...",
  "run_id": "run_...",
  "event_slug": "example-slug",
  "input_keys": ["MarketContext", "ClobSnapshot"],
  "output_keys": ["liquidity_proxy"],
  "latency_ms": 123
}
```
[Source: architecture/architecture-core.md#2.1 架构原则]  
[Source: architecture/coding-standards.md#9.1 结构化日志（必须）]

### File Locations
- `src/orchestrator/pipeline.ts`：step 顺序唯一声明处。  
  [Source: architecture/source-tree.md#1) 源码目录结构（AI Signal Bot）]
- `src/orchestrator/steps/`：单步 step 实现与输出。  
  [Source: architecture/source-tree.md#1) 源码目录结构（AI Signal Bot）]
- `src/utils/logger.ts`：结构化日志入口。  
  [Source: architecture/source-tree.md#1) 源码目录结构（AI Signal Bot）]
- `scripts/`：本地运行脚本入口。  
  [Source: architecture/source-tree.md#1) 源码目录结构（AI Signal Bot）]

### Testing
- CI 门禁包含 build/typecheck/lint/unit/integration；`test:e2e` 为建议的本地 smoke。  
  [Source: architecture/coding-standards.md#11.1 CI 质量门禁（PR 必须通过）]
- E2E 需使用 fake providers（不触网）；live contract 仅在 `TEST_LIVE=1` 且具备密钥时启用。  
  [Source: architecture/coding-standards.md#11.4 Provider 集成测试（外部依赖：必须有“可回放”测试）]
- 默认 CI 不跑 live tests，避免 flaky。  
  [Source: architecture/coding-standards.md#11.9 Flaky 控制（必须）]
- E2E 可用 sandbox TG channel（测试 chat_id）。  
  [Source: architecture/tech-stack.md#9) 测试策略]
- Live 模式失败时必须输出结构化日志并包含 `error_code` / `error_category`，以便人工判断与回放定位。  
  [Source: architecture/coding-standards.md#9.1 结构化日志（必须）]

### Technical Constraints
- Node.js 18+/20，TypeScript strict，ESM 模块制式。  
  [Source: architecture/tech-stack.md#2) 语言与运行时]
- PR 不应依赖真实外网 API 才能通过测试。  
  [Source: architecture/coding-standards.md#11.1 CI 质量门禁（PR 必须通过）]

### Project Structure Notes
- `docs/architecture/unified-project-structure.md` 未找到；使用 `docs/architecture/source-tree.md` 作为目录结构依据。
- `docs/architecture/testing-strategy.md` 未找到；使用 `docs/architecture/coding-standards.md` 与 `docs/architecture/tech-stack.md` 中测试策略说明。

## Change Log
| Date       | Version | Description | Author |
| ---------- | ------- | ----------- | ------ |
| 2026-01-24 | 0.1     | 初稿        | Bob    |
| 2026-01-24 | 0.2     | 补充 step 输出摘要格式示例 | Bob    |
| 2026-01-24 | 0.3     | 补充 live 模式失败处理要求 | Bob    |
| 2026-01-24 | 0.4     | 明确当前 pipeline step 覆盖范围与默认 stop_step | Bob    |
| 2026-01-24 | 0.5     | 在 AC 中明确当前已实现 step 覆盖范围 | Bob    |
| 2026-01-24 | 0.6     | 校验修订：更新 AC/任务与来源 | Sarah  |
| 2026-01-24 | 0.7     | 提升为 Approved | Sarah  |
| 2026-01-24 | 0.8     | 实现 E2E 回归入口与测试 | James |
| 2026-01-24 | 0.9     | 增加 E2E 批量运行脚本与 live 超时调整 | James |
| 2026-01-24 | 1.0     | 修正 Pricing API 调用与 live E2E 探测策略 | James |
| 2026-01-24 | 1.1     | 修正 E2E pricing fixture 以匹配 `/price` 端点 | James |
| 2026-01-24 | 1.2     | E2E 输出步骤关键成果摘要 | James |
| 2026-01-24 | 1.3     | 调整 E2E 步骤摘要默认输出路径 | James |

## Dev Agent Record
### Agent Model Used
- GPT-5

### Debug Log References
 - `npm test`
 - `npm test -- tests/providers/polymarket/pricing.test.ts`
 - `RUN_E2E=1 npm test -- tests/e2e/publish-pipeline.e2e.test.ts`
 - `npm run test:e2e`
 - `npm run build`
 - `bash scripts/run-e2e.sh --live`

### Completion Notes List
 - 新增 pipeline step 编排与日志记录的 E2E 运行入口，支持 stop_step 与结构化日志输出。
 - 补齐 fake/live provider 运行分支与错误路径覆盖，保证回归可重复。
 - 新增 `test:e2e` 命令并记录运行前置条件说明。
 - 新增 E2E 批量运行脚本，支持多个 URL 与可选 live 模式。
 - 修正 Pricing API 调用路径与参数：`/price` + `side`，`/prices-history` 使用 `market` 参数。
 - live E2E 降低 market.signals 探测数量，避免超时。
 - E2E pricing fixture 兼容 `/price` 端点，避免 fake 模式出现 404。
 - E2E 输出每步关键成果到控制台，并写入 `tests/e2s/tmp/e2e-step-summary.json`（可用 `E2E_SUMMARY_PATH` 覆盖）。

### File List
 - .gitignore
 - src/orchestrator/pipeline.ts
 - src/orchestrator/steps/market.signals.fetch.step.ts
 - src/providers/polymarket/pricing.ts
 - tests/providers/polymarket/pricing.test.ts
 - tests/e2e/publish-pipeline.e2e.test.ts
 - package.json
 - scripts/run-e2e.sh

## QA Results
