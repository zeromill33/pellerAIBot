# Story 1.3: 失败原因结构化回执

## Status
Done

## Story
**As a** 运营人员，
**I want** 当单条事件失败时获得结构化且可读的失败原因与可重试提示，
**so that** 我能快速判断是否重试、补搜或放弃。

Epic Context: 对应 Epic 1「运营触发与流程编排」的 E1-S3；本故事将 pipeline/validator 的失败信息统一为结构化回执返回给 Bot。[Source: prd/epic-plan.md#Epic 1：运营触发与流程编排] [Source: architecture/architecture-core.md#4.2 多事件批处理]
Dependencies: 1.2 批处理编排与逐条结果汇总。

## Acceptance Criteria
1. 当单条事件失败时，返回结构化错误回执，至少包含 code/message/category/retryable 字段，可选 details 与 suggestion。[Source: architecture/coding-standards.md#6.1 统一 AppError]
2. Validator 失败时，回执包含 validator code/message 与建议动作（如补搜 C 车道或启用 D 车道）。[Source: architecture/architecture-core.md#5.1 两层校验] [Source: architecture/architecture-core.md#4.3 “补搜”策略（节省额度 + 提升通过率）]
3. Bot 回执可读且保持一致格式（成功/失败列表中失败项字段一致）。[Source: architecture/architecture-core.md#4.2 多事件批处理]
4. 结构化错误在日志中被完整记录（包含 request_id/run_id/event_slug）。[Source: architecture/coding-standards.md#9.1 结构化日志（必须）]

## Tasks / Subtasks
- [x] Task 1：定义结构化错误与回执格式（AC: 1, 3）[Source: architecture/coding-standards.md#6.1 统一 AppError] [Source: architecture/architecture-core.md#4.2 多事件批处理]
  - [x] Subtask 1.1：在 `src/orchestrator/types.ts` 定义 ErrorReceipt DTO（含 suggestion）
  - [x] Subtask 1.2：在 `src/orchestrator/errors.ts` 统一错误码映射到 ErrorReceipt
- [x] Task 2：将 validator 失败转换为可操作建议（AC: 2）[Source: architecture/architecture-core.md#5.1 两层校验] [Source: architecture/architecture-core.md#4.2 “补搜”策略]
  - [x] Subtask 2.1：从 validator 返回中提取 suggestion.action/preferred_lane
  - [x] Subtask 2.2：确保 bot 回执在失败项中展示“可重试/补搜”提示
- [x] Task 3：确保日志字段齐全（AC: 4）[Source: architecture/coding-standards.md#9.1 结构化日志（必须）]
  - [x] Subtask 3.1：记录 request_id/run_id/event_slug 与 error_code/error_category
- [x] Task 4：补充测试用例（AC: 1-4）[Source: architecture/coding-standards.md#11 测试与质量门禁（必须更严格：build 通过 + 单测覆盖 + 外部依赖集成测试）]
  - [x] Subtask 4.1：单元测试覆盖 validator 失败与非 validator 失败的回执格式
  - [x] Subtask 4.2：集成测试覆盖 /publish 批处理失败回执字段一致性

## Dev Notes
### Previous Story Insights
- 1.2 引入批处理汇总回执；本故事需保证失败项字段一致性与可操作建议。

### Data Models
- 结构化错误需遵循 AppError 最小字段定义，并可选 details/suggestion。[Source: architecture/coding-standards.md#6.1 统一 AppError]
- 日志需包含 request_id/run_id/event_slug 以支持回放与定位。[Source: architecture/coding-standards.md#2.3 数据项目必须具备：幂等与可回放] [Source: architecture/coding-standards.md#9.1 结构化日志（必须）]

### API Specifications
- Validator 返回 schema 校验 + 内容闸门结果；失败时需转换为可读回执。[Source: architecture/architecture-core.md#5.1 两层校验]
- 补搜建议来自 validator 或 pipeline 策略，需出现在回执中。[Source: architecture/architecture-core.md#4.3 “补搜”策略（节省额度 + 提升通过率）]

### Component Specifications
- 错误标准化与回执拼装应在 orchestrator 层完成，entry 层仅负责输出。[Source: architecture/coding-standards.md#1.1 分层定义（本项目版）]
- 错误码命名需遵循前缀规则（BOT_/ORCH_/STEP_/VALIDATOR_）。[Source: architecture/coding-standards.md#6.2 错误码命名规范]

### File Locations
- `src/orchestrator/types.ts`：ErrorReceipt DTO。[Source: architecture/source-tree.md#1) 源码目录结构（AI Signal Bot）]
- `src/orchestrator/errors.ts`：错误码与错误映射。[Source: architecture/source-tree.md#1) 源码目录结构（AI Signal Bot）]
- `src/validator/index.ts`：validator 结果结构。[Source: architecture/source-tree.md#1) 源码目录结构（AI Signal Bot）]
- `src/bot/commands/publish.ts`：失败回执输出。[Source: architecture/source-tree.md#1) 源码目录结构（AI Signal Bot）]

### Testing
- 需满足 build/typecheck/lint/unit/integration 的 CI 门禁；禁止依赖真实外网 API。[Source: architecture/coding-standards.md#11.1 CI 质量门禁（PR 必须通过）]
- 单元测试需覆盖错误路径；集成测试使用 mock/replay。[Source: architecture/coding-standards.md#11.3 单元测试范围（必须覆盖“各种情况”)] [Source: architecture/coding-standards.md#11.4 Provider 集成测试（外部依赖：必须有“可回放”测试）]
- 测试框架建议使用 `vitest`（或 `jest`）；按仓库实际依赖确定。[Source: architecture/tech-stack.md#13) 技术选型清单（Week 1 建议落地版本）]
- 录制响应与集成测试 fixtures 位置建议使用 `fixtures/`。[Source: architecture/source-tree.md#1) 源码目录结构（AI Signal Bot）]

### Technical Constraints
- 运行时 Node.js 18+/20，TypeScript strict，ESM 模块制式。[Source: architecture/tech-stack.md#2) 语言与运行时]
- 错误需统一为 AppError，并按约定前缀命名错误码。[Source: architecture/coding-standards.md#6.1 统一 AppError] [Source: architecture/coding-standards.md#6.2 错误码命名规范]

### Project Structure Notes
- `docs/architecture/unified-project-structure.md` 未找到；使用 `docs/architecture/source-tree.md` 作为目录结构依据。
- `docs/architecture/testing-strategy.md` 未找到；使用 `docs/architecture/coding-standards.md` 中测试门禁作为依据。

## Change Log
| Date       | Version | Description | Author |
| ---------- | ------- | ----------- | ------ |
| 2026-01-23 | 0.1     | 初稿        | Bob    |
| 2026-01-23 | 0.2     | 实现结构化错误回执与测试补齐 | James |

## Dev Agent Record
### Agent Model Used
GPT-5 (Codex CLI)

### Debug Log References
N/A

### Completion Notes List
- 已统一回执错误为 ErrorReceipt，支持 suggestion 输出（含 validator 建议）。
- 已补齐单元/集成测试并通过 `npm test`。
- 已通过 `npm run build`。

### File List
- src/orchestrator/errors.ts
- src/orchestrator/types.ts
- src/bot/commands/publish.ts
- tests/publish-receipt.test.ts
- tests/publish-failure.integration.test.ts

## QA Results

### 评审日期: 2026-01-23

### 评审人: Quinn (Test Architect)

### 代码质量评估
实现聚焦且结构清晰，结构化回执与建议透传逻辑符合分层约束，测试补充覆盖关键失败场景。

### Refactoring Performed
无。

### Compliance Check
- Coding Standards: ✓（符合错误结构与分层要求）
- Project Structure: ✓（orchestrator/bot 边界清晰）
- Testing Strategy: ✓（新增单元+集成测试）
- All ACs Met: ✓

### Improvements Checklist
- [x] 结构化回执字段与类型对齐（code/message/category/retryable/details/suggestion）
- [x] validator 失败建议透传到回执
- [x] 批处理失败回执字段一致性验证

### Security Review
未发现新增安全风险。

### Performance Considerations
未发现性能问题；改动为轻量映射与类型扩展。

### Files Modified During Review
无（评审过程中未修改代码）。

### Gate Status
Gate: PASS → docs/qa/gates/1.3-failure-receipt-structure.yml  
Risk profile: docs/qa/assessments/1.3-risk-20260123.md  
NFR assessment: docs/qa/assessments/1.3-nfr-20260123.md

### Recommended Status
[✓ Ready for Done]（Story owner 决定最终状态）
