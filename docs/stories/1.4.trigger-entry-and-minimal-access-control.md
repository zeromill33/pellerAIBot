# Story 1.4: 触发入口与最小权限控制

## Status
Approved

## Story
**As a** 运营人员，
**I want** 通过 Telegram Admin Bot 触发 /publish 且仅限白名单管理员，
**so that** 入口安全可控并防止非授权发布。

Epic Context: 对应 Epic 1「运营触发与流程编排」的 E1-S4；本故事实现 Admin Bot 入口与最小权限控制。[Source: prd/epic-plan.md#Epic 1：运营触发与流程编排] [Source: architecture/architecture-core.md#1.3 运营触发入口（推荐方案）]
Dependencies: 1.1-1.3（解析、批处理、失败回执）。

## Acceptance Criteria
1. Admin Bot 提供 /publish 命令入口（至少），用于触发 Trigger API/Orchestrator。[Source: architecture/architecture-core.md#1.3 运营触发入口（推荐方案）]
2. Bot 仅允许配置中的 admin_user_ids 触发命令；非白名单用户被拒绝并返回错误回执。[Source: architecture/architecture-core.md#1.3 运营触发入口（推荐方案）] [Source: architecture/architecture-core.md#9. 安全与合规（Week 1 必须做到的“底线”)]
3. 入口层只做参数解析、权限校验与回执格式化，不直接处理业务链路。[Source: architecture/coding-standards.md#1.1 分层定义（本项目版）]
4. 配置项在启动时通过 schema 校验，缺失则启动失败。[Source: architecture/coding-standards.md#7.1 配置加载与校验（启动期失败）]

## Tasks / Subtasks
- [ ] Task 1：实现 Admin Bot /publish 入口（AC: 1, 3）[Source: architecture/architecture-core.md#1.3 运营触发入口（推荐方案）] [Source: architecture/source-tree.md#1) 源码目录结构（AI Signal Bot）]
  - [ ] Subtask 1.1：在 `src/bot/index.ts` 注册命令路由并调用 orchestrator
  - [ ] Subtask 1.2：在 `src/bot/commands/publish.ts` 解析参数并输出统一回执
- [ ] Task 2：实现白名单校验（AC: 2）[Source: architecture/architecture-core.md#1.3 运营触发入口（推荐方案）]
  - [ ] Subtask 2.1：在 `src/bot/guard.ts` 校验 admin_user_ids
  - [ ] Subtask 2.2：未授权用户返回结构化错误回执
- [ ] Task 3：配置加载与校验（AC: 4）[Source: architecture/coding-standards.md#7.1 配置加载与校验（启动期失败）]
  - [ ] Subtask 3.1：在 `src/config/config.schema.ts` 校验 admin_user_ids 必填
  - [ ] Subtask 3.2：启动期缺失即 fail-fast
- [ ] Task 4：补充测试用例（AC: 1-4）[Source: architecture/coding-standards.md#11 测试与质量门禁（必须更严格：build 通过 + 单测覆盖 + 外部依赖集成测试）]
  - [ ] Subtask 4.1：单元测试覆盖白名单通过/拒绝
  - [ ] Subtask 4.2：集成测试覆盖 /publish 入口调用 orchestrator（mock）

## Dev Notes
### Previous Story Insights
- 1.1-1.3 建立了解析、批处理与失败回执口径；本故事只负责入口与权限控制。

### Data Models
- admin_user_ids 为配置字段，需在启动期校验存在。[Source: architecture/architecture-core.md#1.3 运营触发入口（推荐方案）]

### API Specifications
- 运营触发入口是 Telegram Admin Bot /publish 命令。[Source: architecture/architecture-core.md#1.3 运营触发入口（推荐方案）]
- Trigger API 可是 HTTP 或进程内方法调用，本故事按进程内调用设计。[Source: architecture/architecture-core.md#1.3 运营触发入口（推荐方案）]

### Component Specifications
- Entry Layer 只负责参数解析、权限校验、调用 orchestrator、格式化回执。[Source: architecture/coding-standards.md#1.1 分层定义（本项目版）]
- Bot 路由与 guard 文件位置见 source-tree 目录结构说明。[Source: architecture/source-tree.md#1) 源码目录结构（AI Signal Bot）]

### File Locations
- `src/main.ts`：服务入口，加载配置并启动 Bot。[Source: architecture/source-tree.md#1) 源码目录结构（AI Signal Bot）]
- `src/bot/index.ts`：bot 启动与路由注册。[Source: architecture/source-tree.md#1) 源码目录结构（AI Signal Bot）]
- `src/bot/commands/publish.ts`：/publish 命令实现。[Source: architecture/source-tree.md#1) 源码目录结构（AI Signal Bot）]
- `src/bot/guard.ts`：admin 白名单校验。[Source: architecture/source-tree.md#1) 源码目录结构（AI Signal Bot）]
- `src/config/config.schema.ts`：配置 schema 校验。[Source: architecture/source-tree.md#1) 源码目录结构（AI Signal Bot）]

### Testing
- 需满足 build/typecheck/lint/unit/integration 的 CI 门禁；禁止依赖真实外网 API。[Source: architecture/coding-standards.md#11.1 CI 质量门禁（PR 必须通过）]
- 单元测试需覆盖边界与错误路径；集成测试使用 mock/replay。[Source: architecture/coding-standards.md#11.3 单元测试范围（必须覆盖“各种情况”)] [Source: architecture/coding-standards.md#11.4 Provider 集成测试（外部依赖：必须有“可回放”测试）]
- 测试框架建议使用 `vitest`（或 `jest`）；按仓库实际依赖确定。[Source: architecture/tech-stack.md#13) 技术选型清单（Week 1 建议落地版本）]
- 录制响应与集成测试 fixtures 位置建议使用 `fixtures/`。[Source: architecture/source-tree.md#1) 源码目录结构（AI Signal Bot）]

### Technical Constraints
- 运行时 Node.js 18+/20，TypeScript strict，ESM 模块制式。[Source: architecture/tech-stack.md#2) 语言与运行时]
- 配置缺失需在启动期失败，避免运行时错误。[Source: architecture/coding-standards.md#7.1 配置加载与校验（启动期失败）]

### Project Structure Notes
- `docs/architecture/unified-project-structure.md` 未找到；使用 `docs/architecture/source-tree.md` 作为目录结构依据。
- `docs/architecture/testing-strategy.md` 未找到；使用 `docs/architecture/coding-standards.md` 中测试门禁作为依据。

## Change Log
| Date       | Version | Description | Author |
| ---------- | ------- | ----------- | ------ |
| 2026-01-23 | 0.1     | 初稿        | Bob    |

## Dev Agent Record
### Agent Model Used

### Debug Log References

### Completion Notes List

### File List

## QA Results
