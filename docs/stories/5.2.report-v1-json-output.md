# Story 5.2: 输出 Report v1 JSON（0–9 段齐全）

## Status
Done

## Story
**作为** 系统（LLMProvider/Report Generator），  
**我希望** 生成严格符合 Report v1 schema 的 JSON 输出（0–9 段齐全），  
**以便** Validator 能稳定校验通过并驱动后续渲染与发布。

Epic Context: 对应 Epic 5「Report v1 生成」的 E5-S2。  
[Source: prd/epic-plan.md#Epic 5：Report v1 生成]

Dependencies: 依赖 E5-S1（LLM 输入组装）、E4-S1~S4（EvidenceBuilder 输出）、E2-S1~S4（MarketContext/PriceContext/Liquidity Proxy）。  
[Source: prd/epic-plan.md#Epic 2：市场数据采集与流动性代理]  
[Source: prd/epic-plan.md#Epic 4：Evidence Builder]  
[Source: prd/epic-plan.md#Epic 5：Report v1 生成]

## Acceptance Criteria
1. LLM 输出必须为 **纯 JSON**，严格匹配 Report v1 schema（多 key、缺 key 都失败），不得包含任何非 JSON 文本。  
   [Source: prd/appendices/report-v1-schema.md#附录 B：Report v1 JSON Schema（0–100 概率）]  
   [Source: prd/appendices/validator.md#F1. Schema 校验]  
   [Source: prd/appendices/prompts.md#G1. Report v1 生成 Prompt]
2. Report v1 必须包含 0–9 段对应字段：`context`、`market_framing`、`disagreement_map`、`priced_vs_new`、`sentiment`、`key_variables`、`failure_modes`、`risk_attribution`、`limitations`、`ai_vs_market`。  
   [Source: prd/prd-core.md#D2. Report v1（强制输出结构）]  
   [Source: prd/appendices/report-v1-schema.md#附录 B：Report v1 JSON Schema（0–100 概率）]
3. 概率字段必须为 0–100：`context.market_odds.yes/no` 与 `ai_vs_market.market_yes/ai_yes_beta`；`ai_vs_market.drivers` 长度 1–3 且不得出现“喊单”措辞。  
   [Source: prd/appendices/report-v1-schema.md#附录 B：Report v1 JSON Schema（0–100 概率）]  
   [Source: prd/appendices/validator.md#F1. Schema 校验]  
   [Source: prd/appendices/validator.md#F2. 内容闸门（失败则阻断发布）]
4. `disagreement_map.pro/con` 各 ≥ 2 条 evidenceItem（含 claim/source_type/url/time）；若证据不足，需输出占位条目并说明不足原因（source_type=“市场行为”，url=market url，time="N/A"）。  
   [Source: prd/appendices/report-v1-schema.md#附录 B：Report v1 JSON Schema（0–100 概率）]  
   [Source: prd/appendices/validator.md#F2. 内容闸门（失败则阻断发布）]  
   [Source: prd/appendices/prompts.md#G1. Report v1 生成 Prompt]
5. `priced_vs_new` 每条必须包含 `source_type`，且取值限定为：官方公告/主流媒体/社交讨论/链上数据/市场行为。  
   [Source: prd/appendices/report-v1-schema.md#附录 B：Report v1 JSON Schema（0–100 概率）]  
   [Source: prd/appendices/validator.md#F2. 内容闸门（失败则阻断发布）]
6. `failure_modes` 至少 2 条，每条需包含具体 `observable_signals`（不可空泛）。  
   [Source: prd/appendices/report-v1-schema.md#附录 B：Report v1 JSON Schema（0–100 概率）]  
   [Source: prd/appendices/validator.md#F2. 内容闸门（失败则阻断发布）]
7. 若 `sentiment.samples` 为空，则 `sentiment.bias` 与 `sentiment.relation` 必须为 `unknown`。  
   [Source: prd/appendices/validator.md#F2. 内容闸门（失败则阻断发布）]
8. `context.resolution_rules_raw` 必须非空且原样保留；输出中禁止下注建议/资金管理建议（含 limitations.not_included 的“no_bet_advice/no_position_sizing”）。  
   [Source: prd/appendices/report-v1-schema.md#附录 B：Report v1 JSON Schema（0–100 概率）]  
   [Source: prd/appendices/prompts.md#G1. Report v1 生成 Prompt]  
   [Source: prd/prd-core.md#D2. Report v1（强制输出结构）]
9. E2E 回归默认 stop step 扩展为 `report.validate`（或 `telegram.render` 在其就绪后），确保 Report 生成与校验被覆盖。  
   [Source: tests/e2e/publish-pipeline.e2e.test.ts]  
   [Source: src/orchestrator/pipeline.ts]

## Tasks / Subtasks
- [x] Task 1：完善 LLMProvider 输出 Report v1 JSON 的实现（AC: 1-8）  
  [Source: architecture/providers/llm.md#E.1 输出强约束]  
  [Source: architecture/providers/llm.md#E.3 最小接口]  
  [Source: architecture/coding-standards.md#4.1 LLM 只输出结构化 JSON（硬性）]
  - [x] Subtask 1.1：在 `src/providers/llm/index.ts` 实现 `generateReportV1`，只接受 JSON 输出（非 JSON 直接失败）
  - [x] Subtask 1.2：在 `src/providers/llm/postprocess.ts` 进行 JSON parse 与最小修复（禁止自由文本）
  - [x] Subtask 1.3：记录 `prompt_name/prompt_sha256/model/temperature` 以便审计
- [x] Task 2：在 `report.generate` step 中落地 ReportV1Json 产出（AC: 1-8）  
  [Source: architecture/source-tree.md#1) 源码目录结构（AI Signal Bot）]  
  [Source: architecture/coding-standards.md#2.2 Step 统一接口（强约束）]  
  [Source: architecture/architecture-core.md#4.1 主流程（单事件）]
  - [x] Subtask 2.1：在 `src/orchestrator/steps/report.generate.step.ts` 调用 `generateReportV1` 并写回 ctx
  - [x] Subtask 2.2：确保输出字段与 schema/validator 规则对齐（不在此 step 内绕过 validator）
- [x] Task 3：补充 Report v1 JSON 输出测试（AC: 1-8）  
  [Source: architecture/tech-stack.md#9) 测试策略]  
  [Source: architecture/coding-standards.md#11.6 LLM 测试策略（禁止“靠模型随机性”)]  
  [Source: architecture/coding-standards.md#11.3 单元测试范围（必须覆盖“各种情况”)]
  - [x] Subtask 3.1：LLM 相关测试必须 mock（禁止真实外网调用）
  - [x] Subtask 3.2：覆盖非 JSON 输出/缺 key/多 key/概率越界等错误分支
  - [x] Subtask 3.3：结合 validator 规则补充通过/阻断的典型用例
- [x] Task 4：E2E 回归扩展到 `report.validate`（AC: 9）  
  [Source: tests/e2e/publish-pipeline.e2e.test.ts]
  - [x] Subtask 4.1：将 E2E 默认 stop step 更新为 `report.validate`（或 `telegram.render`）  
  - [x] Subtask 4.2：E2E fake 模式使用 mock LLM 输出（严格 JSON）

## Dev Notes
### Previous Story Insights
No specific guidance found in architecture docs.  
[Source: architecture/architecture-core.md]

### Data Models
- Report v1 JSON 必须严格匹配 schema（字段与 required 列表见附录 B）。  
  [Source: prd/appendices/report-v1-schema.md#附录 B：Report v1 JSON Schema（0–100 概率）]
- evidenceItem 必须包含 `claim/source_type/url/time`，source_type 取值限定为：官方公告/主流媒体/社交讨论/链上数据/市场行为。  
  [Source: prd/appendices/report-v1-schema.md#附录 B：Report v1 JSON Schema（0–100 概率）]

### API Specifications
- LLMProvider 接口：`generateReportV1({ context, evidence, clob?, config }) -> ReportV1Json`。  
  [Source: architecture/providers/llm.md#E.3 最小接口]
- Report 生成位于 EvidenceBuilder 之后、Validator 之前的 pipeline step。  
  [Source: architecture/architecture-core.md#4.1 主流程（单事件）]

### Component Specifications
- LLM 必须输出纯 JSON，Renderer 只消费 JSON，不允许 LLM 直接产 TG 文本。  
  [Source: architecture/architecture-core.md#2.1 架构原则]  
  [Source: architecture/providers/llm.md#E.1 输出强约束]
- Prompt 必须文件化与版本化，记录 `prompt_name/prompt_sha256/model/temperature`。  
  [Source: architecture/coding-standards.md#4.2 Prompt 版本化与可审计]
- Validator 规则必须满足：resolution_rules_raw 非空、pro/con 各≥2、failure_modes≥2、URL ≥4 且域名多样性、反“喊单”拦截等。  
  [Source: prd/appendices/validator.md#F2. 内容闸门（失败则阻断发布）]

### File Locations
- `src/orchestrator/steps/report.generate.step.ts`：Report 生成 step。  
  [Source: architecture/source-tree.md#1) 源码目录结构（AI Signal Bot）]
- `src/providers/llm/prompt.ts` / `client.ts` / `postprocess.ts` / `index.ts`：LLM prompt 拼装、调用与解析。  
  [Source: architecture/source-tree.md#1) 源码目录结构（AI Signal Bot）]
- `prompts/report_v1_generate.prompt.txt`：Report v1 prompt 文件。  
  [Source: architecture/source-tree.md#1) 源码目录结构（AI Signal Bot）]
- `schemas/report_v1.schema.json` / `src/validator/schema/report_v1.schema.json`：Report v1 schema。  
  [Source: architecture/source-tree.md#1) 源码目录结构（AI Signal Bot）]
- `src/validator/*`：schema + 内容闸门校验。  
  [Source: architecture/source-tree.md#1) 源码目录结构（AI Signal Bot）]

### Testing Requirements
- LLM 测试必须 mock，CI 禁止真实外网调用。  
  [Source: architecture/coding-standards.md#11.6 LLM 测试策略（禁止“靠模型随机性”)]
- 单测覆盖所有分支/边界/错误路径。  
  [Source: architecture/coding-standards.md#11.3 单元测试范围（必须覆盖“各种情况”)]
- 测试需可重复（固定时间/随机、避免 sleep）。  
  [Source: architecture/coding-standards.md#11.8 可重复性（Determinism）要求]
- 参考单元/集成测试策略。  
  [Source: architecture/tech-stack.md#9) 测试策略]

### Technical Constraints
- Node.js 18+/20、TypeScript strict、ESM 模块制式。  
  [Source: architecture/tech-stack.md#2) 语言与运行时]

### Project Structure Notes
- `docs/architecture/unified-project-structure.md` 未找到；使用 `docs/architecture/source-tree.md` 作为目录结构依据。  
  [Source: architecture/source-tree.md#1) 源码目录结构（AI Signal Bot）]
- `docs/architecture/testing-strategy.md` 未找到；测试策略参考 `tech-stack.md` 与 `coding-standards.md`。  
  [Source: architecture/tech-stack.md#9) 测试策略]  
  [Source: architecture/coding-standards.md#11.3 单元测试范围（必须覆盖“各种情况”)]

## Change Log
| Date       | Version | Description | Author |
| ---------- | ------- | ----------- | ------ |
| 2026-01-27 | 0.1     | 创建故事草稿 | Bob    |
| 2026-01-27 | 0.2     | 纳入 E2E 覆盖到 report.validate | Winston |
| 2026-01-27 | 0.3     | 校验通过，状态调整为 Approved | Winston |
| 2026-01-27 | 0.4     | 实现 LLM 输出后处理与测试，更新 E2E stop step | James |
| 2026-01-27 | 0.5     | 补齐 schema 关键字段校验与单测 | James |

## Dev Agent Record
### Agent Model Used
GPT-5

### Debug Log References
- `deno lint` (failed: deno not installed)
- `deno test -A` (failed: deno not installed)
- `npm test -- tests/providers/llm/provider.test.ts`

### Completion Notes List
- 补齐 Report v1 schema 关键字段校验：time_remaining、liquidity_proxy、key_variables、risk_attribution、limitations。
- 补充 LLM provider 单测覆盖 disagreement_map/failure_modes/sentiment/resolution_rules_raw 等关键规则与边界。
- 更新 E2E mock 报告结构以匹配 schema 校验要求。

### File List
- src/providers/llm/index.ts
- src/providers/llm/postprocess.ts
- src/providers/llm/types.ts
- tests/e2e/publish-pipeline.e2e.test.ts
- tests/providers/llm/provider.test.ts

## QA Results

### Review Date: 2026-01-27

### Reviewed By: Quinn (Test Architect)

### Code Quality Assessment

实现清晰、分层合理，后处理校验覆盖了部分关键字段与范围；但与 Report v1 schema 的严格匹配仍存在缺口（未验证 time_remaining/liquidity_proxy/key_variables/risk_attribution/limitations 等字段与枚举），可能导致 LLM 输出按 schema 生成时被后处理放行或误拒绝。

### Refactoring Performed

无（未进行代码重构）。

### Compliance Check

- Coding Standards: ✓（错误处理与边界校验符合要求）
- Project Structure: ✓（文件位置与层次符合约定）
- Testing Strategy: ✗（仅覆盖部分负路径，未覆盖多项 schema/内容门禁规则）
- All ACs Met: ✗（AC1/AC3/AC8 的严格约束与免责声明/喊单限制未完整验证）

### Improvements Checklist

- [ ] 增加 schema 对齐校验：context.time_remaining/liquidity_proxy、key_variables 结构、risk_attribution 枚举、limitations.not_included 固定免责声明
- [ ] 为 disagreement_map、failure_modes、sentiment、resolution_rules_raw 添加明确单测
- [ ] 增加 ai_vs_market.drivers 反“喊单”校验（或明确由后续 validator 负责）

### Security Review

未发现直接安全问题；主要风险为输出结构不一致带来的发布可靠性问题。

### Performance Considerations

未发现明显性能问题；后处理校验开销可忽略。

### Files Modified During Review

无。

### Gate Status

Gate: CONCERNS → docs/qa/gates/5.2-输出-report-v1-json-0-9-段齐全.yml  
Risk profile: docs/qa/assessments/5.2-risk-20260127.md  
NFR assessment: docs/qa/assessments/5.2-nfr-20260127.md

### Recommended Status

[✗ Changes Required - See unchecked items above]
(Story owner decides final status)

### Review Date: 2026-01-27

### Reviewed By: Quinn (Test Architect)

### Code Quality Assessment

后处理已补齐 Report v1 关键 schema 校验，测试覆盖新增边界与内容门禁场景，整体实现与 schema 对齐度提升，可靠性风险显著降低。

### Refactoring Performed

无（未进行代码重构）。

### Compliance Check

- Coding Standards: ✓（错误处理与边界校验符合规范）
- Project Structure: ✓（文件位置与层次符合约定）
- Testing Strategy: ✓（新增单测覆盖关键负路径与 schema 规则）
- All ACs Met: ✓（AC1-9 覆盖充分；E2E mock 输出已对齐 schema）

### Improvements Checklist

- [x] 增加 schema 对齐校验：context.time_remaining/liquidity_proxy、key_variables 结构、risk_attribution 枚举、limitations.not_included 固定免责声明
- [x] 为 disagreement_map、failure_modes、sentiment、resolution_rules_raw 添加明确单测
- [x] 增加 ai_vs_market.drivers 反“喊单”校验（目前由 validator 负责；后处理已保证 drivers 长度与非空）

### Security Review

未发现直接安全问题。

### Performance Considerations

后处理校验开销可忽略，无明显性能问题。

### Files Modified During Review

无。

### Gate Status

Gate: PASS → docs/qa/gates/5.2-输出-report-v1-json-0-9-段齐全.yml  
Risk profile: docs/qa/assessments/5.2-risk-20260127.md  
NFR assessment: docs/qa/assessments/5.2-nfr-20260127.md

### Recommended Status

[✓ Ready for Done]
(Story owner decides final status)
