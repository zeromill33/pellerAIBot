# Story 7.4: 发布策略开关（自动发布 / 运营确认）

## Status
Done

## Story
**作为** 运营人员，  
**我希望** 发布策略可配置为“自动发布”或“运营确认后发布”，  
**以便** 在高风险或敏感事件中进行人工审核。

Epic Context: 对应 Epic 7「数据落地与运营校验」的 E7-S4。  
[Source: prd/epic-plan.md#Epic 7：数据落地与运营校验]

Dependencies: 依赖渲染与存储已完成（report_json/tg_post_text 落地），并具备发布流程。  
[Source: architecture/architecture-core.md#6.2 TelegramPublisher（落地后/可审核）]

## Acceptance Criteria
1. 发布策略必须配置化二选一：自动发布 or 运营确认后发布。  
   [Source: prd/appendices/ops-sop.md#6) 发布策略（配置化二选一）]
2. 自动发布模式下，Validator 通过后直接推送 TG Channel。  
   [Source: prd/appendices/ops-sop.md#6) 发布策略（配置化二选一）]
3. 运营确认模式下，Validator 通过后仅保存草稿，需运营明确确认后再推送。  
   [Source: prd/appendices/ops-sop.md#6) 发布策略（配置化二选一）]
4. 发布成功后记录 `status=published` 与 `message_id`。  
   [Source: architecture/architecture-core.md#4.1 主流程（单事件）]

## Tasks / Subtasks
- [x] Task 1：配置发布策略开关（AC: 1）  
  [Source: prd/appendices/ops-sop.md#6) 发布策略（配置化二选一）]
  - [x] Subtask 1.1：在 `src/config/defaults.ts` 与 `config.schema.ts` 增加 `publish_strategy`（auto/approve）
- [x] Task 2：在 pipeline 中按策略执行发布（AC: 2-4）  
  [Source: architecture/architecture-core.md#4.1 主流程（单事件）]
  - [x] Subtask 2.1：自动发布：`telegram.publish.step.ts` 直接推送并写回 message_id/status
  - [x] Subtask 2.2：运营确认：跳过 publish step，保留草稿状态并等待后续命令触发发布
- [x] Task 3：补充发布策略测试（AC: 1-4）  
  [Source: architecture/tech-stack.md#9) 测试策略]
  - [x] Subtask 3.1：配置 auto 模式下发布路径
  - [x] Subtask 3.2：配置 approve 模式下不发布并记录状态

## Dev Notes
### Previous Story Insights
No specific guidance found in architecture docs.  
[Source: architecture/architecture-core.md]

### Data Models
- Report 表需记录 `status` 与 `tg_message_id`。  
  [Source: architecture/architecture-core.md#7.2 数据表（SQLite 逻辑模型）]

### API Specifications
- TelegramPublisher：`publishToChannel(text, options) -> {message_id}`。  
  [Source: architecture/architecture-core.md#3.1 Provider 接口清单（概览）]

### Component Specifications
- 支持“自动发布 / 运营确认后发布”。  
  [Source: architecture/architecture-core.md#6.2 TelegramPublisher（落地后/可审核）]

### File Locations
- `src/config/defaults.ts` / `src/config/config.schema.ts`：发布策略配置。  
  [Source: architecture/source-tree.md#1) 源码目录结构（AI Signal Bot）]
- `src/orchestrator/steps/telegram.publish.step.ts`：发布 step。  
  [Source: architecture/source-tree.md#1) 源码目录结构（AI Signal Bot）]
- `src/storage/sqlite/report.repo.ts`：更新 status/message_id。  
  [Source: architecture/source-tree.md#1) 源码目录结构（AI Signal Bot）]

### Testing Requirements
- 参考单元/集成测试策略。  
  [Source: architecture/tech-stack.md#9) 测试策略]

### Technical Constraints
- 运营确认模式需要后续命令触发发布（可由后续 story 实现）。

### Project Structure Notes
- `docs/architecture/unified-project-structure.md` 未找到；使用 `docs/architecture/source-tree.md` 作为目录结构依据。  
  [Source: architecture/source-tree.md#1) 源码目录结构（AI Signal Bot）]

## Change Log
| Date       | Version | Description | Author |
| ---------- | ------- | ----------- | ------ |
| 2026-01-27 | 0.1     | 创建故事草稿 | Bob    |

## Dev Agent Record
### Agent Model Used
GPT-5 (Codex CLI)

### Debug Log References
- npm test
- npm run build

### Completion Notes List
- 新增发布策略配置（auto/approve）与加载逻辑。
- Pipeline 增加 telegram.publish step，自动发布更新 status/message_id，approve 模式跳过发布。
- 新增 Telegram 发布 Provider 与存储发布状态更新。
- 增加发布策略测试与配置测试。

### File List
- src/config/defaults.ts
- src/config/config.schema.ts
- src/config/load.ts
- src/orchestrator/pipeline.ts
- src/orchestrator/steps/telegram.publish.step.ts
- src/orchestrator/errors.ts
- src/providers/telegram/index.ts
- src/storage/sqlite/report.repo.ts
- src/storage/sqlite/index.ts
- src/storage/index.ts
- tests/config.test.ts
- tests/orchestrator/publish-strategy.test.ts

## QA Results
