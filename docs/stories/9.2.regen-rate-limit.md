# Story 9.2: 重生成限流

## Status
Draft

## Story
**As a** 运维/开发者，
**I want** 对 /regen 触发的重生成设置严格限流，
**so that** 系统能稳定运行并避免被过度调用。

## Acceptance Criteria
1. 对单个事件（per slug）实施重生成限流：5 分钟内最多 1 次、1 小时内最多 5 次（阈值可配置）。
2. 触发限流时应阻断重生成，并返回清晰错误原因（可用于运营回执）。
3. 限流逻辑与其他 Provider 限流（如 Tavily 全局限流）保持边界清晰，不互相干扰。
4. 相关配置有默认值并可在配置中覆盖（与配置/密钥边界一致），配置键包含：`rate_limit.regenerate.min_interval_seconds` 与 `rate_limit.regenerate.per_hour.max_requests`。

## Tasks / Subtasks
- [ ] Task 1：实现/完善 per-slug 重生成限流逻辑（AC: 1, 2）
  - [ ] 依据架构约束将限流逻辑放在 `rate_limit` 相关模块
  - [ ] 限流触发时返回明确错误信息
- [ ] Task 2：配置化限流阈值并提供默认值（AC: 1, 4）
  - [ ] 默认值：5 分钟 1 次、1 小时 5 次
  - [ ] 确保配置覆盖不影响其他限流
- [ ] Task 3：与流水线入口/命令触发集成（AC: 2, 3）
  - [ ] /regen 入口触发前完成校验
  - [ ] 回执包含限流原因与下一次可用提示（如适用）
- [ ] Task 4：测试覆盖（AC: 1–4）
  - [ ] 单元测试：窗口内命中/未命中/跨窗口
  - [ ] 集成测试：/regen 限流回执

## Dev Notes

### 相关技术/结构约束
- 限流是配置化能力，包含 per slug 重生成限流与全局限流。 [Source: architecture/tech-stack.md#6) 缓存与限流]
- per slug 重生成限流阈值为：5 分钟 1 次、1 小时最多 5 次（配置化）。 [Source: architecture/tech-stack.md#6.1 限流]
- 重生成限流策略：基于 `slug` + 时间窗计数（SQLite/Redis 均可）。 [Source: architecture/architecture-core.md#8.1 重复生成限流（per event）]
- 关键配置项：`rate_limit.regenerate.min_interval_seconds = 300`、`rate_limit.regenerate.per_hour.max_requests = 5`。 [Source: architecture/architecture-core.md#14. 附：关键配置（与 PRD 对齐）]
- Provider 层与 Orchestrator/Steps 需保持边界清晰，限流逻辑应独立可复用。 [Source: architecture/coding-standards.md#3.3 限流：全局 + 分 Provider + 分事件（多层）]
- Admin Bot 支持 `/regen <polymarket_slug>`，仅白名单用户可触发。 [Source: architecture/architecture-core.md#1.3 运营触发入口（推荐方案）][Source: architecture/architecture-core.md#9. 安全与合规（Week 1 必须做到的“底线”)]

### 关联模块（仅限架构文档允许范围）
- `src/rate_limit/regen_guard.ts`：重生成限流（per slug）。该路径在架构中定义，但当前仓库未出现，需实现或调整落点。 [Source: architecture/source-tree.md#源码目录结构（AI Signal Bot）]
- `src/rate_limit/token_bucket.ts`：限流基础实现。该路径在架构中定义，但当前仓库未出现，需实现或调整落点。 [Source: architecture/source-tree.md#源码目录结构（AI Signal Bot）]
- `src/bot/commands/regen.ts`：/regen 命令入口（架构中定义，当前仓库未出现，需要补齐）。 [Source: architecture/source-tree.md#源码目录结构（AI Signal Bot）]
- `src/orchestrator/index.ts`：触发入口与回执。 [Source: architecture/source-tree.md#源码目录结构（AI Signal Bot）]
- `src/storage/sqlite/report.repo.ts`：Report 表包含 `regenerate_count_1h`。 [Source: architecture/architecture-core.md#数据表设计（REPORT）]

### Testing
- 单元测试：限流逻辑与窗口边界。 [Source: architecture/tech-stack.md#9) 测试策略]
- 集成测试：/regen 触发路径。 [Source: architecture/tech-stack.md#9) 测试策略]
- 覆盖场景：5 分钟内第二次 /regen 被拒；1 小时内第 6 次被拒；超过窗口可恢复。

## Change Log

| Date | Version | Description | Author |
| --- | --- | --- | --- |
| 2026-01-29 | v0.1 | 创建 E9-S2 故事草案 | Bob (SM) |
| 2026-01-29 | v0.2 | 补充限流配置键与策略细节 | Bob (SM) |
| 2026-01-29 | v0.3 | 标注当前缺失模块与修复测试说明 | Bob (SM) |

## Dev Agent Record

### Agent Model Used

### Debug Log References

### Completion Notes List

### File List

## QA Results
