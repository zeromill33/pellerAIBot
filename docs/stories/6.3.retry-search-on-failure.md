# Story 6.3: 失败触发补搜并重跑验证

## Status
Approved

## Story
**作为** 系统（Orchestrator/Validator），  
**我希望** 在 Validator 失败且满足补搜条件时触发补搜并重跑验证，  
**以便** 提升通过率并减少人工干预。

Epic Context: 对应 Epic 6「Validator 与补搜闭环」的 E6-S3。  
[Source: prd/epic-plan.md#Epic 6：Validator 与补搜闭环]

Dependencies: 依赖 E6-S1/E6-S2（Validator 规则与错误码），以及 QueryStrategy/Tavily 多车道检索能力。  
[Source: prd/epic-plan.md#Epic 6：Validator 与补搜闭环]  
[Source: architecture/architecture-core.md#4.3 “补搜”策略（节省额度 + 提升通过率）]

## Acceptance Criteria
1. 当 Validator 失败且命中“证据不足/来源不足”类错误时，系统应触发补搜策略并重跑验证（同一事件内）。  
   [Source: architecture/architecture-core.md#4.3 “补搜”策略（节省额度 + 提升通过率）]  
   [Source: prd/prd-core.md#风险与对策（Week 1）]
2. 补搜触发条件至少覆盖：`disagreement_map` 任一侧证据不足（<2）、`failure_modes` 过短、引用 URL < 4 或域名过于单一。  
   [Source: architecture/architecture-core.md#4.3 “补搜”策略（节省额度 + 提升通过率）]
3. 补搜规则：优先补 C 车道一次（或将 C 从 basic→advanced）；满足条件时启用 D 车道并执行 2–3 类不同类型 Query。  
   [Source: architecture/architecture-core.md#4.3 “补搜”策略（节省额度 + 提升通过率）]
4. 若超出 Tavily 限额或补搜后仍失败，应返回明确失败原因与建议（如 “额度限制/证据不足”）。  
   [Source: architecture/architecture-core.md#4.3 “补搜”策略（节省额度 + 提升通过率）]
5. 补搜流程必须可追溯：记录触发原因、采用的车道与查询组，并在返回中包含 `suggestion`。  
   [Source: architecture/architecture-core.md#5.2 输出错误格式（用于运营可读回执）]

## Tasks / Subtasks
- [ ] Task 1：扩展 Validator 错误输出以支持补搜决策（AC: 1,5）  
  [Source: architecture/architecture-core.md#5.2 输出错误格式（用于运营可读回执）]
  - [ ] Subtask 1.1：对证据不足类错误返回 `suggestion: { action: "ADD_SEARCH", preferred_lane: "C" }`
  - [ ] Subtask 1.2：在 error code 中区分“证据不足/来源不足/失败路径不足”类原因
- [ ] Task 2：在 Orchestrator 中实现补搜重跑（AC: 1-4）  
  [Source: architecture/architecture-core.md#4.3 “补搜”策略（节省额度 + 提升通过率）]  
  [Source: architecture/source-tree.md#1) 源码目录结构（AI Signal Bot）]
  - [ ] Subtask 2.1：在 `src/orchestrator/pipeline.ts` 或 `query.plan.build.step.ts` 支持补搜 lane 升级（C basic→advanced）
  - [ ] Subtask 2.2：当建议启用 D 时，生成 2–3 类不同类型 Query 并执行 Tavily 检索
  - [ ] Subtask 2.3：补搜后重跑 EvidenceBuilder → LLM → Validator，并限制补搜次数（1 次）
- [ ] Task 3：补充补搜流程测试（AC: 1-4）  
  [Source: architecture/coding-standards.md#11.3 单元测试范围（必须覆盖“各种情况”)]
  - [ ] Subtask 3.1：模拟证据不足触发补搜并验证通过
  - [ ] Subtask 3.2：模拟额度不足/补搜后仍失败并返回建议

## Dev Notes
### Previous Story Insights
No specific guidance found in architecture docs.  
[Source: architecture/architecture-core.md]

### Data Models
- Validator 失败返回结构示例：`{ ok:false, code, message, suggestion:{action, preferred_lane} }`。  
  [Source: architecture/architecture-core.md#5.2 输出错误格式（用于运营可读回执）]

### API Specifications
- 补搜触发条件与规则详见 4.3；补搜失败需返回可读原因。  
  [Source: architecture/architecture-core.md#4.3 “补搜”策略（节省额度 + 提升通过率）]

### Component Specifications
- 补搜规则：优先补 C；满足条件时启用 D 查询组（2–3 类）。  
  [Source: architecture/architecture-core.md#4.3 “补搜”策略（节省额度 + 提提升通过率）]

### File Locations
- `src/orchestrator/pipeline.ts`：主流程编排（补搜重跑入口）。  
  [Source: architecture/source-tree.md#1) 源码目录结构（AI Signal Bot）]
- `src/orchestrator/steps/query.plan.build.step.ts`：查询计划生成（补搜 lane 升级）。  
  [Source: architecture/source-tree.md#1) 源码目录结构（AI Signal Bot）]
- `src/validator/index.ts` / `src/validator/gates.ts`：错误码与 suggestion 输出。  
  [Source: architecture/source-tree.md#1) 源码目录结构（AI Signal Bot）]

### Testing Requirements
- 单测覆盖补搜触发、补搜失败、补搜成功后通过验证。  
  [Source: architecture/coding-standards.md#11.3 单元测试范围（必须覆盖“各种情况”)]

### Technical Constraints
- 补搜最多 1 次，避免无限循环；超额直接失败返回原因。  
  [Source: architecture/architecture-core.md#4.3 “补搜”策略（节省额度 + 提升通过率）]

### Project Structure Notes
- `docs/architecture/unified-project-structure.md` 未找到；使用 `docs/architecture/source-tree.md` 作为目录结构依据。  
  [Source: architecture/source-tree.md#1) 源码目录结构（AI Signal Bot）]

## Change Log
| Date       | Version | Description | Author |
| ---------- | ------- | ----------- | ------ |
| 2026-01-27 | 0.1     | 创建故事草稿 | Bob    |
| 2026-01-27 | 0.2     | 校验通过，状态调整为 Approved | Winston |

## Dev Agent Record
### Agent Model Used

### Debug Log References

### Completion Notes List

### File List

## QA Results
