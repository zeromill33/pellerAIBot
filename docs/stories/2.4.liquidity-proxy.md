# Story 2.4: 计算 Liquidity Proxy 并合并到上下文

## Status
Approved

## Story
**作为** 系统（Pipeline），  
**我希望** 基于 Gamma 与 CLOB 的数据计算 Liquidity Proxy 并合并到事件上下文，  
**以便** 在报告中提供“市场结构/流动性”的可解释信号。

Dependencies: E2-S1（Gamma 市场元数据），E2-S2（CLOB 订单簿摘要）。

## Acceptance Criteria
1. 基于 Gamma 市场数据与 CLOB 订单簿特征生成 Liquidity Proxy。  
   [Source: architecture/architecture-core.md#3.2 核心数据结构（内部标准化 DTO）]
2. Liquidity Proxy 至少包含：`gamma_liquidity`、`book_depth_top10`、`spread`、`midpoint`、`notable_walls`。  
   [Source: architecture/architecture-core.md#3.2 核心数据结构（内部标准化 DTO）]  
   [Source: architecture/architecture-core.md#7.2 数据表（SQLite 逻辑模型）]
3. `book_depth_top10` 基于订单簿 top N 档聚合（N=10），与 `book_top_levels` 保持一致口径。  
   [Source: architecture/providers/polymarket-clob.md#B.3 关键端点：Get order book summary]
4. `book_depth_top10` = top10 bids size 之和 + top10 asks size 之和；若任一侧为空则按 0 计。  
5. `gamma_liquidity` 使用选定 market 的 liquidity 字段；若缺失则置空。  
6. 结果可被后续步骤（LLM/Renderer）读取，字段命名统一并可落地到 Event 表字段。  
   [Source: architecture/architecture-core.md#7.2 数据表（SQLite 逻辑模型）]
7. Liquidity Proxy 不覆盖或混入 `price_context`，价格信号由 2.3 独立提供。  
   [Source: architecture/architecture-core.md#3.2 核心数据结构（内部标准化 DTO）]

## Tasks / Subtasks
- [ ] 在 Orchestrator 或相关 step 中合并 Gamma 与 CLOB 数据，形成 Liquidity Proxy（AC: 1, 2, 4, 5）  
  [Source: architecture/architecture-core.md#7.2 数据表（SQLite 逻辑模型）]
- [ ] 在 `MarketContext` 或相关 DTO 中补齐 Liquidity Proxy 字段与 `book_top_levels` → `book_depth_top10` 聚合（AC: 2, 3, 4）  
  [Source: architecture/architecture-core.md#3.2 核心数据结构（内部标准化 DTO）]  
  [Source: architecture/providers/polymarket-clob.md#B.3 关键端点：Get order book summary]
- [ ] 补充测试覆盖 Liquidity Proxy 的计算与字段合并（AC: 1-7）  
  [Source: architecture/tech-stack.md#9) 测试策略]

## Dev Notes
### Previous Story Insights
No specific guidance found in architecture docs.  
[Source: architecture/architecture-core.md]

### Data Models
- `MarketContext` 包含 `liquidity_proxy`，`ClobSnapshot` 包含 `spread/midpoint/book_top_levels/notable_walls`。  
  [Source: architecture/architecture-core.md#3.2 核心数据结构（内部标准化 DTO）]
- SQLite 逻辑模型中包含 `gamma_liquidity`、`book_depth_top10`、`spread` 等字段。  
  [Source: architecture/architecture-core.md#7.2 数据表（SQLite 逻辑模型）]
- `MarketContext.price_context` 由 Pricing 步骤填充，不在本故事范围内。  
  [Source: architecture/architecture-core.md#3.2 核心数据结构（内部标准化 DTO）]
- Event 表中的 `price_*` 字段由 2.3 负责，本故事只关注 Liquidity Proxy 字段。  
  [Source: architecture/architecture-core.md#7.2 数据表（SQLite 逻辑模型）]

### API Specifications
No specific guidance found in architecture docs.  
[Source: architecture/architecture-core.md]

### Component Specifications
- Liquidity Proxy 使用 Gamma（liquidity）与 CLOB（book_top_levels/spread/midpoint/notable_walls）作为代理指标。  
  [Source: architecture/architecture-core.md#4.1 主流程（单事件）]  
  [Source: architecture/architecture-core.md#3.2 核心数据结构（内部标准化 DTO）]
- 价格信号属于 `price_context`，需与 Liquidity Proxy 计算逻辑分离。  
  [Source: architecture/architecture-core.md#3.2 核心数据结构（内部标准化 DTO）]

### File Locations
建议按现有结构实现/修改下列位置：  
- `src/orchestrator/steps/`（合并计算 step）  
- `src/orchestrator/types.ts`（MarketContext/ClobSnapshot DTO 扩展）  
[Source: architecture/source-tree.md#1) 源码目录结构（AI Signal Bot）]

### Testing Requirements
- 单元测试覆盖计算逻辑；集成测试覆盖字段合并与下游可读性。  
  [Source: architecture/tech-stack.md#9) 测试策略]

### Technical Constraints
- TypeScript 严格模式、ESM 模块制式，避免使用 `any`。  
  [Source: architecture/tech-stack.md#2) 语言与运行时]

### Project Structure Notes
当前源码结构与架构目录树一致；Liquidity Proxy 合并建议落在 orchestrator step 中。  
[Source: architecture/source-tree.md#1) 源码目录结构（AI Signal Bot）]

## Change Log
| Date       | Version | Description | Author |
| ---------- | ------- | ----------- | ------ |
| 2026-01-23 | 0.1     | 创建故事草稿 | Bob |
| 2026-01-23 | 0.2     | 明确与 price_context 的边界 | Winston |
| 2026-01-23 | 0.3     | 补充与 price_* 字段的责任边界 | Winston |

## Dev Agent Record
### Agent Model Used

### Debug Log References

### Completion Notes List

### File List

## QA Results
