# Story 2.4: 计算 Liquidity Proxy 并合并到上下文

## Status
Ready for Review

## Story
**作为** 系统（Pipeline），  
**我希望** 基于 Gamma 与 CLOB 的数据计算 Liquidity Proxy 并合并到事件上下文，  
**以便** 在报告中提供“市场结构/流动性”的可解释信号。

Dependencies: E2-S1（Gamma 市场元数据），E2-S2（CLOB 订单簿摘要）。

## Acceptance Criteria
1. 基于 Gamma 市场数据与 CLOB 订单簿特征生成 Liquidity Proxy。  
   [Source: architecture/architecture-core.md#3.2 核心数据结构（内部标准化 DTO）]
2. Liquidity Proxy 至少包含：`gamma_liquidity`、`book_depth_top10`、`spread`、`midpoint`、`notable_walls`。  
   [Source: architecture/architecture-core.md#3.2 核心数据结构（内部标准化 DTO）]  
   [Source: architecture/architecture-core.md#7.2 数据表（SQLite 逻辑模型）]
3. `book_depth_top10` 基于订单簿 top N 档聚合（N=10），与 `book_top_levels` 保持一致口径。  
   [Source: architecture/providers/polymarket-clob.md#B.3 关键端点：Get order book summary]
4. `book_depth_top10` = top10 bids size 之和 + top10 asks size 之和；若任一侧为空则按 0 计。  
5. `gamma_liquidity` 使用选定 market 的 liquidity 字段；若缺失则置空。  
6. 结果可被后续步骤（LLM/Renderer）读取，字段命名统一并可落地到 Event 表字段。  
   [Source: architecture/architecture-core.md#7.2 数据表（SQLite 逻辑模型）]
7. Liquidity Proxy 不覆盖或混入 `price_context`，价格信号由 2.3 独立提供。  
   [Source: architecture/architecture-core.md#3.2 核心数据结构（内部标准化 DTO）]

## Tasks / Subtasks
- [x] 新增 `src/orchestrator/steps/market.fetch.step.ts`，封装 Gamma 拉取并产出 `MarketContext`（补齐 2.1 orchestrator step）  
  [Source: architecture/source-tree.md#1) 源码目录结构（AI Signal Bot）]
- [x] 新增 `src/orchestrator/steps/market.orderbook.fetch.step.ts`，封装 CLOB 拉取并产出 `ClobSnapshot`（补齐 2.2 orchestrator step）  
  [Source: architecture/source-tree.md#1) 源码目录结构（AI Signal Bot）]
- [x] 在 `src/orchestrator/pipeline.ts` 串联 `market.fetch` 与 `market.orderbook.fetch`，确保 Liquidity Proxy 计算有完整输入  
  [Source: architecture/source-tree.md#1) 源码目录结构（AI Signal Bot）]
- [x] 在 Orchestrator 或相关 step 中合并 Gamma 与 CLOB 数据，形成 Liquidity Proxy（AC: 1, 2, 4, 5）  
  [Source: architecture/architecture-core.md#7.2 数据表（SQLite 逻辑模型）]
- [x] 在 `MarketContext` 或相关 DTO 中补齐 Liquidity Proxy 字段与 `book_top_levels` → `book_depth_top10` 聚合（AC: 2, 3, 4）  
  [Source: architecture/architecture-core.md#3.2 核心数据结构（内部标准化 DTO）]  
  [Source: architecture/providers/polymarket-clob.md#B.3 关键端点：Get order book summary]
- [x] 补充测试覆盖 Liquidity Proxy 的计算与字段合并（AC: 1-7）  
  [Source: architecture/tech-stack.md#9) 测试策略]

## Dev Notes
### Previous Story Insights
No specific guidance found in architecture docs.  
[Source: architecture/architecture-core.md]

### Data Models
- `MarketContext` 包含 `liquidity_proxy`，`ClobSnapshot` 包含 `spread/midpoint/book_top_levels/notable_walls`。  
  [Source: architecture/architecture-core.md#3.2 核心数据结构（内部标准化 DTO）]
- SQLite 逻辑模型中包含 `gamma_liquidity`、`book_depth_top10`、`spread` 等字段。  
  [Source: architecture/architecture-core.md#7.2 数据表（SQLite 逻辑模型）]
- `MarketContext.price_context` 由 Pricing 步骤填充，不在本故事范围内。  
  [Source: architecture/architecture-core.md#3.2 核心数据结构（内部标准化 DTO）]
- Event 表中的 `price_*` 字段由 2.3 负责，本故事只关注 Liquidity Proxy 字段。  
  [Source: architecture/architecture-core.md#7.2 数据表（SQLite 逻辑模型）]

### API Specifications
No specific guidance found in architecture docs.  
[Source: architecture/architecture-core.md]

### Component Specifications
- Liquidity Proxy 使用 Gamma（liquidity）与 CLOB（book_top_levels/spread/midpoint/notable_walls）作为代理指标。  
  [Source: architecture/architecture-core.md#4.1 主流程（单事件）]  
  [Source: architecture/architecture-core.md#3.2 核心数据结构（内部标准化 DTO）]
- 价格信号属于 `price_context`，需与 Liquidity Proxy 计算逻辑分离。  
  [Source: architecture/architecture-core.md#3.2 核心数据结构（内部标准化 DTO）]

### File Locations
建议按现有结构实现/修改下列位置：  
- `src/orchestrator/steps/market.fetch.step.ts`（Gamma 拉取 MarketContext）  
- `src/orchestrator/steps/market.orderbook.fetch.step.ts`（CLOB 拉取 ClobSnapshot）  
- `src/orchestrator/steps/`（合并计算 step）  
- `src/orchestrator/types.ts`（MarketContext/ClobSnapshot DTO 扩展）  
[Source: architecture/source-tree.md#1) 源码目录结构（AI Signal Bot）]

### Testing Requirements
- 单元测试覆盖计算逻辑；集成测试覆盖字段合并与下游可读性。  
  [Source: architecture/tech-stack.md#9) 测试策略]

### Technical Constraints
- TypeScript 严格模式、ESM 模块制式，避免使用 `any`。  
  [Source: architecture/tech-stack.md#2) 语言与运行时]

### Project Structure Notes
当前源码结构与架构目录树一致；Liquidity Proxy 合并建议落在 orchestrator step 中。  
[Source: architecture/source-tree.md#1) 源码目录结构（AI Signal Bot）]

## Change Log
| Date       | Version | Description | Author |
| ---------- | ------- | ----------- | ------ |
| 2026-01-23 | 0.1     | 创建故事草稿 | Bob |
| 2026-01-23 | 0.2     | 明确与 price_context 的边界 | Winston |
| 2026-01-23 | 0.3     | 补充与 price_* 字段的责任边界 | Winston |
| 2026-01-24 | 0.4     | 补充 2.1/2.2 缺失的 orchestrator step 任务 | James |
| 2026-01-24 | 0.5     | 实现 Liquidity Proxy step 与测试，并补齐 pipeline 串联 | James |
| 2026-01-24 | 0.6     | 修复严格模式索引访问与 step 类型约束 | James |
| 2026-01-24 | 0.7     | 修正单边盘口保留深度并补测与手动验证 | James |
| 2026-01-24 | 0.8     | 订单簿回退到双边盘口 market 并补测 | James |
| 2026-01-24 | 0.9     | 记录订单簿选择的 market/token | James |
| 2026-01-24 | 0.10    | 拉取 Top N markets 的 clob+price 并记录信号 | James |
| 2026-01-24 | 0.11    | Pricing 失败时回退使用 CLOB midpoint | James |
| 2026-01-24 | 0.12    | 手动验证 pricing 兜底结果 | James |

## Dev Agent Record
### Agent Model Used
GPT-5

### Debug Log References
npm test
npm run build
node --input-type=module -e "…market.fetch/orderbook/liquidity.proxy" (manual verification)
node --input-type=module -e "…market.fetch/orderbook/liquidity.proxy" (manual verification, dual-side fallback)
npm run build
npm test
node --input-type=module -e "…market.fetch/orderbook/liquidity.proxy" (manual verification, record market/token)
npm run build
npm test
node --input-type=module -e "…market.fetch/market.signals/orderbook" (manual verification, top N markets)
node --input-type=module -e "…market.fetch/market.signals" (manual verification, pricing fallback)

### Completion Notes List
- 新增 Gamma/CLOB orchestrator steps，并在 pipeline 中串联以供 Liquidity Proxy 使用。
- Liquidity Proxy 聚合 book_depth_top10 并合并到 MarketContext。
- 新增 Liquidity Proxy 与 step 单测，测试通过。
- AC6（落地到 Event 表字段）不在本故事范围（用户确认）。
- 保留单边盘口深度（spread/midpoint 仍为 null），补充单测覆盖。
- 若主 market 盘口单边，回退到同事件双边盘口 market；手动验证 slug=who-will-trump-nominate-as-fed-chair：spread/midpoint 有值。
- 记录订单簿选择的 market_id 与 token_id 到 MarketContext。
- 手动验证记录：clob_market_id_used=572470、clob_token_id_used=34551606549875928972193520396544368029176529083448203019529657908155427866742。
- Top N=10 拉取所有 market token 的 clob+price，输出 market_signals；pricing 失败时标记 PRICE_API_FAILED。
- 手动验证 top N=10：Pricing API 对该事件 token 返回 400，price_context 填充为空并标记 PRICE_API_FAILED。
- Pricing API 失败时用 CLOB midpoint 兜底 latest/midpoint（保留 PRICE_API_FAILED 标记）。
- 手动验证 pricing 兜底：Top N=10 中 4 个 token 有 CLOB midpoint → price_context.midpoint/最新价有值，其余为 null（单边盘口）。

### File List
- src/providers/polymarket/clob.ts
- src/orchestrator/errors.ts
- src/orchestrator/pipeline.ts
- src/orchestrator/types.ts
- src/orchestrator/steps/market.fetch.step.ts
- src/orchestrator/steps/market.orderbook.fetch.step.ts
- src/orchestrator/steps/market.liquidity.proxy.step.ts
- src/orchestrator/steps/market.pricing.fetch.step.ts
- src/orchestrator/steps/market.signals.fetch.step.ts
- tests/orchestrator/market-fetch.step.test.ts
- tests/orchestrator/market-orderbook.step.test.ts
- tests/orchestrator/market-liquidity-proxy.step.test.ts
- tests/orchestrator/market-signals.step.test.ts
- tests/providers/polymarket/clob.test.ts

## QA Results
