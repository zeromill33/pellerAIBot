# Story 2.3: 获取 tokenId 价格信息（最新价/中位价/历史价格）

## Status
Done

## Story
**作为** 系统（Pipeline），  
**我希望** 能根据 tokenId 获取最新价格、中位价与历史价格序列，  
**以便** 为后续的价格变化分析与报告提供稳定输入。

Dependencies: E2-S1（MarketContext 提供 clob tokenIds），E2-S2（ClobSnapshot 作为价格信号上下文参考）。

## Acceptance Criteria
1. 支持通过 tokenId 获取最新价格（Get market price）。
2. 支持通过 tokenId 获取中位价（Get midpoint price）。
3. 支持通过 tokenId 获取历史价格序列（24h/小时级）。
4. 生成必须派生指标：change_1h/4h/24h、volatility_24h、range_high_24h、range_low_24h、trend_slope_24h、spike_flag（严格阈值，公式按附录 J）。
5. 保留 24h 原始历史序列（history_24h）并可落地为 `price_history_24h_json`。
6. 将 raw + derived 作为 `price_context` 合并到 `MarketContext` 中供 LLM 使用。
7. 更新 LLM 输入字段说明，允许在 `priced_vs_new` 使用价格信号（需绑定 market url + source_type=市场行为）。
8. tokenId 来源为 `MarketContext.clob_token_ids`，选择规则：二元市场优先使用 Yes 侧 tokenId；若无法识别则取 clobTokenIds 首个并记录选择结果。
9. 历史价格若点位不足（<2）时，派生指标置空且返回结构化提示。
10. 历史价格请求按 24h 窗口、1h 颗粒度拉取；若 API 返回颗粒度不同，则在代码侧重采样到 1h。
11. 请求满足 Provider 超时/重试/退避与缓存策略要求，并对失败返回结构化错误信息。

## Tasks / Subtasks
- [x] 新增或扩展 Polymarket Pricing Provider，封装价格相关接口（AC: 1, 2, 3）  
  - [x] 参考官方文档实现 Get market price / Get midpoint price / Get price history for a traded token  
  - [x] 建议新增 `src/providers/polymarket/pricing.ts`（或等价文件）  
  [Source: architecture/providers/polymarket-pricing.md#J.3 关键接口（本 MVP 会用到）]
- [x] 定义价格信息 DTO 与 `PriceSignals`（latest/midpoint/history + 派生指标），并在 orchestrator 层可被消费（AC: 4, 5）  
  [Source: architecture/architecture-core.md#3.2 核心数据结构（内部标准化 DTO）]
- [x] 依据附录 J 公式实现 PriceSignals，并保留 `history_24h` 原始序列（AC: 4, 5）  
  [Source: architecture/providers/polymarket-pricing.md#J.4.1 PriceSignals 计算口径（必须）]
- [x] 设定 tokenId 选择规则并记录选用的 tokenId（AC: 8）  
- [x] 历史价格不足时返回可解释的结构化提示（AC: 9）  
- [x] 将 `price_context` 合并到 `MarketContext` 并在 pipeline 中可用（AC: 6）  
  [Source: architecture/architecture-core.md#4.1 主流程（单事件）]
- [x] 更新 LLM 输入字段说明与 prompt（AC: 7）  
  [Source: prd/appendices/prompts.md#G1. Report v1 生成 Prompt（输出必须纯 JSON）]
- [x] 更新 SQLite 迁移脚本，为 Event 表新增 price_* 字段（AC: 5）  
  [Source: architecture/architecture-core.md#7.2 数据表（SQLite 逻辑模型）]
- [x] 按 24h/1h 参数拉取历史价格，必要时重采样（AC: 10）  
- [x] 按 Provider 规范实现超时、重试、退避与缓存（AC: 11）  
  - [x] 仅对 `429/5xx/网络错误` 重试，最多 3 次  
  [Source: architecture/providers/provider-guidelines.md#I.1 统一的 HTTP Client 封装]  
  [Source: architecture/providers/provider-guidelines.md#I.2 缓存与去重]
- [x] 补充 Provider 级测试（200/429/字段缺失/历史不足/重采样）与 fixture（AC: 9, 10, 11）  
  [Source: architecture/providers/provider-guidelines.md#I.3 Mock 与集成测试]  
  [Source: architecture/coding-standards.md#11.5 Provider 必测的“故障注入”场景]

## Dev Notes
### Previous Story Insights
No specific guidance found in architecture docs.  
[Source: architecture/architecture-core.md]

### Data Models
- `MarketContext.price_context` 用于承载价格原始数据与派生指标。  
  [Source: architecture/architecture-core.md#3.2 核心数据结构（内部标准化 DTO）]
- `price_history_24h_json` 在 Event 表落地保存。  
  [Source: prd/appendices/notion-sheet-fields.md#H1. Event 表字段]

### API Specifications
- Polymarket Pricing API：Get market price / Get midpoint price / Get price history for a traded token。  
  [Source: architecture/providers/polymarket-pricing.md#J.3 关键接口（本 MVP 会用到）]

### Component Specifications
- Provider 必须包含超时、重试、退避与可观测性打点。  
  [Source: architecture/providers/provider-guidelines.md#I.1 统一的 HTTP Client 封装]
- Provider 输出 DTO 必须稳定且最小化，禁止穿透原始响应。  
  [Source: architecture/coding-standards.md#3.5 Provider 输出必须“最小化、稳定化”]
- 价格信号仅作为“市场行为”补充信号，使用时必须绑定 market url。  
  [Source: prd/appendices/prompts.md#G1. Report v1 生成 Prompt（输出必须纯 JSON）]

### File Locations
建议按现有结构实现/修改下列位置：  
- `src/providers/polymarket/`（新增 pricing client/mapper/policy/index）  
- `src/orchestrator/steps/market.pricing.fetch.step.ts`（价格拉取与信号计算）  
- `src/orchestrator/types.ts`（价格相关 DTO 扩展）  
- `prompts/report_v1_generate.prompt.txt`（LLM 输入字段说明）  
- `migrations/003_add_price_fields.sql`（Event 表新增价格字段）  
[Source: architecture/source-tree.md#1) 源码目录结构（AI Signal Bot）]

### Testing Requirements
- Provider 测试需包含 200/429/字段缺失三类场景，并使用 fixtures + mock。  
  [Source: architecture/providers/provider-guidelines.md#I.3 Mock 与集成测试]  
  [Source: architecture/coding-standards.md#11.5 Provider 必测的“故障注入”场景]

### Technical Constraints
- TypeScript 严格模式、ESM 模块制式，避免使用 `any`。  
  [Source: architecture/tech-stack.md#2) 语言与运行时]
- 外部请求必须设置 timeout，避免无限重试。  
  [Source: architecture/coding-standards.md#3.2 超时 / 重试 / 退避（硬性要求）]

### Project Structure Notes
Provider 实现应位于 `src/providers/polymarket/`，不应被 Orchestrator 以外层级绕过调用。  
[Source: architecture/coding-standards.md#1.2 依赖方向（必须遵守）]  
[Source: architecture/source-tree.md#1) 源码目录结构（AI Signal Bot）]

## Change Log
| Date       | Version | Description | Author |
| ---------- | ------- | ----------- | ------ |
| 2026-01-23 | 0.1     | 创建故事草稿 | Bob |
| 2026-01-23 | 0.2     | 补充 price_context 与派生指标、LLM 使用要求 | Winston |
| 2026-01-23 | 0.3     | 明确派生指标公式与历史价格落地 | Winston |
| 2026-01-23 | 0.4     | 实现 Pricing Provider 与 price_context 计算 | James |

## Dev Agent Record
### Agent Model Used
GPT-5

### Debug Log References
npm test

### Completion Notes List
- 新增 Pricing provider 与 price_context/PriceSignals 计算，支持 tokenId 选择与历史不足提示。
- 增加 Pricing step 与 prompt 更新，并补齐 pricing fixtures 与测试覆盖。

### File List
- src/providers/polymarket/pricing.ts
- src/providers/polymarket/index.ts
- src/orchestrator/steps/market.pricing.fetch.step.ts
- src/orchestrator/types.ts
- src/orchestrator/errors.ts
- prompts/report_v1_generate.prompt.txt
- tests/providers/polymarket/pricing.test.ts
- tests/orchestrator/market-pricing.step.test.ts
- tests/fixtures/polymarket/pricing-market-price.json
- tests/fixtures/polymarket/pricing-midpoint.json
- tests/fixtures/polymarket/pricing-history.json
- tests/fixtures/polymarket/pricing-history-half-hour.json

## QA Results

### Review Date: 2026-01-24

### Reviewed By: Quinn (Test Architect)

### Code Quality Assessment

实现符合 Provider 规范与 DTO 约束，价格信号计算与历史重采样逻辑清晰；关键异常与边界行为有测试覆盖。AC5/AC7 通过人工检查验证（迁移与 prompt 变更），尚无自动化用例。

### Refactoring Performed

无。

### Compliance Check

- Coding Standards: ✓（超时/重试/缓存与错误码规范一致）
- Project Structure: ✓（Provider 与 step 分层符合约束）
- Testing Strategy: ✓（包含 200/429/字段缺失/历史不足/重采样）
- All ACs Met: ✓（AC5/AC7 为人工校验）

### Improvements Checklist

- [ ] 为 prompt 变更增加轻量校验或快照测试
- [ ] 为价格迁移字段落库补充存储层测试（后续落库实现时）

### Security Review

未发现安全风险；无鉴权或敏感数据处理变更。

### Performance Considerations

信号计算为 O(n)（n 为 24h 采样点），缓存与重试策略可控。

### Files Modified During Review

无。

### Gate Status

Gate: PASS → docs/qa/gates/2.3-token-pricing.yml  
Risk profile: 未执行  
NFR assessment: 未执行

### Recommended Status

[✓ Ready for Done]
(Story owner decides final status)
