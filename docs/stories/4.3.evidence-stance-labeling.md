# Story 4.3: 证据立场标注（supports_yes/supports_no/neutral）

## Status
Done

## Story
**作为** 系统（Evidence Builder），  
**我希望** 为证据候选标注立场（支持/反对/中性），  
**以便** 后续报告生成与校验能够基于证据立场组织分歧信息。

Epic Context: 对应 Epic 4「Evidence Builder」的 E4-S3。  
[Source: prd/epic-plan.md#Epic 4：Evidence Builder]

Dependencies: E4-S1（证据合并去重）、E4-S2（来源类型标注）。  
[Source: prd/epic-plan.md#Epic 4：Evidence Builder]

## Acceptance Criteria
1. EvidenceBuilder 为每条 `evidence_candidate` 填充 `stance`，取值限定为 `supports_yes` / `supports_no` / `neutral`。  
   [Source: prd/appendices/evidence-builder.md#E4. stance（支持/反对/中性）标注]  
   [Source: prd/appendices/notion-sheet-fields.md#Evidence]
2. 当内容明确支持某一结果时标注 `supports_yes` 或 `supports_no`；无法判断或仅描述事实时标注 `neutral`。  
   [Source: prd/appendices/evidence-builder.md#E4. stance（支持/反对/中性）标注]
3. 立场标注规则需在 EvidenceBuilder 中实现（可基于规则或 LLM 简化方案），并保证在相同输入下可重复。  
   [Source: prd/appendices/evidence-builder.md#E4. stance（支持/反对/中性）标注]  
   [Source: architecture/coding-standards.md#11.8 可重复性（Determinism）要求]

## Tasks / Subtasks
- [x] Task 1：在 EvidenceBuilder 中实现 stance 标注规则（AC: 1-3）  
  [Source: prd/appendices/evidence-builder.md#E4. stance（支持/反对/中性）标注]
  - [x] Subtask 1.1：为每条证据生成 `stance` 并写入 `evidence_candidates`
  - [x] Subtask 1.2：确保相同输入下 stance 结果一致（可重复性）
- [x] Task 2：补充 stance 标注测试覆盖（AC: 1-3）  
  [Source: architecture/tech-stack.md#9) 测试策略]  
  [Source: architecture/coding-standards.md#11.3 单元测试范围（必须覆盖“各种情况”)]  
  [Source: architecture/coding-standards.md#11.8 可重复性（Determinism）要求]
  - [x] Subtask 2.1：单测覆盖 supports_yes / supports_no / neutral 的判定路径
  - [x] Subtask 2.2：单测覆盖无法判断时的 neutral 默认

## Dev Notes
### Previous Story Insights
No specific guidance found in architecture docs.  
[Source: architecture/architecture-core.md]

### Data Models
- `EvidenceCandidate` 含 `stance` 字段。  
  [Source: architecture/architecture-core.md#3.2 核心数据结构（内部标准化 DTO）]
- Evidence 最小字段包含 `stance`，用于表示证据立场。  
  [Source: architecture/coding-standards.md#5.2 证据（Evidence）必须带来源与归因]
- Evidence 表包含 `stance` 字段并与 evidence_candidates 对齐。  
  [Source: architecture/architecture-core.md#7.2 数据表（SQLite 逻辑模型）]

### API Specifications
- EvidenceBuilder 位于 Tavily 检索之后，产出 evidence_candidates 供后续步骤使用。  
  [Source: architecture/architecture-core.md#4.1 主流程（单事件）]

### Component Specifications
- Step 文件命名与顺序编排仅在 `pipeline.ts` 声明；Step 需实现统一接口（`id`/`run`/`requires`/`produces`）。  
  [Source: architecture/coding-standards.md#2.1 Step 文件命名与顺序编排]  
  [Source: architecture/coding-standards.md#2.2 Step 统一接口（强约束）]

### File Locations
建议按现有结构实现/修改下列位置：  
- `src/orchestrator/steps/evidence.build.step.ts`（EvidenceBuilder step）  
- `src/orchestrator/types.ts`（EvidenceCandidate DTO）  
- `src/storage/sqlite/evidence.repo.ts`（Evidence 表落地）  
[Source: architecture/source-tree.md#1) 源码目录结构（AI Signal Bot）]

### Testing Requirements
- 单元测试需覆盖 stance 判定与边界情况。  
  [Source: architecture/tech-stack.md#9) 测试策略]  
  [Source: architecture/coding-standards.md#11.3 单元测试范围（必须覆盖“各种情况”）]
- 测试需保证可重复性（固定时间/随机）。  
  [Source: architecture/coding-standards.md#11.8 可重复性（Determinism）要求]

### Technical Constraints
- Node.js 18+/20、TypeScript strict、ESM 模块制式。  
  [Source: architecture/tech-stack.md#2) 语言与运行时]

### Project Structure Notes
- `docs/architecture/unified-project-structure.md` 未找到；使用 `docs/architecture/source-tree.md` 作为目录结构依据。  
  [Source: architecture/source-tree.md#1) 源码目录结构（AI Signal Bot）]
- `docs/architecture/testing-strategy.md` 未找到；使用 `tech-stack.md` 与 `coding-standards.md` 中测试策略说明。  
  [Source: architecture/tech-stack.md#9) 测试策略]  
  [Source: architecture/coding-standards.md#11.3 单元测试范围（必须覆盖“各种情况”）]

## Change Log
| Date       | Version | Description | Author |
| ---------- | ------- | ----------- | ------ |
| 2026-01-26 | 0.1     | 创建故事草稿 | Bob    |
| 2026-01-26 | 0.2     | 提升为 Approved | Bob    |
| 2026-01-27 | 0.3     | 实现证据立场标注与测试覆盖 | James |
| 2026-01-27 | 0.4     | 处理否定短语优先级并补充测试 | James |

## Dev Agent Record
### Agent Model Used
- GPT-5

### Debug Log References
- `npm test -- tests/orchestrator/evidence-build.step.test.ts tests/orchestrator/pipeline-query-plan.step.test.ts`
- `npm test -- tests/orchestrator/evidence-build.step.test.ts`

### Completion Notes List
- 在 EvidenceBuilder 中基于规则为 claim 生成 supports_yes/supports_no/neutral 立场，保持确定性输出。
- 补充单测覆盖明确肯定/否定措辞与无法判断的 neutral 默认。
- 调整 EvidenceStance 类型与相关用例数据以匹配新的立场取值。
- 处理否定短语与肯定关键词冲突时的优先级，确保明确否定被标记为 supports_no。

### File List
- src/orchestrator/steps/evidence.build.step.ts
- src/orchestrator/types.ts
- tests/orchestrator/evidence-build.step.test.ts
- tests/orchestrator/pipeline-query-plan.step.test.ts

## QA Results

### Review Date: 2026-01-27

### Reviewed By: Quinn (Test Architect)

### Code Quality Assessment
- 立场规则为确定性关键词/短语判定，符合可重复性；否定短语优先级已覆盖“won't / not expected”类冲突场景。
- 故事状态当前为 Done 而非 Review（流程提示），不影响本次技术验证结论。

### Refactoring Performed
- None.

### Compliance Check
- Coding Standards: ✓（确定性、无随机）
- Project Structure: ✓（修改集中于 EvidenceBuilder/类型/测试）
- Testing Strategy: ✓（单测覆盖 supports_yes/supports_no/neutral 与否定优先）
- All ACs Met: ✓

### Improvements Checklist
- [ ] 增加中文/多语言关键词以提升非英语事件的立场判定覆盖
- [ ] 增加双重否定/引用语境的边界用例测试

### Security Review
- 未发现安全相关问题（本次改动无鉴权/敏感数据路径）。

### Performance Considerations
- 规则匹配为 O(n) 词表查找，成本可忽略；未引入新 I/O。

### Files Modified During Review
- None.

### Gate Status
Gate: PASS → docs/qa/gates/4.3-evidence-stance-labeling.yml
Risk profile: docs/qa/assessments/4.3-risk-20260127.md (not run)
NFR assessment: docs/qa/assessments/4.3-nfr-20260127.md (not run)

### Recommended Status
[✓ Ready for Done] / [✗ Changes Required - See unchecked items above]
(Story owner decides final status)
