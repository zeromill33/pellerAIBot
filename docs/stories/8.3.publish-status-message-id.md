# Story 8.3: 记录发布状态与 message_id 回执

## Status
Review

## Story
**As a** 运营（Operator），
**I want** 系统在 TG 发布后记录发布状态与 message_id 回执，
**so that** 发布过程可审计、可追踪、可回查。

## Context
本故事属于 Epic 8「渲染与 Telegram 发布」，在发布成功后把关键审计信息落地到存储层，确保后续 /status 回查与运营审计可用。

## Acceptance Criteria
1. 发布成功后将 `status` 更新为 `published`，并保存 `message_id`。
2. 发布失败或被阻断时，记录对应状态与原因码（validator_code 或 publish error）。
3. 发布状态更新与 report 记录关联到同一 `slug`，可被后续查询接口使用。
4. 日志中包含 request_id/run_id/slug 等关键字段以支持审计追踪；若可获取 message_id，建议记录。

## Tasks / Subtasks
- [x] Task 1：在 Storage 层实现/完善发布状态更新与 message_id 持久化（AC: 1, 2, 3）。[Source: architecture/architecture-core.md#6.2 TelegramPublisher（落地后/可审核）][Source: architecture/architecture-core.md#7.2 数据表（SQLite 逻辑模型）]
  - [x] `updateReport(status=published, message_id)` 或等价方法落地到 Report 表。[Source: architecture/architecture-core.md#7.2 数据表（SQLite 逻辑模型）]
- [x] Task 2：在 Orchestrator 发布 step 中写入状态与回执（AC: 1, 2, 3）。[Source: architecture/architecture-core.md#4.1 主流程（单事件）]
  - [x] 发布成功后写入 `message_id`；失败则写入失败状态与原因码。[Source: architecture/architecture-core.md#4.1 主流程（单事件）]
- [x] Task 3：记录审计日志字段（AC: 4）。[Source: architecture/coding-standards.md#9.1 结构化日志（必须）]
  - [x] 日志字段包含 `request_id/run_id/event_slug/message_id` 与 step 信息。[Source: architecture/coding-standards.md#2.3 数据项目必须具备：幂等与可回放]
- [x] Task 4：补齐测试（AC: 1, 2, 3, 4）。[Source: architecture/tech-stack.md#9) 测试策略][Source: architecture/coding-standards.md#11.3 单元测试范围（必须覆盖“各种情况”）]
  - [x] 单元测试：Report 表状态更新与 message_id 持久化。
  - [x] 集成测试：发布成功/失败路径下状态变更与原因码记录。
  - [x] 日志字段包含关键审计字段（可用 logger mock 验证）。

## Dev Notes
### Previous Story Insights
- 依赖 8.2：发布流程已能返回 message_id。

### Data Models
- Report 表包含 `status`、`validator_code`、`validator_message`、`tg_message_id` 等字段。[Source: architecture/architecture-core.md#7.2 数据表（SQLite 逻辑模型）]

### API Specifications
- StorageAdapter 需提供更新发布状态与 message_id 的接口能力（例如 `updateReportStatus`）。[Source: architecture/architecture-core.md#3.1 Provider 接口清单（概览）]

### Component Specifications
- 发布状态更新应发生在发布 step 完成后，并回写到 Report 表。
[Source: architecture/architecture-core.md#4.1 主流程（单事件）]

### File Locations
- `src/storage/sqlite/report.repo.ts`
- `src/storage/index.ts`
- `src/orchestrator/steps/telegram.publish.step.ts`
- `src/obs/logger.ts`
[Source: architecture/source-tree.md#storage][Source: architecture/source-tree.md#orchestrator][Source: architecture/source-tree.md#utils]

### Testing Requirements
- 单元测试：Report 状态更新、message_id 落库。
- 集成测试：发布成功/失败路径状态回写。
- 日志字段覆盖 request_id/run_id/slug/message_id。
[Source: architecture/coding-standards.md#9.1 结构化日志（必须）][Source: architecture/coding-standards.md#11.3 单元测试范围（必须覆盖“各种情况”）]

### Technical Constraints
- 结构化日志必须包含审计字段；存储更新需与发布结果一致。
[Source: architecture/coding-standards.md#9.1 结构化日志（必须）]
- Storage 仅负责读写，不做业务决策。
[Source: architecture/coding-standards.md#10.1 Repo 只做读写，不做业务决策]

### Project Structure Notes
- 未发现与项目结构约定冲突。
[Source: architecture/source-tree.md#1) 源码目录结构（AI Signal Bot）]

## Testing
- 单元测试：状态更新与 message_id 持久化。
- 集成测试：发布成功/失败路径。
- 日志字段审计覆盖。

## Change Log
| Date | Version | Description | Author |
| --- | --- | --- | --- |
| 2026-01-29 | v0.1 | 初始草稿 | Bob |
| 2026-01-29 | v0.2 | 调整日志字段要求为可追踪且可选记录 message_id | Sarah |
| 2026-01-29 | v1.0 | 完成发布状态回写与失败记录 | James |

## Dev Agent Record
### Agent Model Used
GPT-5 (Codex CLI)

### Debug Log References
- npm test -- tests/orchestrator/publish-strategy.test.ts tests/storage/report.repo.test.ts
- npm run build
- npm test

### Completion Notes List
- 发布成功时回写 status=published + tg_message_id。
- 发布失败时回写 status=blocked 与原因码/消息。
- 增加发布成功/失败路径与存储更新测试。
- 全量 build/test 已通过。

### File List
- src/storage/sqlite/report.repo.ts
- src/storage/sqlite/index.ts
- src/orchestrator/steps/telegram.publish.step.ts
- src/orchestrator/pipeline.ts
- tests/orchestrator/publish-strategy.test.ts
- tests/storage/report.repo.test.ts
- docs/stories/8.3.publish-status-message-id.md

## QA Results
### Review Date: 2026-01-29

### Reviewed By: Quinn (Test Architect)

### Code Quality Assessment
发布成功/失败路径均有状态回写与原因码记录，日志字段齐全，整体实现清晰可维护。

### Refactoring Performed
无。

### Compliance Check
- Coding Standards: ✓
- Project Structure: ✓
- Testing Strategy: ✓
- All ACs Met: ✓

### Improvements Checklist
- [x] 发布失败路径状态回写与原因码覆盖（tests/orchestrator/publish-strategy.test.ts）
- [x] Report 状态更新存储单测（tests/storage/report.repo.test.ts）
- [ ] 可选：将发布失败状态与 validator_code 之外的 publish error 字段拆分（当前复用 validator_code 字段）

### Security Review
未发现安全问题；存储写入未引入新敏感数据。

### Performance Considerations
状态回写为单条 UPDATE，性能风险低。

### Files Modified During Review
无（仅评审，未改代码）。

### Gate Status
Gate: PASS → docs/qa/gates/8.3-publish-status-message-id.yml  
Risk profile: docs/qa/assessments/8.3-risk-20260129.md  
NFR assessment: docs/qa/assessments/8.3-nfr-20260129.md

### Recommended Status
[✓ Ready for Done]
