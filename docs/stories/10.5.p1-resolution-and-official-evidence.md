# Story 10.5: P1 结算规则结构化 + 官方抓取（Official Evidence）

## Status
Approved

## Story
**作为** 系统（Resolver/Validator/LLM 输入管道），  
**我希望** 结构化结算规则并抓取官方 resolver 页面形成官方证据，  
**以便** 报告具备可检查的判定标准与权威证据来源。

Epic Context: Epic 10「报告质量优化（P0/P1）」的 P1 结算规则结构化与官方证据。  
[Source: architecture/report_quality_P0_P1_implementation.md#P1-3 Resolution Rules 结构化 + 官方 resolver 抓取]

Dependencies: 依赖 MarketContext 中 `resolution_rules_raw` 与 `resolution_source_raw` 可用。  
[Source: architecture/architecture-core.md#3.2 核心数据结构（内部标准化 DTO）]

## Acceptance Criteria
1. 新增 `resolution.parse.step.ts`，从 `resolution_rules_raw` 中解析至少：`deadline_ts`、`resolver_url`、`partial_shutdown_counts`、`exclusions[]` 等结构化字段，并注入到 Report v1 JSON 的 `context.resolution_structured`。  
   [Source: architecture/report_quality_P0_P1_implementation.md#P1-3 Resolution Rules 结构化 + 官方 resolver 抓取]
2. 新增 `official.fetch.step.ts`，抓取 `resolver_url` 并生成 `official_sources[]`（`url/domain/title/published_at/snippet`），写入 Report v1 JSON；抓取失败需返回可审计错误原因，不得生成虚构 evidence。  
   [Source: architecture/report_quality_P0_P1_implementation.md#P1-3 Resolution Rules 结构化 + 官方 resolver 抓取]  
   [Source: architecture/coding-standards.md#4.3 反幻觉策略（必须落地）]
3. Validator 新增规则：`context.resolution_structured` 或 `official_sources` 至少其一存在；否则阻断并返回 `VALIDATOR_MISSING_OFFICIAL_SOURCE`。  
   [Source: architecture/report_quality_P0_P1_implementation.md#P1-3 Resolution Rules 结构化 + 官方 resolver 抓取]
4. 为解析与抓取补充单元测试（解析字段、抓取失败路径、validator 规则）。  
   [Source: architecture/coding-standards.md#11.3 单元测试范围（必须覆盖“各种情况”)]

## Tasks / Subtasks
- [ ] Task 1：实现 resolution 结构化解析（AC: 1）  
  [Source: architecture/source-tree.md#1) 源码目录结构（AI Signal Bot）]
  - [ ] Subtask 1.1：新增 `src/orchestrator/steps/resolution.parse.step.ts` 并写入解析结果到 ctx
  - [ ] Subtask 1.2：更新 `src/validator/schema/report_v1.schema.json`，在 `context` 下新增 `resolution_structured` 字段
  - [ ] Subtask 1.3：更新 `prompts/report_v1_generate.prompt.txt` 与 LLM 后处理以输出 `context.resolution_structured`
  - [ ] Subtask 1.4：解析失败时返回可审计错误原因
- [ ] Task 2：实现官方 resolver 抓取（AC: 2）  
  [Source: architecture/source-tree.md#1) 源码目录结构（AI Signal Bot）]
  - [ ] Subtask 2.1：新增 `src/orchestrator/steps/official.fetch.step.ts` 抓取并生成 `official_sources[]`
  - [ ] Subtask 2.2：更新 schema/prompt/后处理，确保 `official_sources` 进入 Report v1 JSON
  - [ ] Subtask 2.3：抓取失败需返回明确错误与降级策略（不虚构证据）
- [ ] Task 3：Validator 新规则（AC: 3）  
  [Source: architecture/report_quality_P0_P1_implementation.md#P1-3 Resolution Rules 结构化 + 官方 resolver 抓取]
  - [ ] Subtask 3.1：在 `src/validator/gates.ts` 增加 `official_sources` 或 `resolution_structured` 必须存在的规则
  - [ ] Subtask 3.2：在 `src/orchestrator/errors.ts` 新增 `VALIDATOR_MISSING_OFFICIAL_SOURCE`
- [ ] Task 4：测试覆盖（AC: 4）  
  [Source: architecture/coding-standards.md#11.3 单元测试范围（必须覆盖“各种情况”)]
  - [ ] Subtask 4.1：解析字段的成功/失败用例
  - [ ] Subtask 4.2：official fetch 失败路径与 validator 规则覆盖

## Dev Notes
### Previous Story Insights
当前最高 story 10.4 为 Draft（非 Done），存在流程风险但不阻断本条起草。  
[Source: architecture/architecture-core.md#4.1 主流程（单事件）]

### Data Models
- `MarketContext` 含 `resolution_rules_raw` 与可能的 `resolution_source_raw`。  
  [Source: architecture/architecture-core.md#3.2 核心数据结构（内部标准化 DTO）]

### API Specifications
- 新增 step 需由 `pipeline.ts` 统一编排。  
  [Source: architecture/coding-standards.md#2.1 Step 文件命名与顺序编排]

### Component Specifications
- 证据来源 `source_type` 需与现有五选一保持一致，官方证据使用 `official`。  
  [Source: architecture/coding-standards.md#5.2 证据（Evidence）必须带来源与归因]

### File Locations
- `src/orchestrator/steps/resolution.parse.step.ts`（新增）  
  [Source: architecture/source-tree.md#1) 源码目录结构（AI Signal Bot）]
- `src/orchestrator/steps/official.fetch.step.ts`（新增）  
  [Source: architecture/source-tree.md#1) 源码目录结构（AI Signal Bot）]
- `src/orchestrator/pipeline.ts`：主流程编排。  
  [Source: architecture/source-tree.md#1) 源码目录结构（AI Signal Bot）]
- `src/validator/gates.ts` 与 `src/orchestrator/errors.ts`：新增规则与错误码。  
  [Source: architecture/source-tree.md#1) 源码目录结构（AI Signal Bot）]

### Project Structure Notes
未找到 `docs/architecture/unified-project-structure.md` 与 `docs/architecture/testing-strategy.md`，本 story 以 `source-tree.md` 与 `coding-standards.md` 为结构/测试依据。  
[Source: architecture/source-tree.md#1) 源码目录结构（AI Signal Bot）]  
[Source: architecture/coding-standards.md#11. 测试与质量门禁（必须更严格：build 通过 + 单测覆盖 + 外部依赖集成测试）]

### Testing Requirements
- 单元测试必须覆盖分支/边界/错误路径，建议表驱动用例。  
  [Source: architecture/coding-standards.md#11.3 单元测试范围（必须覆盖“各种情况”)]
- 测试需可重复，避免依赖外网。  
  [Source: architecture/coding-standards.md#11.8 可重复性（Determinism）要求]

## Change Log
| Date       | Version | Description | Author |
| ---------- | ------- | ----------- | ------ |
| 2026-01-30 | v0.1    | 初稿（P1 结算规则结构化 + 官方抓取） | Bob (SM) |

## Dev Agent Record
### Agent Model Used

### Debug Log References

### Completion Notes List

### File List

## QA Results
