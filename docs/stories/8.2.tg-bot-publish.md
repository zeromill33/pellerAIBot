# Story 8.2: TG Bot 发布并默认关闭预览（落地后/审核通过后）

## Status
Review

## Story
**As a** 运营（Operator），
**I want** 系统在报告落地并通过校验后由 TG Bot 发布到指定 Channel，且默认关闭网页预览，
**so that** 发布流程可控、信息不刷屏，并能按策略自动或经运营确认后发布。

## Context
本故事属于 Epic 8「渲染与 Telegram 发布」，承接渲染结果，将已落地且通过 Validator 的内容发布到 Telegram Channel，并遵循发布策略与默认参数（如关闭预览）。

## Acceptance Criteria
1. 仅在报告已落地且 Validator 通过后触发发布流程。
2. 发布到指定 Channel，`disable_web_page_preview=true` 默认生效。
3. `parse_mode` 按配置传入发布调用。
4. 支持“自动发布”或“运营确认后发布”的策略开关（发布前置条件）。
5. 发布成功返回 `message_id`，用于后续追踪与审计。

## Tasks / Subtasks
- [x] Task 1：实现/完善 Telegram Publisher（AC: 1, 2, 3, 5）。[Source: architecture/architecture-core.md#6.2 TelegramPublisher（落地后/可审核）][Source: architecture/source-tree.md#providers]
  - [x] `publishToChannel(text, options)` 支持 `parse_mode` 与 `disable_preview` 参数。[Source: architecture/architecture-core.md#6.2 TelegramPublisher（落地后/可审核）]
  - [x] 发布后返回 `message_id` 并上送后续流程使用。[Source: architecture/architecture-core.md#6.2 TelegramPublisher（落地后/可审核）]
- [x] Task 2：在 Orchestrator 中确保发布前置条件（落地 + Validator 通过）与策略开关（AC: 1, 4）。[Source: architecture/architecture-core.md#4.1 主流程（单事件）]
  - [x] 若启用运营确认，发布前等待确认流程（由入口层触发 approve）。[Source: architecture/architecture-core.md#4.1 主流程（单事件）]
- [x] Task 3：默认关闭网页预览，并确保配置可覆盖（AC: 2）。[Source: architecture/architecture-core.md#6.2 TelegramPublisher（落地后/可审核）][Source: architecture/tech-stack.md#4.3 Publisher：Telegram]
- [x] Task 4：处理发布速率限制与 429 重试（AC: 5）。[Source: architecture/providers/telegram.md#D.2 速率限制（必须实现）]
- [x] Task 5：补齐测试（AC: 1, 2, 3, 4, 5）。[Source: architecture/tech-stack.md#9) 测试策略][Source: architecture/coding-standards.md#11.3 单元测试范围（必须覆盖“各种情况”）]
  - [x] 单元测试：发布参数（parse_mode/disable_preview）与返回 `message_id` 的处理。[Source: architecture/architecture-core.md#6.2 TelegramPublisher（落地后/可审核）]
  - [x] 集成测试：发布前置条件与策略开关（自动 vs 运营确认）。[Source: architecture/architecture-core.md#4.1 主流程（单事件）]
  - [x] 故障注入：429 `retry_after` 重试策略验证。[Source: architecture/providers/telegram.md#D.2 速率限制（必须实现）]

## Dev Notes
### Previous Story Insights
- 无（未发现前置故事记录）。

### Data Models
- 发布成功需返回 `message_id` 并回写存储状态用于审计追踪。[Source: architecture/architecture-core.md#6.2 TelegramPublisher（落地后/可审核）]

### API Specifications
- `publishToChannel(text, options) -> {message_id}`（Publisher 接口）。[Source: architecture/architecture-core.md#3.1 Provider 接口清单（概览）]

### Component Specifications
- Publisher 实现位于 `src/providers/telegram/publisher.ts`，由 `TelegramPublisher` 对外提供发布能力。[Source: architecture/source-tree.md#providers]
- 发布 step 位于 `src/orchestrator/steps/telegram.publish.step.ts`，需由 pipeline 调度。[Source: architecture/source-tree.md#orchestrator]
- 默认关闭预览、parse_mode 配置化。[Source: architecture/architecture-core.md#6.2 TelegramPublisher（落地后/可审核）]

### File Locations
- `src/providers/telegram/publisher.ts`
- `src/providers/telegram/index.ts`
- `src/orchestrator/steps/telegram.publish.step.ts`
- `src/config/*`（parse_mode/disable_preview 等配置）
[Source: architecture/source-tree.md#providers][Source: architecture/source-tree.md#orchestrator][Source: architecture/tech-stack.md#3.2 目录建议（与 TDD 对齐）]

### Testing Requirements
- 单元测试：Publisher 参数与返回值处理；默认关闭预览。
- 集成测试：发布前置条件与运营确认开关路径。
- 429 重试测试（含 retry_after）。
[Source: architecture/providers/telegram.md#D.2 速率限制（必须实现）][Source: architecture/coding-standards.md#11.5 Provider 必测的“故障注入”场景]

### Technical Constraints
- 发布前必须通过 Validator 且报告已落地；禁止绕过 Validator 直接发布。
[Source: architecture/coding-standards.md#1.1 分层定义（本项目版）][Source: architecture/architecture-core.md#5.1 两层校验]
- Provider 需实现限流/重试边界与队列化处理。
[Source: architecture/providers/telegram.md#D.2 速率限制（必须实现）]

### Project Structure Notes
- 未发现与项目结构约定冲突。
[Source: architecture/source-tree.md#1) 源码目录结构（AI Signal Bot）]

## Testing
- 单元测试：publish 参数与 message_id 处理、默认关闭预览。
- 集成测试：自动发布 vs 运营确认流程分支。
- 429 重试策略与队列间隔行为验证。

## Change Log
| Date | Version | Description | Author |
| --- | --- | --- | --- |
| 2026-01-29 | v0.1 | 初始草稿 | Bob |
| 2026-01-29 | v0.2 | PO 验收通过（无内容变更） | Sarah |
| 2026-01-29 | v1.0 | 完成发布队列与重试实现及测试 | James |

## Dev Agent Record
### Agent Model Used
GPT-5 (Codex CLI)

### Debug Log References
- npm test -- tests/providers/telegram/publisher.test.ts
- npm run build
- npm test

### Completion Notes List
- 增加 Telegram 发布队列、最小间隔与 429 重试处理（含 retry_after）。 
- 覆盖发布参数与重试/队列行为的单元测试。
- 全量 build/test 已通过。

### File List
- src/providers/telegram/index.ts
- tests/providers/telegram/publisher.test.ts
- docs/stories/8.2.tg-bot-publish.md

## QA Results
### Review Date: 2026-01-29

### Reviewed By: Quinn (Test Architect)

### Code Quality Assessment
发布实现符合分层边界，具备最小间隔队列与 429 重试，参数化 parse_mode/disable_web_page_preview，整体质量良好。

### Refactoring Performed
无。

### Compliance Check
- Coding Standards: ✓
- Project Structure: ✓
- Testing Strategy: ✓
- All ACs Met: ✓

### Improvements Checklist
- [x] 覆盖发布参数与返回 message_id 的单测（tests/providers/telegram/publisher.test.ts）
- [x] 覆盖 429 retry_after 重试与队列间隔（tests/providers/telegram/publisher.test.ts）
- [ ] 可选：将队列最小间隔/重试参数纳入配置（目前为构造参数，未暴露配置）

### Security Review
未发现安全问题；bot token 仍通过环境变量读取，未引入新敏感配置。

### Performance Considerations
单进程队列 + 最小间隔可避免速率限制；重试策略可控。

### Files Modified During Review
无（仅评审，未改代码）。

### Gate Status
Gate: PASS → docs/qa/gates/8.2-tg-bot-publish.yml  
Risk profile: docs/qa/assessments/8.2-risk-20260129.md  
NFR assessment: docs/qa/assessments/8.2-nfr-20260129.md

### Recommended Status
[✓ Ready for Done]
