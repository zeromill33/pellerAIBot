# Story 3.2: Tavily 检索与 raw_content 采集

## Status
Approved

## Story
**作为** 系统（Tavily Provider / Search Step），  
**我希望** 基于 Query Plan 执行 Tavily A/B/C 多车道检索并采集 `raw_content`，  
**以便** Evidence Builder 与 LLM 拿到结构化、可追溯的证据上下文。

Epic Context: 对应 Epic 3「Tavily 多车道检索」的 E3-S2。  
[Source: prd/epic-plan.md#Epic 3：Tavily 多车道检索]

Dependencies: E3-S1（Query Plan 生成）、E2-S1（MarketContext）。  
[Source: prd/epic-plan.md#Epic 3：Tavily 多车道检索]

## Acceptance Criteria
1. `search.tavily` step 读取 Query Plan 的 A/B/C 车道查询，并按 pipeline 顺序执行（D 车道不在本故事内启用）。  
   [Source: architecture/architecture-core.md#4.1 主流程（单事件）]  
   [Source: prd/appendices/tavily-query-generator.md#D1 车道定义（Week 1 默认 A+B+C，D 条件触发）]
2. Tavily 调用使用 `POST /search` + Bearer Token 鉴权，并采用配置化参数：`search_depth`、`max_results`、`include_raw_content`、`include_answer`、`auto_parameters`。  
   [Source: architecture/providers/tavily.md#C.1 Base URL 与鉴权]  
   [Source: architecture/providers/tavily.md#C.2 核心参数（MVP 推荐值）]  
   [Source: prd/appendices/config.md#tavily]
3. 搜索结果必须映射为 `TavilyLaneResult`，其中每条 result 包含 `title`、`url`、`domain`、`published_at`、`raw_content`，并保留 `lane` 与 `query`。  
   [Source: architecture/architecture-core.md#3.2 核心数据结构（内部标准化 DTO）]  
   [Source: prd/appendices/prompts.md#G1. Report v1 生成 Prompt（输出必须纯 JSON）]
4. `raw_content` 采集在本故事范围内必须可用（用于后续 Evidence/LLM），并与 Query Plan 的 A/B/C 一一对应。  
   [Source: prd/appendices/prompts.md#G1. Report v1 生成 Prompt（输出必须纯 JSON）]
5. Tavily 全局限流（qps/burst）与缓存键策略（`event_slug + day + lane + query_hash`，TTL=1d）必须在调用路径中生效，并可记录 cache hit。  
   [Source: architecture/architecture-core.md#8.2 Tavily 全局速率]  
   [Source: architecture/architecture-core.md#8.3 缓存键策略（与 PRD 附录 A 一致）]
6. 失败需标准化为 `AppError`（含 code/category/retryable），并对 429/5xx/timeout 做可重试策略。  
   [Source: architecture/coding-standards.md#6.1 统一 AppError]  
   [Source: architecture/coding-standards.md#3.2 超时 / 重试 / 退避（硬性要求）]
7. 结构化日志必须包含 `step_id`、`request_id`、`run_id`、`event_slug`、`provider`、`latency_ms`、`cache_hit`、`rate_limited`。  
   [Source: architecture/coding-standards.md#9.1 结构化日志（必须）]
8. 本故事采用 PRD/配置示例的默认值：`include_raw_content=true`，如需覆盖以配置为准。  
   [Source: prd/appendices/config.md#tavily]  
   [Source: architecture/providers/tavily.md#C.2 核心参数（MVP 推荐值）]

## Tasks / Subtasks
- [ ] Task 1：实现/更新 `search.tavily` step 执行 A/B/C 多车道检索（AC: 1, 3, 4）  
  [Source: architecture/source-tree.md#1) 源码目录结构（AI Signal Bot）]  
  [Source: architecture/coding-standards.md#2.1 Step 文件命名与顺序编排]
  - [ ] Subtask 1.1：读取 Query Plan 的 A/B/C 查询并按车道执行（D 车道不启用）
  - [ ] Subtask 1.2：将结果映射为 `TavilyLaneResult`（含 `raw_content`）并写入 ctx
  - [ ] Subtask 1.3：如需，更新 `src/orchestrator/types.ts` 中 tavily 结果 DTO
- [ ] Task 2：落地 Tavily Provider 调用、限流与缓存（AC: 2, 5, 6）  
  [Source: architecture/providers/tavily.md#C.1 Base URL 与鉴权]  
  [Source: architecture/coding-standards.md#3.2 超时 / 重试 / 退避（硬性要求）]  
  [Source: architecture/architecture-core.md#8.2 Tavily 全局速率]  
  [Source: architecture/architecture-core.md#8.3 缓存键策略（与 PRD 附录 A 一致）]
  - [ ] Subtask 2.1：在 Tavily client 中实现 `POST /search` 与鉴权、超时、可重试策略
  - [ ] Subtask 2.2：实现缓存键 `event_slug + day + lane + query_hash` 与 TTL=1d，并记录 cache_hit
  - [ ] Subtask 2.3：对 429/5xx/timeout 统一为 `AppError` 并标记 retryable
- [ ] Task 3：补充结构化日志与指标字段（AC: 7）  
  [Source: architecture/coding-standards.md#9.1 结构化日志（必须）]
  - [ ] Subtask 3.1：在 step 级别输出结构化日志（含 provider、latency、cache_hit、rate_limited）
- [ ] Task 4：补充测试覆盖 Tavily provider 与 step 行为（AC: 1-7）  
  [Source: architecture/tech-stack.md#9) 测试策略]  
  [Source: architecture/coding-standards.md#11.4 Provider 集成测试（外部依赖：必须有“可回放”测试）]
  - [ ] Subtask 4.1：使用 fixtures 覆盖 A/B/C 查询结果映射与 `raw_content` 保留
  - [ ] Subtask 4.2：覆盖缓存命中与限流行为
  - [ ] Subtask 4.3：覆盖 429/5xx/timeout 的 `AppError` 与 retryable 标记

## Dev Notes
### Previous Story Insights
No specific guidance found in architecture docs.  
[Source: architecture/architecture-core.md]

### Data Models
- `TavilyLaneResult` 包含 `lane`、`query`、`results[{title,url,domain,published_at,raw_content}]`。  
  [Source: architecture/architecture-core.md#3.2 核心数据结构（内部标准化 DTO）]

### API Specifications
- `SearchProvider` 提供 `search`/`batchSearch` 接口，Week 1 使用 Tavily。  
  [Source: architecture/architecture-core.md#3.1 Provider 接口清单（概览）]
- 主流程在 QueryStrategy 之后执行 Tavily 多车道检索。  
  [Source: architecture/architecture-core.md#4.1 主流程（单事件）]

### Component Specifications
- Tavily 调用采用 `POST /search`，鉴权使用 `Authorization: Bearer tvly-...`。  
  [Source: architecture/providers/tavily.md#C.1 Base URL 与鉴权]
- Tavily 核心参数：`query`、`search_depth`、`max_results`、`include_raw_content`、`include_answer`。  
  [Source: architecture/providers/tavily.md#C.2 核心参数（MVP 推荐值）]
- 默认 A/B/C 三车道；D 为条件触发且需执行 2–3 类查询。  
  [Source: architecture/providers/tavily.md#C.3 多查询 vs 单查询：如何“既有效又省额度”]
- Tavily 全局限流 qps/burst 与缓存 TTL=1d，缓存键 `event_slug + day + lane + query_hash`。  
  [Source: architecture/architecture-core.md#8.2 Tavily 全局速率]  
  [Source: architecture/architecture-core.md#8.3 缓存键策略（与 PRD 附录 A 一致）]

### Parameter Decision
- `include_raw_content` 采用 PRD/配置示例默认值 `true`；架构附录建议 Week 1 默认 `false`，此处以 PRD 为准并记录冲突。  
  [Source: prd/appendices/config.md#tavily]  
  [Source: architecture/providers/tavily.md#C.2 核心参数（MVP 推荐值）]

### Environment Variables
- `TAVILY_API_KEY` 仅通过环境变量注入（不写入 repo/日志/DB），并在配置加载时绑定到 Tavily 相关配置字段。  
  [Source: architecture/coding-standards.md#7.2 Secrets 管理]  
  [Source: architecture/architecture-core.md#9 安全与合规（Week 1 必须做到的“底线”）]  
  [Source: prd/appendices/config.md#tavily]

### File Locations
建议按现有结构实现/修改下列位置：  
- `src/orchestrator/steps/search.tavily.step.ts`（Tavily 多车道检索 step）  
- `src/providers/tavily/client.ts`（Tavily HTTP client）  
- `src/providers/tavily/cache.ts`（Tavily 缓存键与缓存逻辑）  
- `src/providers/tavily/index.ts`（TavilyProvider 实现）  
- `src/config/defaults.ts`、`src/config/config.schema.ts`（Tavily 配置默认值）  
[Source: architecture/source-tree.md#1) 源码目录结构（AI Signal Bot）]

### Testing Requirements
- Provider 集成测试使用 fixtures，并覆盖缓存/限流/错误路径。  
  [Source: architecture/coding-standards.md#11.4 Provider 集成测试（外部依赖：必须有“可回放”测试）]
- 测试需保证可重复性（固定时间/随机）。  
  [Source: architecture/coding-standards.md#11.8 可重复性（Determinism）要求]
- E2E：按 `docs/stories/9.5.e2e-pipeline-regression.md` 的入口与规范执行，在 fake providers 的 E2E 路径中覆盖 A/B/C 车道执行与 `raw_content` 传递，确保 step 输出可观测。  
  [Source: docs/stories/9.5.e2e-pipeline-regression.md#Acceptance Criteria]  
  [Source: architecture/coding-standards.md#11.7 端到端 E2E（最小 smoke，保证“交互闭环”）]  
  [Source: prd/appendices/prompts.md#G1. Report v1 生成 Prompt（输出必须纯 JSON）]

### Technical Constraints
- TypeScript 严格模式、ESM 模块制式。  
  [Source: architecture/tech-stack.md#2) 语言与运行时]
- 外部请求必须设置超时与重试边界。  
  [Source: architecture/coding-standards.md#3.2 超时 / 重试 / 退避（硬性要求）]

### Project Structure Notes
- `docs/architecture/unified-project-structure.md` 未找到；使用 `docs/architecture/source-tree.md` 作为目录结构依据。  
  [Source: architecture/source-tree.md#1) 源码目录结构（AI Signal Bot）]
- `docs/architecture/testing-strategy.md` 未找到；使用 `tech-stack.md` 与 `coding-standards.md` 中的测试策略说明。  
  [Source: architecture/tech-stack.md#9) 测试策略]  
  [Source: architecture/coding-standards.md#11.4 Provider 集成测试（外部依赖：必须有“可回放”测试）]

## Change Log
| Date       | Version | Description | Author |
| ---------- | ------- | ----------- | ------ |
| 2026-01-24 | 0.1     | 创建故事草稿 | Bob |

## Dev Agent Record
### Agent Model Used

### Debug Log References

### Completion Notes List

### File List

## QA Results
