# Story 4.1: 证据合并去重（URL/同域同标题/相似度）

## Status
Done

## Story
**作为** 系统（Evidence Builder/Orchestrator），  
**我希望** 将 Tavily 多车道检索结果合并并去重，生成可追溯的证据候选集，  
**以便** 为后续报告生成与校验提供稳定、一致的证据输入。

Epic Context: 对应 Epic 4「Evidence Builder」的 E4-S1。  
[Source: prd/epic-plan.md#Epic 4：Evidence Builder]

Dependencies: E3-S2（Tavily 检索与 raw_content 采集）、E3-S3（D 车道条件触发）。  
[Source: prd/epic-plan.md#Epic 3：Tavily 多车道检索]  
[Source: prd/appendices/evidence-builder.md#E1. 输入与输出]

## Acceptance Criteria
1. EvidenceBuilder 作为 pipeline step，位于 `search.tavily` 之后执行，读取 `tavily_results` 并输出 `evidence_candidates`。  
   [Source: architecture/architecture-core.md#4.1 主流程（单事件）]  
   [Source: architecture/source-tree.md#1) 源码目录结构（AI Signal Bot）]
2. `evidence_candidates` 结构与 Evidence 最小字段要求一致（`source_type/url/domain/published_at/claim/stance/novelty/repeated/strength`），并保留落地 Evidence 表所需的 `lane` 等信息。  
   [Source: architecture/architecture-core.md#3.2 核心数据结构（内部标准化 DTO）]  
   [Source: architecture/architecture-core.md#7.2 数据表（SQLite 逻辑模型）]  
   [Source: architecture/coding-standards.md#5.2 证据（Evidence）必须带来源与归因]
3. URL 完全相同的结果必须去重，仅保留一条主证据。  
   [Source: prd/appendices/evidence-builder.md#E2. 去重规则（Week 1 简版）]
4. `domain + title` 相似度 > 0.9 的结果视为重复，需归并为同一事实。  
   [Source: prd/appendices/evidence-builder.md#E2. 去重规则（Week 1 简版）]
5. 同一事实被多篇转述时，保留更权威或更早的一篇作为主证据，其余保留并标记 `repeated=true`，用于后续 “priced-in” 判断。  
   [Source: prd/appendices/evidence-builder.md#E2. 去重规则（Week 1 简版）]  
   [Source: prd/appendices/evidence-builder.md#E5. priced-in vs new（Week 1 规则）]
6. 主证据选择遵循来源类型优先级：**官方公告 > 主流媒体 > 市场行为 > 社交讨论 > 链上数据**；同优先级下按 `published_at` 最早者为主，若仍无法区分则按 `url` 字典序。  
   [Source: prd/appendices/evidence-builder.md#E3. 来源类型映射（必须五选一）]

## Tasks / Subtasks
- [x] Task 1：新增 EvidenceBuilder step 并接入 pipeline（AC: 1, 2）  
  [Source: architecture/coding-standards.md#2.1 Step 文件命名与顺序编排]  
  [Source: architecture/coding-standards.md#2.2 Step 统一接口（强约束）]  
  [Source: architecture/source-tree.md#1) 源码目录结构（AI Signal Bot）]
  - [x] Subtask 1.1：新增 `src/orchestrator/steps/evidence.build.step.ts`，消费 `tavily_results` 并产出 `evidence_candidates`
  - [x] Subtask 1.2：在 `src/orchestrator/pipeline.ts` 中将 EvidenceBuilder step 插入 `search.tavily` 之后
  - [x] Subtask 1.3：输入缺失或不合法时抛出统一 `AppError`（遵循错误码规范）
    [Source: architecture/coding-standards.md#6.1 统一 AppError]
- [x] Task 2：实现证据合并与去重规则（AC: 2-5）  
  [Source: prd/appendices/evidence-builder.md#E2. 去重规则（Week 1 简版）]  
  [Source: architecture/coding-standards.md#5.2 证据（Evidence）必须带来源与归因]
  - [x] Subtask 2.1：按 URL 完全一致进行去重
  - [x] Subtask 2.2：按 `domain + title` 相似度 > 0.9 进行去重
  - [x] Subtask 2.3：同一事实多来源时保留主证据，其余标记 `repeated=true`
  - [x] Subtask 2.4：按来源类型优先级与时间/URL 规则选择主证据（AC: 6）
- [x] Task 3：更新 DTO/类型以对齐 EvidenceCandidate 与 Evidence 表字段（AC: 2）  
  [Source: architecture/architecture-core.md#3.2 核心数据结构（内部标准化 DTO）]  
  [Source: architecture/architecture-core.md#7.2 数据表（SQLite 逻辑模型）]
  - [x] Subtask 3.1：更新 `src/orchestrator/types.ts` 中 EvidenceCandidate 字段定义
  - [x] Subtask 3.2：确保 pipeline context 传递 `evidence_candidates`
- [x] Task 4：补充 EvidenceBuilder 测试覆盖（AC: 2-5）  
  [Source: architecture/tech-stack.md#9) 测试策略]  
  [Source: architecture/coding-standards.md#11.3 单元测试范围（必须覆盖“各种情况”）]  
  [Source: architecture/coding-standards.md#11.8 可重复性（Determinism）要求]
  - [x] Subtask 4.1：单测覆盖 URL 去重、domain 归一化/相似度判断、repeated 标记
  - [x] Subtask 4.2：单测覆盖 claim 空值/过长截断与 stance/novelty 默认值
  - [x] Subtask 4.3：必要时增加基于 recorded fixtures 的集成测试（避免触网）

## Dev Notes
### Previous Story Insights
No specific guidance found in architecture docs.  
[Source: architecture/architecture-core.md]

### Data Models
- `TavilyLaneResult`：lane/query/results[{title,url,domain,published_at,raw_content}]。  
  [Source: architecture/architecture-core.md#3.2 核心数据结构（内部标准化 DTO）]
- `EvidenceCandidate`：source_type/url/domain/published_at/claim/stance/novelty/repeated/strength。  
  [Source: architecture/architecture-core.md#3.2 核心数据结构（内部标准化 DTO）]
- Evidence 表字段包含 `lane`、`source_type`、`url`、`domain`、`published_at`、`claim`、`stance`、`novelty`、`repeated`、`strength`。  
  [Source: architecture/architecture-core.md#7.2 数据表（SQLite 逻辑模型）]
- Evidence 最小字段约定：source_type、url、domain、published_at、claim、stance、novelty、repeated、strength；其中 stance 取值 `pro/con/neutral`，novelty 取值 `new/priced/unknown`。  
  [Source: architecture/coding-standards.md#5.2 证据（Evidence）必须带来源与归因]

### API Specifications
- EvidenceBuilder 位于 Tavily 检索之后，产出 evidence_candidates 供后续步骤使用。  
  [Source: architecture/architecture-core.md#4.1 主流程（单事件）]
- StorageAdapter 提供 `appendEvidence(evidence[])`，用于落地 Evidence 数据。  
  [Source: architecture/architecture-core.md#3.1 Provider 接口清单（概览）]

### Component Specifications
- Step 文件命名与顺序编排仅在 `pipeline.ts` 声明；Step 需实现统一接口（`id`/`run`/`requires`/`produces`）。  
  [Source: architecture/coding-standards.md#2.1 Step 文件命名与顺序编排]  
  [Source: architecture/coding-standards.md#2.2 Step 统一接口（强约束）]
- Week 1 必做清单包含 EvidenceBuilder 去重/打标（简版）。  
  [Source: architecture/architecture-core.md#13.1 必做清单（最小可运行）]

### File Locations
建议按现有结构实现/修改下列位置：  
- `src/orchestrator/steps/evidence.build.step.ts`（EvidenceBuilder step）  
- `src/orchestrator/pipeline.ts`（Step 顺序唯一声明处）  
- `src/orchestrator/types.ts`（EvidenceCandidate DTO）  
- `src/utils/text.ts`（文本相似度/去重工具）  
- `src/storage/sqlite/evidence.repo.ts`（Evidence 表落地）  
[Source: architecture/source-tree.md#1) 源码目录结构（AI Signal Bot）]

### Testing Requirements
- 单元测试需覆盖 Evidence 去重规则与边界情况。  
  [Source: architecture/tech-stack.md#9) 测试策略]  
  [Source: architecture/coding-standards.md#11.3 单元测试范围（必须覆盖“各种情况”）]
- EvidenceBuilder 必测：URL 去重、domain 归一化、claim 空值/过长截断、stance/novelty 默认值、repeated 判定。  
  [Source: architecture/coding-standards.md#11.3 单元测试范围（必须覆盖“各种情况”）]
- 测试需保证可重复性（固定时间/随机）。  
  [Source: architecture/coding-standards.md#11.8 可重复性（Determinism）要求]

### Technical Constraints
- Node.js 18+/20、TypeScript strict、ESM 模块制式。  
  [Source: architecture/tech-stack.md#2) 语言与运行时]

### Project Structure Notes
- `docs/architecture/unified-project-structure.md` 未找到；使用 `docs/architecture/source-tree.md` 作为目录结构依据。  
  [Source: architecture/source-tree.md#1) 源码目录结构（AI Signal Bot）]
- `docs/architecture/testing-strategy.md` 未找到；使用 `tech-stack.md` 与 `coding-standards.md` 中测试策略说明。  
  [Source: architecture/tech-stack.md#9) 测试策略]  
  [Source: architecture/coding-standards.md#11.3 单元测试范围（必须覆盖“各种情况”）]

## Change Log
| Date       | Version | Description | Author |
| ---------- | ------- | ----------- | ------ |
| 2026-01-26 | 0.1     | 创建故事草稿 | Bob    |
| 2026-01-26 | 0.2     | 补充主证据选择规则（来源类型优先级） | Bob    |
| 2026-01-26 | 0.3     | 提升为 Approved | Bob    |
| 2026-01-26 | 0.4     | 实现 EvidenceBuilder 去重与测试 | James |

## Dev Agent Record
### Agent Model Used
- GPT-5

### Debug Log References
- `npm test -- tests/orchestrator/evidence-build.step.test.ts`
- `npm test -- tests/orchestrator/pipeline-query-plan.step.test.ts`

### Completion Notes List
- 新增 evidence.build step 并接入 pipeline，缺失输入走统一 AppError。
- 实现 URL 去重、domain+title 相似度分组与主证据选择逻辑。
- 扩展 EvidenceCandidate DTO 字段并补充去重与默认值单测。
- 评估暂不新增 recorded fixture 集成测试，现有单测覆盖满足需求。

### File List
- src/utils/text.ts
- src/orchestrator/steps/evidence.build.step.ts
- src/orchestrator/errors.ts
- src/orchestrator/types.ts
- src/orchestrator/pipeline.ts
- tests/orchestrator/pipeline-query-plan.step.test.ts
- tests/orchestrator/evidence-build.step.test.ts

## QA Results

### Review Date: 2026-01-27

### Reviewed By: Quinn (Test Architect)

### Code Quality Assessment
实现遵循分层约束与 Step 规范，去重与主证据选择逻辑确定性良好；关键路径已有单测覆盖，但缺少对错误路径与 pipeline 顺序的显式测试。

### Refactoring Performed
无。

### Compliance Check
- Coding Standards: ✓
- Project Structure: ✓
- Testing Strategy: ✓（单测覆盖关键规则，但仍有覆盖补强空间）
- All ACs Met: ✓（AC1 主要通过代码审查确认）

### Improvements Checklist
- [ ] 增加 tavily_results 缺失/非法输入时的错误路径单测（`evidence.build`）
- [ ] 增加 pipeline step 顺序断言，确保 `evidence.build` 在 `search.tavily` 之后
- [ ] 增加主证据 tie-breaker（published_at/url）分支单测

### Security Review
未涉及鉴权/敏感数据处理，未发现安全问题。

### Performance Considerations
相似度分组最坏 O(n^2)，在 Tavily 结果规模下可接受；若未来结果规模扩大需关注。

### Files Modified During Review
无。

### Gate Status
Gate: PASS → docs/qa/gates/4.1-evidence-merge-dedupe.yml  
Risk profile: docs/qa/assessments/4.1-risk-20260127.md（未执行）  
NFR assessment: docs/qa/assessments/4.1-nfr-20260127.md（未执行）

### Recommended Status
[✓ Ready for Done] / [✗ Changes Required - See unchecked items above]
(Story owner decides final status)
