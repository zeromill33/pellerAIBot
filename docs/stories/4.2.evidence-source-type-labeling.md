# Story 4.2: 证据来源类型标注（官方/媒体/社交/链上/市场）

## Status
Done

## Story
**作为** 系统（Evidence Builder），  
**我希望** 为证据候选标注来源类型，  
**以便** 报告生成、校验与渲染阶段能够稳定引用来源类型。

Epic Context: 对应 Epic 4「Evidence Builder」的 E4-S2。  
[Source: prd/epic-plan.md#Epic 4：Evidence Builder]

Dependencies: E4-S1（证据合并去重）、E3-S2（Tavily 检索与 raw_content 采集）、E3-S3（D 车道条件触发）。  
[Source: prd/epic-plan.md#Epic 4：Evidence Builder]  
[Source: prd/epic-plan.md#Epic 3：Tavily 多车道检索]

## Acceptance Criteria
1. EvidenceBuilder 为每条 `evidence_candidate` 填充 `source_type`，且取值必须为：官方公告/主流媒体/社交讨论/链上数据/市场行为。  
   [Source: prd/appendices/evidence-builder.md#E3. 来源类型映射（必须五选一）]  
   [Source: prd/appendices/report-v1-schema.md#$defs/evidenceItem]
2. 车道 B 且域名为机构/官方站点 → `source_type=官方公告`。  
   [Source: prd/appendices/evidence-builder.md#E3. 来源类型映射（必须五选一）]
3. 车道 A/C 且域名为主流媒体 → `source_type=主流媒体`。  
   [Source: prd/appendices/evidence-builder.md#E3. 来源类型映射（必须五选一）]
4. 车道 D → `source_type=社交讨论`。  
   [Source: prd/appendices/evidence-builder.md#E3. 来源类型映射（必须五选一）]
5. 来自 Gamma/CLOB 的赔率变化/盘口/成交 → `source_type=市场行为`，并绑定 market url。  
   [Source: prd/appendices/evidence-builder.md#E3. 来源类型映射（必须五选一）]  
   [Source: prd/appendices/prompts.md#1)]
6. Week 1 不扫链：链上数据通常为空；仅在引入明确链上数据源时标注 `source_type=链上数据`。  
   [Source: prd/appendices/evidence-builder.md#E3. 来源类型映射（必须五选一）]
7. 官方/媒体域名白名单（或黑名单）需在配置或常量中显式维护并可迭代更新。  
   [Source: prd/appendices/evidence-builder.md#E3. 来源类型映射（必须五选一）]
8. 未命中白名单/黑名单时，仍需产出五选一 `source_type`，默认策略需在配置或常量中显式定义并可测试。  
   [Source: prd/appendices/evidence-builder.md#E3. 来源类型映射（必须五选一）]

## Tasks / Subtasks
- [x] Task 1：在 EvidenceBuilder 中实现来源类型标注规则（AC: 1-6）  
  [Source: prd/appendices/evidence-builder.md#E3. 来源类型映射（必须五选一）]
  - [x] Subtask 1.1：为 Tavily 结果按 lane + 域名规则赋值 `source_type`
  - [x] Subtask 1.2：为市场行为类证据赋值 `source_type=市场行为` 并绑定 market url
  - [x] Subtask 1.3：对未命中白名单的域名明确采用默认规则并保持五选一
- [x] Task 2：维护官方/主流媒体域名白名单（或黑名单）  
  [Source: prd/appendices/evidence-builder.md#E3. 来源类型映射（必须五选一）]
  - [x] Subtask 2.1：在配置或常量中声明域名列表并提供可扩展入口
- [x] Task 3：补充来源类型标注测试覆盖（AC: 1-7）  
  [Source: architecture/tech-stack.md#9) 测试策略]  
  [Source: architecture/coding-standards.md#11.3 单元测试范围（必须覆盖“各种情况”）]
  - [x] Subtask 3.1：单测覆盖 A/B/C/D 车道与域名映射规则
  - [x] Subtask 3.2：单测覆盖市场行为证据的 source_type 赋值
  - [x] Subtask 3.3：单测覆盖白名单/黑名单缺失或未命中时的默认规则

## Dev Notes
### Previous Story Insights
No specific guidance found in architecture docs.  
[Source: architecture/architecture-core.md]

### Data Models
- `TavilyLaneResult`：lane/query/results[{title,url,domain,published_at,raw_content}]。  
  [Source: architecture/architecture-core.md#3.2 核心数据结构（内部标准化 DTO）]
- `EvidenceCandidate`：source_type/url/domain/published_at/claim/stance/novelty/repeated/strength。  
  [Source: architecture/architecture-core.md#3.2 核心数据结构（内部标准化 DTO）]
- Evidence 表字段包含 `lane`、`source_type`、`url`、`domain`、`published_at`、`claim`、`stance`、`novelty`、`repeated`、`strength`。  
  [Source: architecture/architecture-core.md#7.2 数据表（SQLite 逻辑模型）]
- Evidence 最小字段约定包含 `source_type`，取值为 `official/media/social/onchain/market`。  
  [Source: architecture/coding-standards.md#5.2 证据（Evidence）必须带来源与归因]

### API Specifications
- EvidenceBuilder 位于 Tavily 检索之后，产出 evidence_candidates 供后续步骤使用。  
  [Source: architecture/architecture-core.md#4.1 主流程（单事件）]
- StorageAdapter 提供 `appendEvidence(evidence[])`，用于落地 Evidence 数据。  
  [Source: architecture/architecture-core.md#3.1 Provider 接口清单（概览）]

### Component Specifications
- Step 文件命名与顺序编排仅在 `pipeline.ts` 声明；Step 需实现统一接口（`id`/`run`/`requires`/`produces`）。  
  [Source: architecture/coding-standards.md#2.1 Step 文件命名与顺序编排]  
  [Source: architecture/coding-standards.md#2.2 Step 统一接口（强约束）]

### File Locations
建议按现有结构实现/修改下列位置：  
- `src/orchestrator/steps/evidence.build.step.ts`（EvidenceBuilder step）  
- `src/orchestrator/types.ts`（EvidenceCandidate DTO）  
- `src/utils/text.ts`（文本相似度/去重工具）  
- `src/storage/sqlite/evidence.repo.ts`（Evidence 表落地）  
[Source: architecture/source-tree.md#1) 源码目录结构（AI Signal Bot）]

### Testing Requirements
- 单元测试需覆盖 Evidence 去重/标注规则与边界情况。  
  [Source: architecture/tech-stack.md#9) 测试策略]  
  [Source: architecture/coding-standards.md#11.3 单元测试范围（必须覆盖“各种情况”）]
- EvidenceBuilder 必测：domain 归一化、stance/novelty 默认值、repeated 判定。  
  [Source: architecture/coding-standards.md#11.3 单元测试范围（必须覆盖“各种情况”）]
- 测试需保证可重复性（固定时间/随机）。  
  [Source: architecture/coding-standards.md#11.8 可重复性（Determinism）要求]

### Technical Constraints
- Node.js 18+/20、TypeScript strict、ESM 模块制式。  
  [Source: architecture/tech-stack.md#2) 语言与运行时]

### Project Structure Notes
- `docs/architecture/unified-project-structure.md` 未找到；使用 `docs/architecture/source-tree.md` 作为目录结构依据。  
  [Source: architecture/source-tree.md#1) 源码目录结构（AI Signal Bot）]
- `docs/architecture/testing-strategy.md` 未找到；使用 `tech-stack.md` 与 `coding-standards.md` 中测试策略说明。  
  [Source: architecture/tech-stack.md#9) 测试策略]  
  [Source: architecture/coding-standards.md#11.3 单元测试范围（必须覆盖“各种情况”）]

## Change Log
| Date       | Version | Description | Author |
| ---------- | ------- | ----------- | ------ |
| 2026-01-26 | 0.1     | 创建故事草稿 | Bob    |
| 2026-01-26 | 0.2     | 补充默认来源类型策略要求 | Bob    |
| 2026-01-26 | 0.3     | 提升为 Approved | Bob    |
| 2026-01-27 | 0.4     | 实现来源类型标注与测试覆盖 | James |

## Dev Agent Record
### Agent Model Used
- GPT-5

### Debug Log References
- `npm test -- tests/orchestrator/evidence-build.step.test.ts`

### Completion Notes List
- 根据 lane 与域名规则补齐 source_type 标注与默认策略，市场域名映射为 market。
- 从 market_signals 生成市场行为证据候选并绑定 Polymarket 事件 URL。
- 增加官方/媒体域名常量白名单，并确保链上默认不启用。
- 新增单测覆盖 lane 规则、市场域名、默认路径与市场行为证据生成。

### File List
- src/orchestrator/steps/evidence.build.step.ts
- src/orchestrator/pipeline.ts
- tests/orchestrator/evidence-build.step.test.ts

## QA Results
