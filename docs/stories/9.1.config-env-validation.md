# Story 9.1: 配置文件与环境变量加载校验

## Status
Draft

## Story
**As a** 运维/开发者，
**I want** 在启动项目前就能清晰知道必须配置的环境变量，并在缺失时得到明确提示，
**so that** 我能快速完成配置并让服务正常运行。

## Acceptance Criteria
1. 提供一份明确的环境变量清单（以 `.env.example` 或等价形式）覆盖启动所需的必填项，至少包含：`ADMIN_USER_IDS`、`TG_BOT_TOKEN`、`TAVILY_API_KEY`、`TG_CHANNEL_CHAT_ID`、`PUBLISH_STRATEGY`、`TG_PARSE_MODE`、`TG_DISABLE_PREVIEW`。
2. 启动时会校验必填环境变量是否存在，缺失则启动失败（清晰、可读的错误提示）。
3. 缺失提示信息需包含具体缺失项名称，便于快速补齐。
4. 对可选变量需有默认值或明确说明（文档或注释），并与“配置文件 vs 环境变量”的边界一致。

## Tasks / Subtasks
- [ ] Task 1：梳理并固化必填环境变量清单（AC: 1）
  - [ ] 从现有配置加载/校验入口梳理必填项，落地 `.env.example`
  - [ ] 标注必填/可选及用途说明（注释即可）
- [ ] Task 2：启动阶段校验必填变量并给出缺失提示（AC: 2, 3）
  - [ ] 在启动入口聚合校验错误并统一提示
  - [ ] 缺失项输出包含变量名列表
- [ ] Task 3：可选变量的默认值或说明补全（AC: 4）
  - [ ] 若已有默认值，确保 `.env.example` 说明与配置边界一致
  - [ ] 若无默认值，标注为必填或补充默认值
- [ ] Task 4：补充测试覆盖（AC: 1–4）
  - [ ] 新增/更新配置校验单测（必填缺失、提示内容）
  - [ ] 校验 `.env.example` 与校验逻辑的一致性（最小保障）

## Dev Notes

### 相关技术/结构约束
- 项目为单进程 Node.js + TypeScript 服务，配置通过环境变量注入。 [Source: architecture/tech-stack.md#2)
- 配置加载与校验需要在启动期完成，避免运行时才暴露问题。 [Source: architecture/tech-stack.md#2)
- 源码结构中存在 `src/config/` 作为配置加载与校验位置，并在入口初始化流程中使用。 [Source: architecture/source-tree.md#源码目录结构（AI Signal Bot）]
- 编码规范要求边界清晰：配置加载/校验应归属 `src/config/`，入口仅负责调用与回执。 [Source: architecture/coding-standards.md#1.1 分层定义（本项目版）]

### 关联模块（仅限架构文档允许范围）
- `src/config/`：配置加载与校验。 [Source: architecture/source-tree.md#源码目录结构（AI Signal Bot）]
- `src/main.ts`：服务入口（启动时加载配置）。 [Source: architecture/source-tree.md#源码目录结构（AI Signal Bot）]
- `.env.example`：用于列出必填环境变量清单。 [Source: architecture/source-tree.md#源码目录结构（AI Signal Bot）]

### 当前实现中的配置入口与校验位置（代码事实）
- `src/config/load.ts` 通过 env 读取：`ADMIN_USER_IDS`、`TG_BOT_TOKEN`、`TAVILY_API_KEY`、`PUBLISH_STRATEGY`、`TG_CHANNEL_CHAT_ID`、`TG_PARSE_MODE`、`TG_DISABLE_PREVIEW`，并调用校验函数。
- `src/config/config.schema.ts` 负责校验：`validateConfig` / `validateTelegramConfig` / `validateTavilyConfig` / `validatePublishConfig`。
- 启动入口 `src/main.ts` 通过 `loadTelegramConfig()` 获取 Bot 配置并启动 Bot（缺失会抛错导致启动失败）。

### 已在架构文档明确的配置/密钥边界
- 非敏感项建议落在 `config.yaml`：telegram 的 `channel_chat_id`、`parse_mode`、`disable_preview`、`admin_user_ids` 等。 [Source: architecture/tech-stack.md#11) 配置与密钥管理]
- 敏感项通过环境变量注入：`TG_BOT_TOKEN`、`TAVILY_API_KEY`、`LLM_API_KEY`。 [Source: architecture/tech-stack.md#11) 配置与密钥管理]
### 架构文档未明确的部分
- 未提供“完整环境变量清单”的唯一来源；需以当前实现为基准整理并体现在 `.env.example` 中。

### Testing
- 单元测试应覆盖配置校验逻辑与缺失提示。 [Source: architecture/tech-stack.md#9) 测试策略]
- 至少包含以下场景：缺失 `ADMIN_USER_IDS`、缺失 `TG_BOT_TOKEN`、缺失 `TAVILY_API_KEY`，错误信息包含变量名。

## Change Log

| Date | Version | Description | Author |
| --- | --- | --- | --- |
| 2026-01-29 | v0.1 | 创建 E9-S1 故事草案 | Bob (SM) |
| 2026-01-29 | v0.2 | 补充必填变量清单与缺口说明 | Bob (SM) |
| 2026-01-29 | v0.3 | 补充实现入口与测试场景 | Bob (SM) |

## Dev Agent Record

### Agent Model Used

### Debug Log References

### Completion Notes List

### File List

## QA Results
