# Story 10.2: P0 LLM 前置相关性过滤（Tavily 结果过滤）

## Status
Approved

## Story
**作为** 系统（Orchestrator/LLM 输入管道），  
**我希望** 在 LLM 生成报告前过滤掉与事件定义不相关的检索结果，  
**以便** 降低“命中但不相关”的证据进入报告并提升可审计性。

Epic Context: Epic 10「报告质量优化（P0/P1）」的 P0 相关性过滤。  
[Source: architecture/report_quality_P0_P1_implementation.md#P0-3 LLM 输入相关性过滤（先过滤再生成）]

Dependencies: 依赖 Tavily 多车道检索与 Report 生成主流程已可用。  
[Source: architecture/architecture-core.md#4.1 主流程（单事件）]

## Acceptance Criteria
1. 新增一个过滤步骤（`tavily.verify.step.ts` 或 `evidence.filter.step.ts`），位于 `search.tavily` 之后、`report.generate` 之前，且输出 **过滤后的 `tavily_results`** 供后续步骤使用。  
   [Source: architecture/report_quality_P0_P1_implementation.md#P0-3 LLM 输入相关性过滤（先过滤再生成）]
2. 过滤规则至少包含：关键词/实体命中（resolver/判定词/事件关键词）、`raw_content` 片段存在性与必要的时效性优先级；被过滤结果需记录 `url + reason` 以便审计。  
   [Source: architecture/report_quality_P0_P1_implementation.md#P0-3 LLM 输入相关性过滤（先过滤再生成）]
3. Pipeline 必须使用过滤后的 `tavily_results` 执行 `evidence.build` 与 `report.generate`；若过滤后结果不足以满足报告生成需求，应返回可触发补搜的失败信息（建议优先 C lane advanced）。  
   [Source: architecture/report_quality_P0_P1_implementation.md#P0-3 LLM 输入相关性过滤（先过滤再生成）]  
   [Source: architecture/architecture-core.md#4.3 “补搜”策略（节省额度 + 提升通过率）]
4. 为新增过滤逻辑补充单元测试，覆盖“命中/不命中/无 raw_content/时效性”分支。  
   [Source: architecture/coding-standards.md#11.3 单元测试范围（必须覆盖“各种情况”)]

## Tasks / Subtasks
- [ ] Task 1：实现 Tavily 结果过滤 step（AC: 1, 2）  
  [Source: architecture/source-tree.md#1) 源码目录结构（AI Signal Bot）]  
  [Source: architecture/coding-standards.md#2.1 Step 文件命名与顺序编排]
  - [ ] Subtask 1.1：新增 `src/orchestrator/steps/tavily.verify.step.ts`（或同等命名）实现过滤规则
  - [ ] Subtask 1.2：输出 `tavily_results_filtered` 与 `dropped_evidence[]`（url + reason）供审计
- [ ] Task 2：接线主流程并保证 LLM 使用过滤结果（AC: 3）  
  [Source: architecture/source-tree.md#1) 源码目录结构（AI Signal Bot）]  
  [Source: architecture/architecture-core.md#4.1 主流程（单事件）]
  - [ ] Subtask 2.1：在 `src/orchestrator/pipeline.ts` 中将过滤 step 插入 `search.tavily` 与 `evidence.build/report.generate` 之间
  - [ ] Subtask 2.2：确保 `evidence.build` 与 `report.generate` 使用过滤后的 `tavily_results`
  - [ ] Subtask 2.3：过滤后不足触发可补搜错误码/提示（优先 C lane advanced）
- [ ] Task 3：新增单元测试覆盖（AC: 4）  
  [Source: architecture/coding-standards.md#11.3 单元测试范围（必须覆盖“各种情况”)]
  - [ ] Subtask 3.1：覆盖命中/不命中关键词的过滤分支
  - [ ] Subtask 3.2：覆盖缺少 `raw_content` 的过滤分支
  - [ ] Subtask 3.3：覆盖时效性优先级分支

## Dev Notes
### Previous Story Insights
前一条 story 10.1 仍为 Draft（非 Done），存在流程风险但不阻断本条起草。  
[Source: architecture/architecture-core.md#4.1 主流程（单事件）]

### Data Models
- `TavilyLaneResult` 与 `TavilySearchResult` 包含 `lane/query/results`，结果含 `title/url/domain/published_at/raw_content`。  
  [Source: architecture/architecture-core.md#3.2 核心数据结构（内部标准化 DTO）]

### API Specifications
- Tavily 多车道检索是 LLM 输入证据来源之一，应保留 `raw_content` 片段用于相关性判断。  
  [Source: architecture/architecture-core.md#3.2 核心数据结构（内部标准化 DTO）]

### Component Specifications
- Step 顺序由 `pipeline.ts` 统一编排，新增 step 只能在此声明。  
  [Source: architecture/coding-standards.md#2.1 Step 文件命名与顺序编排]

### File Locations
- `src/orchestrator/steps/search.tavily.step.ts`：Tavily 检索 step。  
  [Source: architecture/source-tree.md#1) 源码目录结构（AI Signal Bot）]
- `src/orchestrator/steps/report.generate.step.ts`：Report 生成 step。  
  [Source: architecture/source-tree.md#1) 源码目录结构（AI Signal Bot）]
- `src/orchestrator/pipeline.ts`：主流程编排。  
  [Source: architecture/source-tree.md#1) 源码目录结构（AI Signal Bot）]

### Project Structure Notes
未找到 `docs/architecture/unified-project-structure.md` 与 `docs/architecture/testing-strategy.md`，本 story 以 `source-tree.md` 与 `coding-standards.md` 为结构/测试依据。  
[Source: architecture/source-tree.md#1) 源码目录结构（AI Signal Bot）]  
[Source: architecture/coding-standards.md#11. 测试与质量门禁（必须更严格：build 通过 + 单测覆盖 + 外部依赖集成测试）]

### Testing Requirements
- 单元测试必须覆盖分支/边界/错误路径，建议表驱动用例。  
  [Source: architecture/coding-standards.md#11.3 单元测试范围（必须覆盖“各种情况”)]
- 测试需可重复，避免依赖外网。  
  [Source: architecture/coding-standards.md#11.8 可重复性（Determinism）要求]

## Change Log
| Date       | Version | Description | Author |
| ---------- | ------- | ----------- | ------ |
| 2026-01-30 | v0.1    | 初稿（P0 LLM 前置相关性过滤） | Bob (SM) |

## Dev Agent Record
### Agent Model Used

### Debug Log References

### Completion Notes List

### File List

## QA Results
