# Story 2.2: CLOB 拉取订单簿摘要并映射为 ClobSnapshot

## Status
Done

## Story
**作为** 系统（Pipeline），  
**我希望** 能通过 Polymarket CLOB API 拉取订单簿摘要并映射为标准化的 `ClobSnapshot`，  
**以便** 为流动性代理与报告中的市场结构信号提供输入。

Dependencies: E2-S1（MarketContext 提供 clob tokenIds）。

## Acceptance Criteria
1. 可通过 `token_id`（来自 `MarketContext.clob_token_ids`）调用 CLOB `/book` 获取订单簿数据，并提取 top N 档（N=10）。
2. 映射为 `ClobSnapshot`，至少包含 spread、midpoint、book_top_levels、notable_walls 等字段。
3. 对大额挂单墙进行基础识别（size > 均值×k）并标注为 notable wall。
4. 当订单簿为空或缺少 bids/asks 时，`book_top_levels` 为空数组，spread/midpoint 置空。
5. 对 CLOB API 的限流/重试按规范处理（429/5xx/网络错误），并使用短 TTL 缓存。

## Tasks / Subtasks
- [x] 实现或完善 `MarketProvider.getOrderBookSummary(tokenId)`，调用 `/book?token_id=...`（AC: 1, 4）  
  - [x] 只取前 N 档（N=10）并计算 `best_bid/best_ask/spread/mid`  
  - [x] 处理空盘口或缺 bids/asks 的情况  
  [Source: architecture/providers/polymarket-clob.md#B.3 关键端点：Get order book summary]
- [x] 映射 `ClobSnapshot` 并计算 notable walls（AC: 2, 3）  
  - [x] 规则：size > 均值×k（k=5）  
  [Source: architecture/providers/polymarket-clob.md#B.3 关键端点：Get order book summary]  
  [Source: architecture/providers/polymarket-clob.md#B.4 “大额挂单墙”与“鲸鱼动向”口径（Week 1 现实版）]
- [x] 按 Provider 通用规范实现超时、重试、退避与短 TTL 缓存（AC: 5）  
  - [x] 对 429/5xx/网络错误重试，最多 3 次  
  - [x] 订单簿缓存 TTL=15–60s（可配置）  
  [Source: architecture/providers/provider-guidelines.md#I.1 统一的 HTTP Client 封装]  
  [Source: architecture/providers/provider-guidelines.md#I.2 缓存与去重]  
  [Source: architecture/providers/polymarket-gamma.md#A.7 建议的缓存 Key]
- [x] 补充 Provider 级测试（200/429/字段缺失/空盘口）与 fixture（AC: 4, 5）  
  [Source: architecture/providers/provider-guidelines.md#I.3 Mock 与集成测试]  
  [Source: architecture/coding-standards.md#11.5 Provider 必测的“故障注入”场景]

## Dev Notes
### Previous Story Insights
No specific guidance found in architecture docs.  
[Source: architecture/architecture-core.md]

### Data Models
- `ClobSnapshot` 建议字段：spread, midpoint, book_top_levels, notable_walls, price_change_24h（若可用）。  
  [Source: architecture/architecture-core.md#3.2 核心数据结构（内部标准化 DTO）]

### API Specifications
- Base URL：`https://clob.polymarket.com`（只读 Market Data）  
  [Source: architecture/providers/polymarket-clob.md#B.2 Base URL 与鉴权]
- `GET /book?token_id=...`  
  [Source: architecture/providers/polymarket-clob.md#B.3 关键端点：Get order book summary]

### Component Specifications
- CLOB 仅提供结构信号，不要推导地址级“鲸鱼”结论。  
  [Source: architecture/providers/polymarket-clob.md#B.4 “大额挂单墙”与“鲸鱼动向”口径（Week 1 现实版）]
- Provider 必须包含超时、重试、退避与可观测性打点。  
  [Source: architecture/providers/provider-guidelines.md#I.1 统一的 HTTP Client 封装]

### File Locations
建议按现有结构实现/修改下列位置：  
- `src/providers/polymarket/`（CLOB client/mapper/policy/index）  
- `src/orchestrator/types.ts`（ClobSnapshot DTO 若需扩展）  
[Source: architecture/source-tree.md#1) 源码目录结构（AI Signal Bot）]

### Testing Requirements
- Provider 测试需包含 200/429/字段缺失三类场景，并使用 fixtures + mock。  
  [Source: architecture/providers/provider-guidelines.md#I.3 Mock 与集成测试]  
  [Source: architecture/coding-standards.md#11.5 Provider 必测的“故障注入”场景]

### Technical Constraints
- TypeScript 严格模式、ESM 模块制式，避免使用 `any`。  
  [Source: architecture/tech-stack.md#2) 语言与运行时]
- 外部请求必须设置 timeout，避免无限重试。  
  [Source: architecture/coding-standards.md#3.2 超时 / 重试 / 退避（硬性要求）]

### Project Structure Notes
Provider 实现应位于 `src/providers/polymarket/`，不应被 Orchestrator 以外层级绕过调用。  
[Source: architecture/coding-standards.md#1.2 依赖方向（必须遵守）]  
[Source: architecture/source-tree.md#1) 源码目录结构（AI Signal Bot）]

## Change Log
| Date       | Version | Description | Author |
| ---------- | ------- | ----------- | ------ |
| 2026-01-23 | 0.1     | 创建故事草稿 | Bob |

## Dev Agent Record
### Agent Model Used
GPT-5

### Debug Log References
npm test

### Completion Notes List
- 新增 CLOB provider 与 ClobSnapshot 映射、重试与缓存策略。
- 增加 CLOB 订单簿 fixture 与测试覆盖 200/429/字段缺失/空盘口。

### File List
- src/providers/polymarket/clob.ts
- src/providers/polymarket/index.ts
- src/orchestrator/types.ts
- src/orchestrator/errors.ts
- tests/providers/polymarket/clob.test.ts
- tests/fixtures/polymarket_clob_book.json

## QA Results
