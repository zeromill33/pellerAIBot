# Story 1.1: 多链接输入解析与 slug 提取

## Status
Done

## Story
**As a** 运营人员，
**I want** 在 /publish 命令中一次输入多个 Polymarket 链接并自动解析 slug、识别非法链接，
**so that** 我可以批量触发生成流程且得到清晰的失败反馈。

Epic Context: 对应 Epic 1「运营触发与流程编排」的 E1-S1；本故事覆盖 /publish 多链接解析与 url.parse step 输出，为后续 batch/pipeline 处理提供 event_slug 列表与无效链接列表。[Source: prd/epic-plan.md#Epic 1：运营触发与流程编排] [Source: architecture/architecture-core.md#4.2 多事件批处理] [Source: architecture/source-tree.md#1) 源码目录结构（AI Signal Bot）]
Dependencies: 无前序故事依赖。

## Acceptance Criteria
1. /publish 支持输入多个 Polymarket event URL 并解析为 URL 列表用于后续处理。[Source: architecture/architecture-core.md#1.3 运营触发入口（推荐方案）]
2. 每个合法 URL 能解析出 event slug（/event/<slug>），并输出到 pipeline 的 event_slug 字段。[Source: architecture/source-tree.md#1) 源码目录结构（AI Signal Bot）] [Source: architecture/coding-standards.md#5.1 通用字段命名约定]
3. 非法链接会被标记为无效并返回结构化错误（AppError + 错误码），至少包含 code/message/category/retryable 字段，不生成 slug。[Source: architecture/coding-standards.md#6.1 统一 AppError] [Source: architecture/coding-standards.md#6.2 错误码命名规范]
4. 解析阶段完成 URL 去重与校验，输出去重后的 slug 列表与无效列表。[Source: architecture/architecture-core.md#4.2 多事件批处理]

## Tasks / Subtasks
- [x] Task 1：实现 /publish 多链接参数解析与基础校验（AC: 1, 4）[Source: architecture/architecture-core.md#1.3 运营触发入口（推荐方案）] [Source: architecture/source-tree.md#1) 源码目录结构（AI Signal Bot）]
  - [x] Subtask 1.1：在 `src/bot/commands/publish.ts` 解析命令参数为 URL 列表并保留顺序
  - [x] Subtask 1.2：在 `src/bot/guard.ts` 做空列表/明显非法输入的快速拒绝（入口层）
- [x] Task 2：实现 url→slug 解析 step 与 URL 去重/校验输出（AC: 2, 4）[Source: architecture/source-tree.md#1) 源码目录结构（AI Signal Bot）] [Source: architecture/architecture-core.md#4.2 多事件批处理]
  - [x] Subtask 2.1：在 `src/orchestrator/steps/url.parse.step.ts` 校验 Polymarket event URL 格式并提取 slug
  - [x] Subtask 2.2：对重复 URL/slug 做去重，产出有效 slug 列表 + 无效链接列表
- [x] Task 3：补充错误码与类型定义（AC: 3）[Source: architecture/coding-standards.md#6.1 统一 AppError] [Source: architecture/coding-standards.md#6.2 错误码命名规范]
  - [x] Subtask 3.1：在 `src/orchestrator/errors.ts` 或入口层新增稳定错误码（如 `BOT_INVALID_URL` / `STEP_URL_PARSE_INVALID_URL`）
  - [x] Subtask 3.2：在 `src/orchestrator/types.ts` 定义解析结果结构（slug 列表 + invalid 列表）
- [x] Task 4：补充测试用例（AC: 1-4）[Source: architecture/coding-standards.md#11 测试与质量门禁（必须更严格：build 通过 + 单测覆盖 + 外部依赖集成测试）]
  - [x] Subtask 4.1：单元测试覆盖合法/非法 URL、重复 URL/slug、空输入
  - [x] Subtask 4.2：集成测试覆盖 /publish 入口到 url.parse step 的基础流程（使用 mock，禁止外网）

## Dev Notes
### Previous Story Insights
- 无（无前序故事）。

### Data Models
- `event_slug` 是业务主键字段命名，解析结果需落到该字段名。[Source: architecture/coding-standards.md#5.1 通用字段命名约定]
- 运行链路中使用 `request_id`（批次）与 `run_id`（单事件）进行追踪，解析结果需与这些标识保持一致。[Source: architecture/coding-standards.md#2.3 数据项目必须具备：幂等与可回放]

### API Specifications
- Admin Bot 命令 `/publish <url1> <url2 ...>` 是运营触发入口，支持多链接输入。[Source: architecture/architecture-core.md#1.3 运营触发入口（推荐方案）]
- 批处理在进入 pipeline 前需对 URLs 去重与校验。[Source: architecture/architecture-core.md#4.2 多事件批处理]

### Error Response (AppError)
- 最小字段：`code`、`message`、`category`、`retryable`（`details` 可选）。[Source: architecture/coding-standards.md#6.1 统一 AppError]
- 示例（入口层回执或 step 失败返回，二者保持一致口径）：  
  ```json
  {
    "code": "STEP_URL_PARSE_INVALID_URL",
    "message": "非法 Polymarket event URL",
    "category": "VALIDATION",
    "retryable": false,
    "details": { "input": "<raw_url>" }
  }
  ```

### Component Specifications
- Entry Layer 仅负责参数解析、权限校验、调用 orchestrator、格式化回执；不得直接处理业务链路。[Source: architecture/coding-standards.md#1.1 分层定义（本项目版）]
- URL 解析属于 pipeline step（`url.parse.step.ts`），文件位置与责任见源代码结构说明。[Source: architecture/source-tree.md#1) 源码目录结构（AI Signal Bot）]

### File Locations
- `src/bot/commands/publish.ts`：/publish 命令解析入口。[Source: architecture/source-tree.md#1) 源码目录结构（AI Signal Bot）]
- `src/bot/guard.ts`：参数校验与回执格式。[Source: architecture/source-tree.md#1) 源码目录结构（AI Signal Bot）]
- `src/orchestrator/steps/url.parse.step.ts`：URL→slug 解析 step。[Source: architecture/source-tree.md#1) 源码目录结构（AI Signal Bot）]
- `src/orchestrator/batch.ts`：批处理编排与汇总。[Source: architecture/source-tree.md#1) 源码目录结构（AI Signal Bot）]
- `src/orchestrator/types.ts`：pipeline DTO 定义。[Source: architecture/source-tree.md#1) 源码目录结构（AI Signal Bot）]
- `src/orchestrator/errors.ts`：统一错误码定义。[Source: architecture/source-tree.md#1) 源码目录结构（AI Signal Bot）]

### Testing
- 需满足 build/typecheck/lint/unit/integration 的 CI 门禁；禁止依赖真实外网 API。[Source: architecture/coding-standards.md#11.1 CI 质量门禁（PR 必须通过）]
- 单元测试需覆盖边界与错误路径；集成测试使用 mock/replay。[Source: architecture/coding-standards.md#11.3 单元测试范围（必须覆盖“各种情况”)] [Source: architecture/coding-standards.md#11.4 Provider 集成测试（外部依赖：必须有“可回放”测试）]
- 测试框架建议使用 `vitest`（或 `jest`）；按仓库实际依赖确定。[Source: architecture/tech-stack.md#13) 技术选型清单（Week 1 建议落地版本）]
- 录制响应与集成测试 fixtures 位置建议使用 `fixtures/`。[Source: architecture/source-tree.md#1) 源码目录结构（AI Signal Bot）]
- 测试文件目录未在文档中明确，按仓库现有约定补充即可。

### Technical Constraints
- 运行时 Node.js 18+/20，TypeScript strict，ESM 模块制式。[Source: architecture/tech-stack.md#2) 语言与运行时]
- 错误需统一为 AppError，并按约定前缀命名错误码（如 BOT_* / STEP_*）。[Source: architecture/coding-standards.md#6.1 统一 AppError] [Source: architecture/coding-standards.md#6.2 错误码命名规范]

### Project Structure Notes
- `docs/architecture/unified-project-structure.md` 未找到；使用 `docs/architecture/source-tree.md` 作为目录结构依据。
- `docs/architecture/testing-strategy.md` 未找到；使用 `docs/architecture/coding-standards.md` 中测试门禁作为依据。

## Change Log
| Date       | Version | Description | Author |
| ---------- | ------- | ----------- | ------ |
| 2026-01-23 | 0.1     | 初稿        | Bob    |
| 2026-01-23 | 0.2     | 补充 Epic 上下文与错误回执/测试说明 | Bob    |
| 2026-01-23 | 0.3     | 实现多链接解析、URL 解析 step、错误码与测试 | James |
| 2026-01-23 | 0.4     | 处理非法 percent 编码 slug 的错误回执稳定性 | James |

## Dev Agent Record
### Agent Model Used
- GPT-5

### Debug Log References
- `npm test`
- `npm run build`
- `npm test`

### Completion Notes List
- 已实现 /publish 多链接解析与入口 guard，支持空输入与明显非法输入拦截。
- url.parse step 校验 Polymarket event URL 并提取 slug，完成 URL/slug 去重与无效列表输出。
- 新增错误码与 DTO 类型定义，补充单元测试与集成测试覆盖。
- 处理 ESM NodeNext 编译要求，为相对导入补齐 `.js` 扩展名。
- 捕获非法 percent 编码 slug 的解码异常，保证无效 URL 稳定返回结构化错误。

### File List
- package.json
- package-lock.json
- tsconfig.json
- vitest.config.ts
- src/bot/commands/publish.ts
- src/bot/guard.ts
- src/orchestrator/index.ts
- src/orchestrator/batch.ts
- src/orchestrator/errors.ts
- src/orchestrator/types.ts
- src/orchestrator/steps/url.parse.step.ts
- src/utils/id.ts
- tests/guard.test.ts
- tests/url-parse.test.ts
- tests/publish.integration.test.ts

## QA Results

### Review Date: 2026-01-23

### Reviewed By: Quinn (Test Architect)

### Code Quality Assessment
实现遵循分层与 DTO 约定，URL 解析与错误封装稳定，结构清晰且可维护。

### Refactoring Performed
无。

### Compliance Check
- Coding Standards: ✓ AppError/命名与 ESM 导入规范符合要求
- Project Structure: ✓ 目录结构符合 source-tree 约定
- Testing Strategy: ✓ 单元/集成测试覆盖主要路径
- All ACs Met: ✓

### Improvements Checklist
- [ ] 增强对 AppError 字段（message/category/retryable/details）的断言覆盖

### Security Review
未涉及鉴权或敏感数据处理，URL 校验与解析无明显安全风险。

### Performance Considerations
解析与去重为线性处理，预期无性能瓶颈。

### Files Modified During Review
- `docs/stories/1.1.multi-link-url-parse.md`
- `docs/qa/gates/1.1-multi-link-url-parse.yml`
请 Dev 更新 File List（如需纳入发布记录）。

### Gate Status
Gate: PASS → docs/qa/gates/1.1-multi-link-url-parse.yml  
Risk profile: 未执行（未请求）  
NFR assessment: 未执行（未请求）

### Recommended Status
[✓ Ready for Done] / [✗ Changes Required - See unchecked items above]
(Story owner decides final status)
