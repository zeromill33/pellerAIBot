# Story 1.2: 批处理编排与逐条结果汇总

## Status
Done

## Story
**As a** 运营人员，
**I want** /publish 在一次触发中批量处理多个链接并返回逐条结果与汇总回执，
**so that** 我能清楚知道每条链接的成功/失败原因并快速重试。

Epic Context: 对应 Epic 1「运营触发与流程编排」的 E1-S2；本故事负责批处理编排与逐条结果汇总，并依赖 1.1 输出的合法 URL/slug 列表。[Source: prd/epic-plan.md#Epic 1：运营触发与流程编排] [Source: architecture/architecture-core.md#4.2 多事件批处理]
Dependencies: 1.1 多链接输入解析与 slug 提取。

## Acceptance Criteria
1. /publish 触发批处理编排，支持对多个链接并发处理，且并发度可配置（建议 2~3）。[Source: architecture/architecture-core.md#4.2 多事件批处理]
2. 每条链接独立执行，单条失败不影响其它条目；结果包含 event_slug、状态与错误码/消息。[Source: architecture/architecture-core.md#4.2 多事件批处理] [Source: architecture/coding-standards.md#6.1 统一 AppError]
3. Bot 回执包含成功/失败汇总列表，失败项包含错误码与建议（如可重试提示）。[Source: architecture/architecture-core.md#4.2 多事件批处理]
4. 批处理与单事件执行均携带 request_id（批次）与 run_id（单事件）用于追踪。[Source: architecture/coding-standards.md#2.3 数据项目必须具备：幂等与可回放] [Source: architecture/coding-standards.md#9.1 结构化日志（必须）]

## Tasks / Subtasks
- [x] Task 1：实现批处理编排与并发控制（AC: 1, 2）[Source: architecture/architecture-core.md#4.2 多事件批处理] [Source: architecture/source-tree.md#1) 源码目录结构（AI Signal Bot）]
  - [x] Subtask 1.1：在 `src/orchestrator/batch.ts` 接收 URL/slug 列表并设置并发度（配置化）
  - [x] Subtask 1.2：为每条链接生成 run_id 并独立执行 pipeline（失败不阻断批次）
- [x] Task 2：定义批处理结果结构与回执汇总（AC: 2, 3）[Source: architecture/architecture-core.md#4.2 多事件批处理] [Source: architecture/coding-standards.md#6.1 统一 AppError]
  - [x] Subtask 2.1：在 `src/orchestrator/types.ts` 定义批处理结果 DTO（success/fail 列表）
  - [x] Subtask 2.2：在 `src/bot/commands/publish.ts` 组装并输出汇总回执（含错误码与提示）
- [x] Task 3：补充错误码与结构化日志字段（AC: 2, 4）[Source: architecture/coding-standards.md#6.2 错误码命名规范] [Source: architecture/coding-standards.md#9.1 结构化日志（必须）]
  - [x] Subtask 3.1：新增/复用批处理相关错误码（如 `ORCH_BATCH_*`）
  - [x] Subtask 3.2：批次级日志包含 request_id，单条包含 run_id 与 event_slug
- [x] Task 4：补充测试用例（AC: 1-4）[Source: architecture/coding-standards.md#11 测试与质量门禁（必须更严格：build 通过 + 单测覆盖 + 外部依赖集成测试）]
  - [x] Subtask 4.1：单元测试覆盖并发度配置、单条失败不影响其他条目
  - [x] Subtask 4.2：集成测试覆盖 /publish 批处理的成功/失败汇总回执（mock providers）

## Dev Notes
### Previous Story Insights
- 无（前序 1.1 仅输出 URL/slug 列表与无效列表）。

### Data Models
- `request_id`（批次）与 `run_id`（单事件）必须贯穿日志与结果，用于可回放与定位。[Source: architecture/coding-standards.md#2.3 数据项目必须具备：幂等与可回放]
- 结果需包含 `event_slug` 作为业务主键字段名。[Source: architecture/coding-standards.md#5.1 通用字段命名约定]

### API Specifications
- 批处理入口由 `/publish url1 url2 ...` 触发；回执需要包含成功/失败列表与失败原因。[Source: architecture/architecture-core.md#4.2 多事件批处理]

### Component Specifications
- Entry Layer 只做参数解析与回执格式化，批处理编排由 orchestrator 负责。[Source: architecture/coding-standards.md#1.1 分层定义（本项目版）]
- 批处理逻辑位于 `src/orchestrator/batch.ts`，与 pipeline.ts 解耦，保持 step 顺序集中声明。[Source: architecture/source-tree.md#1) 源码目录结构（AI Signal Bot）] [Source: architecture/coding-standards.md#2.1 Step 文件命名与顺序编排]

### File Locations
- `src/orchestrator/batch.ts`：批处理并发控制与汇总回执。[Source: architecture/source-tree.md#1) 源码目录结构（AI Signal Bot）]
- `src/orchestrator/index.ts`：触发批处理入口。[Source: architecture/source-tree.md#1) 源码目录结构（AI Signal Bot）]
- `src/orchestrator/types.ts`：批处理结果 DTO 定义。[Source: architecture/source-tree.md#1) 源码目录结构（AI Signal Bot）]
- `src/orchestrator/errors.ts`：错误码定义。[Source: architecture/source-tree.md#1) 源码目录结构（AI Signal Bot）]
- `src/bot/commands/publish.ts`：回执格式化与输出。[Source: architecture/source-tree.md#1) 源码目录结构（AI Signal Bot）]

### Testing
- 需满足 build/typecheck/lint/unit/integration 的 CI 门禁；禁止依赖真实外网 API。[Source: architecture/coding-standards.md#11.1 CI 质量门禁（PR 必须通过）]
- 单元测试需覆盖并发/失败分支；集成测试使用 mock/replay。[Source: architecture/coding-standards.md#11.3 单元测试范围（必须覆盖“各种情况”)] [Source: architecture/coding-standards.md#11.4 Provider 集成测试（外部依赖：必须有“可回放”测试）]
- 测试框架建议使用 `vitest`（或 `jest`）；按仓库实际依赖确定。[Source: architecture/tech-stack.md#13) 技术选型清单（Week 1 建议落地版本）]
- 录制响应与集成测试 fixtures 位置建议使用 `fixtures/`。[Source: architecture/source-tree.md#1) 源码目录结构（AI Signal Bot）]

### Technical Constraints
- 运行时 Node.js 18+/20，TypeScript strict，ESM 模块制式。[Source: architecture/tech-stack.md#2) 语言与运行时]
- 错误需统一为 AppError，并按约定前缀命名错误码。[Source: architecture/coding-standards.md#6.1 统一 AppError] [Source: architecture/coding-standards.md#6.2 错误码命名规范]

### Project Structure Notes
- `docs/architecture/unified-project-structure.md` 未找到；使用 `docs/architecture/source-tree.md` 作为目录结构依据。
- `docs/architecture/testing-strategy.md` 未找到；使用 `docs/architecture/coding-standards.md` 中测试门禁作为依据。

## Change Log
| Date       | Version | Description | Author |
| ---------- | ------- | ----------- | ------ |
| 2026-01-23 | 0.1     | 初稿        | Bob    |
| 2026-01-23 | 0.2     | 实现批处理并发、回执汇总与测试 | James |

## Dev Agent Record
### Agent Model Used
- GPT-5

### Debug Log References
- `npm test`
- `npm run build`

### Completion Notes List
- 实现批处理并发控制与逐条 pipeline 调用，补齐 request_id/run_id 日志字段。
- 扩展批处理结果 DTO，新增成功/失败列表与汇总统计。
- 补充 /publish 回执组装逻辑与批处理相关错误码。
- 新增批处理单元测试与回执集成测试覆盖。

### File List
- src/orchestrator/types.ts
- src/orchestrator/errors.ts
- src/orchestrator/pipeline.ts
- src/orchestrator/batch.ts
- src/utils/id.ts
- src/bot/commands/publish.ts
- tests/publish.integration.test.ts
- tests/batch.test.ts

## QA Results

### Review Date: 2026-01-23

### Reviewed By: Quinn (Test Architect)

### Code Quality Assessment
批处理并发与逐条执行逻辑清晰，DTO 设计与回执汇总一致，日志字段满足追踪需求，整体可维护性良好。

### Refactoring Performed
无。

### Compliance Check
- Coding Standards: ✓ AppError 结构与日志字段符合约定
- Project Structure: ✓ 目录与职责边界符合约定
- Testing Strategy: ✓ 单元/集成测试覆盖并发与失败分支
- All ACs Met: ✓

### Improvements Checklist
- [ ] 建议在回执中显式输出 suggestion 字段，提前与 1.3 的错误回执对齐（src/bot/commands/publish.ts）
- [ ] 日志可补 step_id 字段以更贴合结构化日志规范（src/orchestrator/batch.ts）

### Security Review
未涉及鉴权或敏感数据处理，未发现新增安全风险。

### Performance Considerations
并发控制可配置且有上限，队列处理符合预期，未见明显性能瓶颈。

### Files Modified During Review
无。

### Gate Status
Gate: PASS → docs/qa/gates/1.2-batch-orchestrator-summary.yml  
Risk profile: 未执行（未请求）  
NFR assessment: 未执行（未请求）

### Recommended Status
[✓ Ready for Done] / [✗ Changes Required - See unchecked items above]
(Story owner decides final status)
