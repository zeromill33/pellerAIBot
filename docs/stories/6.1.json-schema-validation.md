# Story 6.1: JSON Schema 校验与错误码返回

## Status
Approved

## Story
**作为** 系统（Validator），  
**我希望** 对 Report v1 JSON 做严格 schema 校验并返回标准化错误码与建议，  
**以便** 不合规输出被阻断且运营能快速定位失败原因并补救。

Epic Context: 对应 Epic 6「Validator 与补搜闭环」的 E6-S1。  
[Source: prd/epic-plan.md#Epic 6：Validator 与补搜闭环]

Dependencies: 依赖 E5-S2（Report v1 JSON 输出）与 `report_v1.schema.json` 规则落地。  
[Source: prd/epic-plan.md#Epic 5：Report v1 生成]  
[Source: prd/appendices/report-v1-schema.md#附录 B：Report v1 JSON Schema（0–100 概率）]

## Acceptance Criteria
1. Validator 必须进行 Report v1 JSON Schema 校验：JSON 可解析、严格匹配 schema（多 key、缺 key 均失败）。  
   [Source: prd/appendices/validator.md#F1. Schema 校验]  
   [Source: prd/appendices/report-v1-schema.md#附录 B：Report v1 JSON Schema（0–100 概率）]
2. 概率字段必须为 0–100：`context.market_odds.yes/no` 与 `ai_vs_market.market_yes/ai_yes_beta`；不满足则失败。  
   [Source: prd/appendices/validator.md#F1. Schema 校验]  
   [Source: prd/appendices/report-v1-schema.md#附录 B：Report v1 JSON Schema（0–100 概率）]
3. Validator 失败必须返回标准化错误对象：`code`、`message`、`suggestion`（可选），并符合 AppError 规范（`category=VALIDATION`）。  
   [Source: prd/appendices/validator.md#F3. 失败原因返回格式（建议）]  
   [Source: architecture/coding-standards.md#6.1 统一 AppError]
4. 非 JSON 输出必须直接阻断，并返回明确 `VALIDATOR_*` 类错误码（避免继续下游流程）。  
   [Source: architecture/coding-standards.md#4.1 LLM 只输出结构化 JSON（硬性）]  
   [Source: architecture/coding-standards.md#6.2 错误码命名规范（便于聚合)]
5. 校验应在 `report.validate` step 完成，且通过/失败结果应被上游用于决定是否发布。  
   [Source: architecture/source-tree.md#1) 源码目录结构（AI Signal Bot）]  
   [Source: architecture/architecture-core.md#4.1 主流程（单事件）]

## Tasks / Subtasks
- [ ] Task 1：实现 Report v1 JSON Schema 校验（AC: 1-4）  
  [Source: prd/appendices/report-v1-schema.md#附录 B：Report v1 JSON Schema（0–100 概率）]  
  [Source: prd/appendices/validator.md#F1. Schema 校验]  
  [Source: architecture/coding-standards.md#6.1 统一 AppError]
  - [ ] Subtask 1.1：在 `src/validator/ajv.ts` 加载 `report_v1.schema.json` 并提供校验函数
  - [ ] Subtask 1.2：在 `src/validator/index.ts` 实现 `validateReport(reportJson)` 并返回 `{ok, code, message, suggestion}`
  - [ ] Subtask 1.3：JSON parse 失败或 schema 不通过时返回 `VALIDATOR_*` 错误码与可读 message
- [ ] Task 2：在 `report.validate` step 接入 Validator（AC: 5）  
  [Source: architecture/source-tree.md#1) 源码目录结构（AI Signal Bot）]  
  [Source: architecture/coding-standards.md#2.2 Step 统一接口（强约束）]
  - [ ] Subtask 2.1：在 `src/orchestrator/steps/report.validate.step.ts` 调用 `validateReport` 并根据结果更新 ctx
  - [ ] Subtask 2.2：失败时确保 pipeline 终止并向上抛标准化错误
- [ ] Task 3：补充 Validator schema 校验测试（AC: 1-4）  
  [Source: architecture/coding-standards.md#11.3 单元测试范围（必须覆盖“各种情况”)]  
  [Source: architecture/tech-stack.md#9) 测试策略]
  - [ ] Subtask 3.1：覆盖 JSON parse 失败、缺 key/多 key、概率越界的失败分支
  - [ ] Subtask 3.2：覆盖成功用例（完整 Report v1 JSON）

## Dev Notes
### Previous Story Insights
No specific guidance found in architecture docs.  
[Source: architecture/architecture-core.md]

### Data Models
- Report v1 JSON schema 以 `report_v1.schema.json` 为准，required 字段与枚举值必须严格匹配。  
  [Source: prd/appendices/report-v1-schema.md#附录 B：Report v1 JSON Schema（0–100 概率）]

### API Specifications
- Validator 返回 `{ok, code, message, suggestion}`，失败则阻断发布。  
  [Source: prd/appendices/validator.md#F3. 失败原因返回格式（建议）]

### Component Specifications
- LLM 输出必须为纯 JSON，非 JSON 直接失败。  
  [Source: architecture/coding-standards.md#4.1 LLM 只输出结构化 JSON（硬性）]
- 错误码应符合 `VALIDATOR_*` 命名规范，并遵循 AppError 标准结构。  
  [Source: architecture/coding-standards.md#6.1 统一 AppError]  
  [Source: architecture/coding-standards.md#6.2 错误码命名规范（便于聚合)]

### File Locations
- `src/validator/schema/report_v1.schema.json`：Report v1 JSON Schema。  
  [Source: architecture/source-tree.md#1) 源码目录结构（AI Signal Bot）]
- `src/validator/ajv.ts`、`src/validator/index.ts`：schema 校验与 Validator 入口。  
  [Source: architecture/source-tree.md#1) 源码目录结构（AI Signal Bot）]
- `src/orchestrator/steps/report.validate.step.ts`：Validator step。  
  [Source: architecture/source-tree.md#1) 源码目录结构（AI Signal Bot）]

### Testing Requirements
- 单测覆盖所有分支/边界/错误路径。  
  [Source: architecture/coding-standards.md#11.3 单元测试范围（必须覆盖“各种情况”)]
- 测试形态参考单元/集成策略。  
  [Source: architecture/tech-stack.md#9) 测试策略]

### Technical Constraints
- Node.js 18+/20、TypeScript strict、ESM 模块制式。  
  [Source: architecture/tech-stack.md#2) 语言与运行时]

### Project Structure Notes
- `docs/architecture/unified-project-structure.md` 未找到；使用 `docs/architecture/source-tree.md` 作为目录结构依据。  
  [Source: architecture/source-tree.md#1) 源码目录结构（AI Signal Bot）]
- `docs/architecture/testing-strategy.md` 未找到；测试策略参考 `tech-stack.md` 与 `coding-standards.md`。  
  [Source: architecture/tech-stack.md#9) 测试策略]  
  [Source: architecture/coding-standards.md#11.3 单元测试范围（必须覆盖“各种情况”)]

## Change Log
| Date       | Version | Description | Author |
| ---------- | ------- | ----------- | ------ |
| 2026-01-27 | 0.1     | 创建故事草稿 | Bob    |
| 2026-01-27 | 0.2     | 校验通过，状态调整为 Approved | Winston |

## Dev Agent Record
### Agent Model Used

### Debug Log References

### Completion Notes List

### File List

## QA Results
