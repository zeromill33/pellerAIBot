# Story 3.3: Tavily D 车道条件触发与查询执行

## Status
Done

## Story
**作为** 系统（Query Strategy / Search Step），  
**我希望** 在满足条件时触发 Tavily D 车道并执行 2–3 类查询，  
**以便** 对社交驱动或高波动事件补充证据来源与覆盖面。

Epic Context: 对应 Epic 3「Tavily 多车道检索」的 E3-S3。  
[Source: prd/epic-plan.md#Epic 3：Tavily 多车道检索]

Dependencies: E3-S1（Query Plan 生成）、E3-S2（Tavily A/B/C 检索与 raw_content 采集）。  
[Source: prd/epic-plan.md#Epic 3：Tavily 多车道检索]

## Acceptance Criteria
1. D 车道默认关闭，仅在满足条件时启用；触发后必须执行 2–3 类不同类型 Query。  
   [Source: prd/appendices/tavily-query-generator.md#D1 车道定义（Week 1 默认 A+B+C，D 条件触发）]  
   [Source: prd/appendices/tavily-query-generator.md#D4 Query 模板（按车道）]
2. D 车道触发条件符合配置与 PRD：赔率 24h 大幅波动、事件属于社交驱动类别、或分歧证据不足（<2）。  
   [Source: prd/appendices/tavily-query-generator.md#D6 触发补搜（节省额度的控制策略）]  
   [Source: prd/appendices/config.md#tavily]
3. D 车道 Query 模板包含 reddit/x/controversy 三类模板，且按配置读取并生成具体 query 文本。  
   [Source: prd/appendices/tavily-query-generator.md#D4 Query 模板（按车道）]  
   [Source: prd/appendices/config.md#tavily]
4. D 车道默认参数符合附录 D（`search_depth=basic`、`max_results=3`、`time_range=7d`），并允许被配置覆盖。  
   [Source: prd/appendices/tavily-query-generator.md#D5 Tavily 参数默认值（配置化）]  
   [Source: prd/appendices/config.md#tavily]
5. D 车道结果必须映射为 `TavilyLaneResult`（`lane=D`），保留 `query` 与 `raw_content` 字段。  
   [Source: architecture/architecture-core.md#3.2 核心数据结构（内部标准化 DTO）]
6. D 车道请求同样受 Tavily 全局限流与缓存键策略约束（`event_slug + day + lane + query_hash`，TTL=1d），并记录 cache hit。  
   [Source: architecture/architecture-core.md#8.2 Tavily 全局速率]  
   [Source: architecture/architecture-core.md#8.3 缓存键策略（与 PRD 附录 A 一致）]
7. 触发条件判断与 D 车道执行必须输出结构化日志（包含 `step_id`、`event_slug`、`request_id`、`run_id`、`cache_hit`、`rate_limited`）。  
   [Source: architecture/coding-standards.md#9.1 结构化日志（必须）]
8. “分歧证据不足（<2）”判断基于已存在的 `EvidenceCandidate` 计数；若证据计数不可得，则该触发条件视为不满足并记录日志。  
   [Source: architecture/architecture-core.md#3.2 核心数据结构（内部标准化 DTO）]  
   [Source: prd/appendices/tavily-query-generator.md#D6 触发补搜（节省额度的控制策略）]  
   [Source: architecture/coding-standards.md#9.1 结构化日志（必须）]

## Tasks / Subtasks
- [x] Task 1：实现/更新 D 车道触发条件评估与 Query 生成（AC: 1, 2, 3, 4）  
  [Source: architecture/coding-standards.md#2.1 Step 文件命名与顺序编排]  
  [Source: prd/appendices/tavily-query-generator.md#D6 触发补搜（节省额度的控制策略）]
  - [x] Subtask 1.1：在 QueryStrategy 中读取配置阈值与模板，生成 D 车道 queries
  - [x] Subtask 1.2：实现 24h 变化阈值与社交类别触发判断
  - [x] Subtask 1.3：实现“分歧证据不足（<2）”触发判断
  - [x] Subtask 1.4：证据计数不可得时跳过该触发条件并记录结构化日志
- [x] Task 2：在 `search.tavily` step 中执行 D 车道 queries（AC: 1, 5, 6）  
  [Source: architecture/source-tree.md#1) 源码目录结构（AI Signal Bot）]
  - [x] Subtask 2.1：当 D 车道被启用时执行 2–3 类 queries 并写入结果
  - [x] Subtask 2.2：确保 D 车道请求走相同缓存/限流路径并记录 cache_hit
- [x] Task 3：补充日志与测试覆盖（AC: 7）  
  [Source: architecture/coding-standards.md#9.1 结构化日志（必须）]  
  [Source: architecture/coding-standards.md#11.4 Provider 集成测试（外部依赖：必须有“可回放”测试）]
  - [x] Subtask 3.1：新增/更新测试覆盖 D 车道触发条件与 query 生成
  - [x] Subtask 3.2：使用 fixtures 覆盖 D 车道结果映射与缓存命中
  - [x] Subtask 3.3：新增/更新测试覆盖证据计数缺失时的触发跳过与日志输出

## Dev Notes
### Previous Story Insights
No specific guidance found in architecture docs.  
[Source: architecture/architecture-core.md]

### Data Models
- `MarketContext.price_context.signals` 包含 `change_24h` 等信号，可用于 D 车道触发判断。  
  [Source: architecture/architecture-core.md#3.2 核心数据结构（内部标准化 DTO）]
- `TavilyLaneResult` 包含 `lane`、`query`、`results[{title,url,domain,published_at,raw_content}]`。  
  [Source: architecture/architecture-core.md#3.2 核心数据结构（内部标准化 DTO）]
- `EvidenceCandidate` 包含 `stance` 字段，可用于判断分歧证据数量。  
  [Source: architecture/architecture-core.md#3.2 核心数据结构（内部标准化 DTO）]

### API Specifications
- `SearchProvider` 提供 `search`/`batchSearch` 接口，Week 1 使用 Tavily。  
  [Source: architecture/architecture-core.md#3.1 Provider 接口清单（概览）]
- 主流程在 QueryStrategy 之后执行 Tavily 多车道检索。  
  [Source: architecture/architecture-core.md#4.1 主流程（单事件）]

### Component Specifications
- D 车道 Query 模板：reddit / x / controversy 三类查询。  
  [Source: prd/appendices/tavily-query-generator.md#D4 Query 模板（按车道）]
- D 车道默认参数：`search_depth=basic`、`max_results=3`、`time_range=7d`。  
  [Source: prd/appendices/tavily-query-generator.md#D5 Tavily 参数默认值（配置化）]
- Tavily 全局限流 qps/burst 与缓存 TTL=1d，缓存键 `event_slug + day + lane + query_hash`。  
  [Source: architecture/architecture-core.md#8.2 Tavily 全局速率]  
  [Source: architecture/architecture-core.md#8.3 缓存键策略（与 PRD 附录 A 一致）]

### Environment Variables
- `TAVILY_API_KEY` 仅通过环境变量注入（不写入 repo/日志/DB），并在配置加载时绑定到 Tavily 相关配置字段。  
  [Source: architecture/coding-standards.md#7.2 Secrets 管理]  
  [Source: architecture/architecture-core.md#9 安全与合规（Week 1 必须做到的“底线”）]  
  [Source: prd/appendices/config.md#tavily]

### File Locations
建议按现有结构实现/修改下列位置：  
- `src/orchestrator/steps/query.plan.build.step.ts`（D 车道触发与 queries 生成）  
- `src/orchestrator/steps/search.tavily.step.ts`（执行 D 车道 queries）  
- `src/providers/tavily/lanes.ts`（D 车道默认参数与模板）  
- `src/config/defaults.ts`、`src/config/config.schema.ts`（D 车道配置默认值）  
[Source: architecture/source-tree.md#1) 源码目录结构（AI Signal Bot）]

### Testing Requirements
- Provider 集成测试使用 fixtures，并覆盖 D 车道触发与缓存命中。  
  [Source: architecture/coding-standards.md#11.4 Provider 集成测试（外部依赖：必须有“可回放”测试）]
- 测试需保证可重复性（固定时间/随机）。  
  [Source: architecture/coding-standards.md#11.8 可重复性（Determinism）要求]
- 关键场景：  
  - `change_24h` 触发 D 车道  
  - `social_categories` 触发 D 车道  
  - 证据计数不足触发 D 车道；证据计数缺失时跳过触发并记录日志  
  [Source: prd/appendices/tavily-query-generator.md#D6 触发补搜（节省额度的控制策略）]  
  [Source: architecture/coding-standards.md#9.1 结构化日志（必须）]
- E2E：按 `docs/stories/9.5.e2e-pipeline-regression.md` 的入口与规范执行，在 fake providers 的 E2E 路径中覆盖 D 车道触发与执行，验证结构化日志与缓存/限流路径可见。  
  [Source: docs/stories/9.5.e2e-pipeline-regression.md#Acceptance Criteria]  
  [Source: architecture/coding-standards.md#11.7 端到端 E2E（最小 smoke，保证“交互闭环”）]  
  [Source: architecture/coding-standards.md#9.1 结构化日志（必须）]

### Technical Constraints
- TypeScript 严格模式、ESM 模块制式。  
  [Source: architecture/tech-stack.md#2) 语言与运行时]
- 外部请求必须设置超时与重试边界。  
  [Source: architecture/coding-standards.md#3.2 超时 / 重试 / 退避（硬性要求）]

### Project Structure Notes
- `docs/architecture/unified-project-structure.md` 未找到；使用 `docs/architecture/source-tree.md` 作为目录结构依据。  
  [Source: architecture/source-tree.md#1) 源码目录结构（AI Signal Bot）]
- `docs/architecture/testing-strategy.md` 未找到；使用 `tech-stack.md` 与 `coding-standards.md` 中的测试策略说明。  
  [Source: architecture/tech-stack.md#9) 测试策略]  
  [Source: architecture/coding-standards.md#11.4 Provider 集成测试（外部依赖：必须有“可回放”测试）]

## Change Log
| Date       | Version | Description | Author |
| ---------- | ------- | ----------- | ------ |
| 2026-01-24 | 0.1     | 创建故事草稿 | Bob |
| 2026-01-24 | 0.2     | 实现 D 车道触发与查询执行 | James |
| 2026-01-24 | 0.3     | 修正证据立场枚举导致的 D 车道误触发 | James |
| 2026-01-26 | 0.4     | 修正 Tavily time_range 兼容与 e2e 步骤断言 | James |
| 2026-01-26 | 0.5     | e2e 摘要补充 Tavily 原始结果输出 | James |
| 2026-01-26 | 0.6     | Query plan 从 market_signals 回填价格信号 | James |
| 2026-01-26 | 0.7     | e2e 支持强制 D 车道与超时调整 | James |

## Dev Agent Record
### Agent Model Used
- GPT-5

### Debug Log References
- `pnpm test`
- `pnpm test -- tests/providers/tavily/provider.test.ts`
- `pnpm test:e2e`
- `pnpm test -- tests/orchestrator/query-plan.step.test.ts`
- `RUN_E2E=1 TEST_LIVE=1 E2E_FORCE_D=1 E2E_STOP_STEP=search.tavily pnpm test:e2e`

### Completion Notes List
- 增加 D 车道触发条件评估与查询模板渲染，记录结构化日志。
- 搜索 step 支持 D 车道多 query 执行并聚合缓存/限流指标输出。
- 补充 D 车道触发、日志与 provider 缓存映射相关测试。
- 修正分歧证据计数枚举并补充覆盖测试。
- Tavily 请求 time_range 与官方参数对齐，并允许空结果返回。
- e2e 测试按 stop step 动态断言步骤列表。
- e2e 汇总输出 Tavily 原始 results 便于查看真实返回。
- Query plan 优先使用 market_signals 的 price_context 作为 24h 变化触发来源。
- e2e 通过 E2E_FORCE_D 强制 D 车道并延长 live 超时。

### File List
- src/orchestrator/steps/query.plan.build.step.ts
- src/orchestrator/steps/search.tavily.step.ts
- src/orchestrator/pipeline.ts
- src/orchestrator/types.ts
- src/providers/tavily/index.ts
- tests/orchestrator/query-plan.step.test.ts
- tests/orchestrator/search-tavily.step.test.ts
- tests/providers/tavily/lanes.test.ts
- tests/providers/tavily/provider.test.ts
- tests/e2e/publish-pipeline.e2e.test.ts

## QA Results

### Review Date: 2026-01-26

### Reviewed By: Quinn (Test Architect)

### Code Quality Assessment
实现与分层约束一致，D 车道触发逻辑、query 生成与执行路径清晰；已兼容 Tavily time_range 参数并支持从 market_signals 回填价格信号。流程性注意：故事状态为 Done（非 Review），为后置 QA 评审。

### Refactoring Performed
未进行重构。

### Compliance Check
- Coding Standards: ✓ 结构化日志与限流/缓存路径符合规范。
- Project Structure: ✓ 未越界依赖，step/ provider 分层清晰。
- Testing Strategy: ✓ 单测与 live e2e 覆盖 D 车道与执行路径。
- All ACs Met: ✓ AC1-8 覆盖完备。

### Improvements Checklist
- [x] 补充 D 车道触发与查询生成测试（tests/orchestrator/query-plan.step.test.ts）
- [x] 补充 D 车道执行/日志聚合测试（tests/orchestrator/search-tavily.step.test.ts）
- [x] 补充 Tavily provider D 车道与 time_range 兼容测试（tests/providers/tavily/provider.test.ts）
- [x] 执行 live e2e（E2E_FORCE_D=1）
- [ ] 当 evidence step 接入后，将 evidence_candidates 显式传入 pipeline 以增强触发可控性（src/orchestrator/pipeline.ts）

### Security Review
未引入鉴权/敏感数据处理变更；密钥仍只通过环境变量注入。未发现安全风险。

### Performance Considerations
D 车道最多增加 3 次 Tavily 调用，受全局 qps/burst 控制；live e2e 的 Tavily step 延迟在可接受范围内，建议继续观测真实流量下的延迟与配额消耗。

### Files Modified During Review
无。

### Gate Status
Gate: PASS → docs/qa/gates/3.3-tavily-lane-d-trigger.yml  
Risk profile: docs/qa/assessments/3.3-risk-20260126.md  
NFR assessment: docs/qa/assessments/3.3-nfr-20260126.md

### Recommended Status
[✓ Ready for Done] / [✗ Changes Required - See unchecked items above]
(Story owner decides final status)

### Review Date: 2026-01-26

### Reviewed By: Quinn (Test Architect)

### Code Quality Assessment
新增 pipeline 对 evidence_candidates 的透传与基于 market_signals 的 D 车道“自然触发”live e2e 用例，逻辑清晰且与现有分层一致。

### Refactoring Performed
未进行重构。

### Compliance Check
- Coding Standards: ✓ 日志与限流/缓存路径保持一致。
- Project Structure: ✓ step 与 provider 边界清晰。
- Testing Strategy: ✓ 增补 pipeline 透传测试与可选 live e2e 用例。
- All ACs Met: ✓ 无新增 AC 影响。

### Improvements Checklist
- [x] Pipeline 透传 evidence_candidates（src/orchestrator/pipeline.ts）
- [x] 新增 pipeline 透传单测（tests/orchestrator/pipeline-query-plan.step.test.ts）
- [x] 补充“自然触发 D 车道”live e2e 用例（tests/e2e/publish-pipeline.e2e.test.ts）
- [ ] 提供稳定可复现的 `E2E_EVENT_URL_D` 事件（否则该用例默认 skip）

### Security Review
未引入安全相关变更；密钥仍由环境变量提供。

### Performance Considerations
新增用例仅在 `E2E_EVENT_URL_D` 配置时运行，不影响默认测试开销。

### Files Modified During Review
本次 QA 修改了代码与测试文件，请开发补充 File List：
- src/orchestrator/types.ts
- src/orchestrator/pipeline.ts
- tests/orchestrator/pipeline-query-plan.step.test.ts
- tests/e2e/publish-pipeline.e2e.test.ts

### Gate Status
Gate: PASS → docs/qa/gates/3.3-tavily-lane-d-trigger.yml  
Risk profile: docs/qa/assessments/3.3-risk-20260126.md  
NFR assessment: docs/qa/assessments/3.3-nfr-20260126.md

### Recommended Status
[✓ Ready for Done] / [✗ Changes Required - See unchecked items above]
(Story owner decides final status)
