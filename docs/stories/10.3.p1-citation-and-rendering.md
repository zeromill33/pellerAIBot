# Story 10.3: P1 引用与渲染规范化（CitationManager）

## Status
Approved

## Story
**作为** 系统（Renderer/Validator），  
**我希望** 在报告正文中使用编号引用并在文末输出统一 sources，  
**以便** 报告可读、可审计且避免直接裸贴 URL。

Epic Context: Epic 10「报告质量优化（P0/P1）」的 P1 引用编号与渲染规范化。  
[Source: architecture/report_quality_P0_P1_implementation.md#P1-1 引用编号/脚注系统（CitationManager）]

Dependencies: 依赖 Report v1 JSON 输出与 Validator/Renderer 主流程可用。  
[Source: architecture/architecture-core.md#4.1 主流程（单事件）]

## Acceptance Criteria
1. Renderer 不再在正文直接贴 URL，改用 `【n】` 编号引用；文末输出 Sources 列表（`【n】domain — title — url`）。编号来源至少覆盖 `disagreement_map` 与 `sentiment.samples` 的 URL。  
   [Source: architecture/report_quality_P0_P1_implementation.md#P1-1 引用编号/脚注系统（CitationManager）]
2. 在 Report v1 schema 中扩展 `evidenceItem`，新增可审计字段：`domain`、`title`、`published_at`、`snippet(<=280 chars)`、`claim_summary`，并在 prompt/后处理层保证输出一致；不允许 `additionalProperties` 放开。  
   [Source: architecture/report_quality_P0_P1_implementation.md#P1-1 引用编号/脚注系统（CitationManager）]
3. Validator 新增规则：`unique_domains >= 2~3`（配置化）且 `evidence_with_snippet_ratio >= 0.7`（配置化，基于 `disagreement_map` 的 evidenceItem 统计）；违规则阻断发布。  
   [Source: architecture/report_quality_P0_P1_implementation.md#P1-1 引用编号/脚注系统（CitationManager）]
4. 渲染输出仍遵循模板化与可重复性要求，确保相同输入输出一致；必要时更新渲染模板与格式化逻辑。  
   [Source: architecture/coding-standards.md#4.1 LLM 只输出结构化 JSON（硬性）]  
   [Source: architecture/coding-standards.md#11.8 可重复性（Determinism）要求]
5. 补充单元/快照测试覆盖引用编号与 sources 输出、以及 validator 新规则。  
   [Source: architecture/coding-standards.md#11.3 单元测试范围（必须覆盖“各种情况”)]

## Tasks / Subtasks
- [ ] Task 1：补齐可审计证据字段（AC: 2）  
  [Source: architecture/report_quality_P0_P1_implementation.md#P1-1 引用编号/脚注系统（CitationManager）]
  - [ ] Subtask 1.1：更新 `src/validator/schema/report_v1.schema.json` 的 `evidenceItem` 以包含 `domain/title/published_at/snippet/claim_summary`
  - [ ] Subtask 1.2：更新 `prompts/report_v1_generate.prompt.txt`，要求 disagreement_map 输出上述字段
  - [ ] Subtask 1.3：在 LLM 输出后处理/校验中保证字段一致性（缺失字段会影响 snippet 比例校验）
- [ ] Task 2：实现 CitationManager 与渲染改造（AC: 1, 4）  
  [Source: architecture/source-tree.md#1) 源码目录结构（AI Signal Bot）]
  - [ ] Subtask 2.1：在 `src/renderer/` 增加编号映射与 sources 汇总逻辑（CitationManager）
  - [ ] Subtask 2.2：更新 `src/renderer/templates/telegram.md.txt`，用 `【n】` 替代裸 URL
- [ ] Task 3：Validator 新规则（AC: 3）  
  [Source: architecture/report_quality_P0_P1_implementation.md#P1-1 引用编号/脚注系统（CitationManager）]
  - [ ] Subtask 3.1：在 `src/validator/gates.ts` 增加 domain 多样性与 snippet 比例校验（配置化）
- [ ] Task 4：测试覆盖（AC: 5）  
  [Source: architecture/coding-standards.md#11.3 单元测试范围（必须覆盖“各种情况”)]
  - [ ] Subtask 4.1：渲染输出快照测试（含编号与 sources）
  - [ ] Subtask 4.2：Validator 新规则触发/通过用例

## Dev Notes
### Previous Story Insights
当前最高 story 10.2 为 Draft（非 Done），存在流程风险但不阻断本条起草。  
[Source: architecture/architecture-core.md#4.1 主流程（单事件）]

### Data Models
- Report v1 JSON 由 schema 约束，证据字段变化需同步 schema/prompt/validator。  
  [Source: prd/appendices/report-v1-schema.md#附录 B：Report v1 JSON Schema（0–100 概率）]

### API Specifications
- Renderer 负责将 Report JSON 转为 TG Markdown，禁止二次调用 LLM 改写。  
  [Source: architecture/source-tree.md#1) 源码目录结构（AI Signal Bot）]

### Component Specifications
- Validator 为发布闸门，新增规则必须阻断不合规输出。  
  [Source: architecture/tech-stack.md#7) 校验与安全护栏（Validator）]

### File Locations
- `src/renderer/index.ts`、`src/renderer/templates/telegram.md.txt`：渲染逻辑与模板。  
  [Source: architecture/source-tree.md#1) 源码目录结构（AI Signal Bot）]
- `src/validator/gates.ts`：内容闸门规则。  
  [Source: architecture/source-tree.md#1) 源码目录结构（AI Signal Bot）]
- `prompts/report_v1_generate.prompt.txt` 与 `src/validator/schema/report_v1.schema.json`：结构与输出约束。  
  [Source: architecture/source-tree.md#1) 源码目录结构（AI Signal Bot）]

### Project Structure Notes
未找到 `docs/architecture/unified-project-structure.md` 与 `docs/architecture/testing-strategy.md`，本 story 以 `source-tree.md` 与 `coding-standards.md` 为结构/测试依据。  
[Source: architecture/source-tree.md#1) 源码目录结构（AI Signal Bot）]  
[Source: architecture/coding-standards.md#11. 测试与质量门禁（必须更严格：build 通过 + 单测覆盖 + 外部依赖集成测试）]

### Testing Requirements
- 单元测试必须覆盖分支/边界/错误路径；Renderer 推荐 snapshot 测试。  
  [Source: architecture/coding-standards.md#11.3 单元测试范围（必须覆盖“各种情况”)]
- 输出需可重复，避免依赖外网。  
  [Source: architecture/coding-standards.md#11.8 可重复性（Determinism）要求]

## Change Log
| Date       | Version | Description | Author |
| ---------- | ------- | ----------- | ------ |
| 2026-01-30 | v0.1    | 初稿（P1 引用与渲染规范化） | Bob (SM) |

## Dev Agent Record
### Agent Model Used

### Debug Log References

### Completion Notes List

### File List

## QA Results
