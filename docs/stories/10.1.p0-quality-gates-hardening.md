# Story 10.1: P0 质量闸门补强（Δ一致性/占位符范围/补搜触发）

## Status
Approved

## Story
**作为** 系统（Validator/Orchestrator），  
**我希望** 强化 Δ 一致性校验与占位符范围校验，并输出明确错误码以触发补搜，  
**以便** 低级错误被阻断、并尽可能通过一次补搜提升报告质量。

Epic Context: Epic 10「报告质量优化（P0/P1）」的 P0 质量闸门补强。  
[Source: architecture/report_quality_P0_P1_implementation.md#1. P0 必做（避免低级错、避免空洞输出）]

Dependencies: 依赖既有 Validator 与 Orchestrator 主流程可用（schema + 内容闸门 + 补搜）。  
[Source: architecture/architecture-core.md#4.1 主流程（单事件）]  
[Source: architecture/architecture-core.md#4.3 “补搜”策略（节省额度 + 提升通过率）]

## Acceptance Criteria
1. `ai_vs_market.delta` 必须与 `ai_yes_beta - market_yes` 保持一致（允许 ≤0.1 容差）；不一致则 Validator 返回 `VALIDATOR_METRICS_MISMATCH`，并包含期望/实际差值明细。  
   [Source: architecture/report_quality_P0_P1_implementation.md#P0-1 Δ 一致性校验 + 代码侧派生收口]
2. 仅允许以下占位符范围：  
   - `disagreement_map.*.time` 在证据不足时可为 `N/A`（且需绑定 market url）  
   - `sentiment.samples` 为空时 `bias/relation=unknown`  
   其他字段出现 `N/A/unknown` 必须阻断并返回 `VALIDATOR_PLACEHOLDER_OUTPUT`。  
   [Source: architecture/report_quality_P0_P1_implementation.md#P0-2 控制占位符范围（允许但必须可解释）]
3. 当 Validator 返回 `VALIDATOR_PLACEHOLDER_OUTPUT` 或证据不足类错误时，Orchestrator 必须触发一次补搜（C lane advanced），若仍失败则落地 blocked 并返回原因。  
   [Source: architecture/report_quality_P0_P1_implementation.md#P0-2 控制占位符范围（允许但必须可解释）]  
   [Source: architecture/architecture-core.md#4.3 “补搜”策略（节省额度 + 提升通过率）]
4. 为新增校验补充单元测试：覆盖通过/失败分支与边界容差；测试用例需可重复。  
   [Source: architecture/coding-standards.md#11.3 单元测试范围（必须覆盖“各种情况”)]  
   [Source: architecture/coding-standards.md#11.8 可重复性（Determinism）要求]

## Tasks / Subtasks
- [ ] Task 1：新增 Validator 校验与错误码（AC: 1, 2）  
  [Source: architecture/source-tree.md#1) 源码目录结构（AI Signal Bot）]  
  [Source: architecture/tech-stack.md#7) 校验与安全护栏（Validator）]
  - [ ] Subtask 1.1：在 `src/validator/gates.ts` 增加 Δ 一致性校验与占位符范围白名单
  - [ ] Subtask 1.2：在 `src/orchestrator/errors.ts` 新增 `VALIDATOR_METRICS_MISMATCH` 与 `VALIDATOR_PLACEHOLDER_OUTPUT`
  - [ ] Subtask 1.3：在 `src/validator/index.ts` 保持闸门顺序稳定，首个失败即返回
- [ ] Task 2：补搜触发码收口（AC: 3）  
  [Source: architecture/architecture-core.md#4.3 “补搜”策略（节省额度 + 提升通过率）]  
  [Source: architecture/coding-standards.md#2.2 Step 统一接口（强约束）]
  - [ ] Subtask 2.1：在 `src/orchestrator/pipeline.ts` 的补搜触发集合中加入新错误码
  - [ ] Subtask 2.2：确保补搜只触发一次，失败后落地 blocked 并返回 validator 原因
- [ ] Task 3：新增单元测试覆盖（AC: 4）  
  [Source: architecture/coding-standards.md#11.3 单元测试范围（必须覆盖“各种情况”)]
  - [ ] Subtask 3.1：在 `tests/validator/` 增加 delta 一致性校验的通过/失败用例
  - [ ] Subtask 3.2：增加占位符范围校验用例（允许范围/禁止范围）

## Dev Notes
### Previous Story Insights
无已完成的直接前置 story；当前最高 story 9.5 状态为 Review，仅作为风险提示。  
[Source: architecture/architecture-core.md#4.1 主流程（单事件）]

### Data Models
- Report v1 JSON 的 `ai_vs_market` 与 `sentiment` 字段由 Validator 校验。  
  [Source: architecture/architecture-core.md#3.2 核心数据结构（内部标准化 DTO）]

### API Specifications
- Validator 作为发布闸门，任一失败必须阻断发布并返回错误码。  
  [Source: architecture/tech-stack.md#7) 校验与安全护栏（Validator）]

### Component Specifications
- Validator 规则应集中在 `src/validator/*`，禁止绕过 Validator 发布。  
  [Source: architecture/coding-standards.md#1.1 分层定义（本项目版）]

### File Locations
- `src/validator/gates.ts`：内容闸门规则实现。  
  [Source: architecture/source-tree.md#1) 源码目录结构（AI Signal Bot）]
- `src/validator/index.ts`：Validator 入口聚合。  
  [Source: architecture/source-tree.md#1) 源码目录结构（AI Signal Bot）]
- `src/orchestrator/pipeline.ts`：补搜触发与主流程编排。  
  [Source: architecture/source-tree.md#1) 源码目录结构（AI Signal Bot）]
- `src/orchestrator/errors.ts`：统一错误码定义。  
  [Source: architecture/source-tree.md#1) 源码目录结构（AI Signal Bot）]

### Project Structure Notes
未找到 `docs/architecture/unified-project-structure.md` 与 `docs/architecture/testing-strategy.md`，本 story 以 `source-tree.md` 与 `coding-standards.md` 为结构/测试依据。  
[Source: architecture/source-tree.md#1) 源码目录结构（AI Signal Bot）]  
[Source: architecture/coding-standards.md#11. 测试与质量门禁（必须更严格：build 通过 + 单测覆盖 + 外部依赖集成测试）]

### Testing Requirements
- 单元测试必须覆盖分支/边界/错误路径；Validator 规则建议表驱动测试。  
  [Source: architecture/coding-standards.md#11.3 单元测试范围（必须覆盖“各种情况”)]
- 测试需可重复，避免依赖外网。  
  [Source: architecture/coding-standards.md#11.8 可重复性（Determinism）要求]

## Change Log
| Date       | Version | Description | Author |
| ---------- | ------- | ----------- | ------ |
| 2026-01-30 | v0.1    | 初稿（P0 质量闸门补强） | Bob (SM) |

## Dev Agent Record
### Agent Model Used

### Debug Log References

### Completion Notes List

### File List

## QA Results
