# Story 5.3: AI 概率与市场概率输出（含免责声明与禁喊单）

## Status
Done

## Story
**作为** 系统（LLMProvider/Report Generator），  
**我希望** 输出 AI 概率（Beta）与市场概率的对比，并附带合规免责声明且禁止任何下注建议，  
**以便** 报告保持合规、可解释，并通过 Validator 内容闸门。

Epic Context: 对应 Epic 5「Report v1 生成」的 E5-S3。  
[Source: prd/epic-plan.md#Epic 5：Report v1 生成]

Dependencies: 依赖 E5-S1（LLM 输入组装）与 E5-S2（Report v1 JSON 输出）；依赖 MarketContext 中市场概率（0–100）口径一致。  
[Source: prd/prd-core.md#B1. 背景与痛点]  
[Source: prd/prd-core.md#B3. MVP 目标（Week 1）]  
[Source: prd/prd-core.md#B5. 成功指标（Week 1 可观察）]

## Acceptance Criteria
1. `ai_vs_market` 必须包含 `market_yes`、`ai_yes_beta`、`delta` 与 `drivers`（1–3 条），且概率范围统一为 0–100。  
   [Source: prd/appendices/report-v1-schema.md#附录 B：Report v1 JSON Schema（0–100 概率）]  
   [Source: prd/prd-core.md#B1. 背景与痛点]
2. `ai_vs_market.market_yes` 必须与 `context.market_odds.yes` 使用同一口径（0–100），`delta` 为两者差值的直观表达。  
   [Source: prd/appendices/report-v1-schema.md#附录 B：Report v1 JSON Schema（0–100 概率）]  
   [Source: prd/prd-core.md#B1. 背景与痛点]
3. `drivers` 必须是“差值驱动证据”（≤3 条），且不得包含任何下注/资金管理建议措辞。  
   [Source: prd/prd-core.md#D2. Report v1（强制输出结构）]  
   [Source: prd/appendices/validator.md#F2. 内容闸门（失败则阻断发布）]
4. `limitations.not_included` 必须包含 `no_bet_advice` 与 `no_position_sizing`（固定免责声明），确保输出不构成投资建议。  
   [Source: prd/appendices/report-v1-schema.md#附录 B：Report v1 JSON Schema（0–100 概率）]  
   [Source: prd/prd-core.md#D2. Report v1（强制输出结构）]
5. LLM 输出必须为纯 JSON，且所有“禁喊单/免责声明”规则需通过 prompt 约束与 Validator 闸门共同保证。  
   [Source: prd/appendices/prompts.md#G1. Report v1 生成 Prompt]  
   [Source: architecture/coding-standards.md#4.1 LLM 只输出结构化 JSON（硬性）]  
   [Source: prd/appendices/validator.md#F2. 内容闸门（失败则阻断发布）]
6. E2E fake 模式的 mock LLM 输出需包含 `ai_vs_market` 与 `limitations.not_included`，用于回归校验禁喊单与免责声明规则。  
   [Source: prd/appendices/report-v1-schema.md#附录 B：Report v1 JSON Schema（0–100 概率）]  
   [Source: prd/appendices/validator.md#F2. 内容闸门（失败则阻断发布）]

## Tasks / Subtasks
- [x] Task 1：在 LLM Prompt/输出中强化 AI vs 市场概率段落（AC: 1-5）  
  [Source: prd/appendices/prompts.md#G1. Report v1 生成 Prompt]  
  [Source: prd/appendices/report-v1-schema.md#附录 B：Report v1 JSON Schema（0–100 概率）]
  - [x] Subtask 1.1：确保 prompt 明确要求 `ai_vs_market` 字段与 0–100 概率口径
  - [x] Subtask 1.2：确保 prompt 明确禁止下注建议/资金管理建议（drivers 不得含“喊单”措辞）
- [x] Task 2：在 LLMProvider 输出后保证字段完整与合规（AC: 1-5）  
  [Source: architecture/providers/llm.md#E.1 输出强约束]  
  [Source: architecture/coding-standards.md#4.3 反幻觉策略（必须落地）]
  - [x] Subtask 2.1：在 `postprocess`/调用侧校验 `ai_vs_market` 字段存在、drivers 长度 1–3
  - [x] Subtask 2.2：若出现“喊单”措辞，确保 Validator 阻断并返回明确失败原因
- [x] Task 3：补充 AI vs 市场概率输出测试（AC: 1-5）  
  [Source: architecture/coding-standards.md#11.6 LLM 测试策略（禁止“靠模型随机性”)]  
  [Source: architecture/coding-standards.md#11.3 单元测试范围（必须覆盖“各种情况”)]
  - [x] Subtask 3.1：Mock LLM 输出，覆盖 drivers 过多/为空、概率越界等失败分支
  - [x] Subtask 3.2：验证 limitations.not_included 包含固定免责声明
- [x] Task 4：E2E fake 输出补齐 AI vs 市场概率字段（AC: 6）  
  [Source: tests/e2e/publish-pipeline.e2e.test.ts]
  - [x] Subtask 4.1：更新 E2E mock LLM 输出，包含 `ai_vs_market` 与免责声明字段

## Dev Notes
### Previous Story Insights
No specific guidance found in architecture docs.  
[Source: architecture/architecture-core.md]

### Data Models
- `ai_vs_market` 结构：`market_yes`、`ai_yes_beta`、`delta`、`drivers`（1–3）。  
  [Source: prd/appendices/report-v1-schema.md#附录 B：Report v1 JSON Schema（0–100 概率）]
- `limitations.not_included` 取值限定为 `no_bet_advice` / `no_position_sizing`。  
  [Source: prd/appendices/report-v1-schema.md#附录 B：Report v1 JSON Schema（0–100 概率）]

### API Specifications
- LLMProvider 生成 Report v1 JSON，输出需通过 Validator 内容闸门（反“喊单”）。  
  [Source: architecture/providers/llm.md#E.1 输出强约束]  
  [Source: prd/appendices/validator.md#F2. 内容闸门（失败则阻断发布）]

### Component Specifications
- Prompt 必须文件化与版本化，并强制约束 JSON 输出与禁喊单。  
  [Source: architecture/coding-standards.md#4.2 Prompt 版本化与可审计]  
  [Source: prd/appendices/prompts.md#G1. Report v1 生成 Prompt]
- Validator 负责拦截下注建议措辞与 drivers 违规。  
  [Source: prd/appendices/validator.md#F2. 内容闸门（失败则阻断发布）]

### File Locations
- `prompts/report_v1_generate.prompt.txt`：Report v1 prompt 文件。  
  [Source: architecture/source-tree.md#1) 源码目录结构（AI Signal Bot）]
- `src/providers/llm/postprocess.ts`、`src/providers/llm/index.ts`：LLM 输出解析与生成。  
  [Source: architecture/source-tree.md#1) 源码目录结构（AI Signal Bot）]
- `src/validator/*`：内容闸门与反“喊单”规则。  
  [Source: architecture/source-tree.md#1) 源码目录结构（AI Signal Bot）]

### Testing Requirements
- LLM 测试必须 mock，禁止真实外网调用。  
  [Source: architecture/coding-standards.md#11.6 LLM 测试策略（禁止“靠模型随机性”)]
- 单测覆盖边界与错误路径（drivers 长度、概率越界、免责声明缺失）。  
  [Source: architecture/coding-standards.md#11.3 单元测试范围（必须覆盖“各种情况”)]

### Technical Constraints
- 概率口径统一为 0–100（AI 概率 Beta + 市场概率一致口径）。  
  [Source: prd/prd-core.md#B1. 背景与痛点]

### Project Structure Notes
- `docs/architecture/unified-project-structure.md` 未找到；使用 `docs/architecture/source-tree.md` 作为目录结构依据。  
  [Source: architecture/source-tree.md#1) 源码目录结构（AI Signal Bot）]
- `docs/architecture/testing-strategy.md` 未找到；测试策略参考 `coding-standards.md` 中 LLM 测试要求。  
  [Source: architecture/coding-standards.md#11.6 LLM 测试策略（禁止“靠模型随机性”)]

## Change Log
| Date       | Version | Description | Author |
| ---------- | ------- | ----------- | ------ |
| 2026-01-27 | 0.1     | 创建故事草稿 | Bob    |
| 2026-01-27 | 0.2     | 纳入 E2E fake 输出要求 | Winston |
| 2026-01-27 | 0.3     | 校验通过，状态调整为 Approved | Winston |
| 2026-01-27 | 0.4     | 强化 ai_vs_market 校验与禁喊单检测 | James |
| 2026-01-28 | 0.5     | E2E 支持真实 LLM 与 Report v1 schema 强约束 | James |

## Dev Agent Record
### Agent Model Used
GPT-5 (Codex CLI)

### Debug Log References
- `npm test`
- `RUN_E2E=1 TEST_LIVE=1 E2E_LLM_LIVE=1 E2E_TIMEOUT_MS=120000 npm run test:e2e`

### Completion Notes List
- 强化 prompt 的 ai_vs_market/免责声明约束。
- 增加 ai_vs_market delta 与 drivers 禁喊单校验。
- 补充 ai_vs_market 失败分支测试覆盖。
- E2E 支持真实 LLM，prompt 内嵌 Report v1 JSON Schema 以稳定输出结构。
- Gamma 事件解析加入 resolutionSource，规则字段支持 description 回退。

### File List
- prompts/report_v1_generate.prompt.txt
- scripts/run-e2e-live.example.sh
- src/providers/llm/postprocess.ts
- tests/providers/llm/provider.test.ts
- docs/ops/e2e.md
- src/orchestrator/steps/report.generate.step.ts
- src/orchestrator/types.ts
- src/providers/llm/types.ts
- src/providers/polymarket/gamma.ts
- tests/e2e/publish-pipeline.e2e.test.ts

## QA Results

### Review Date: 2026-01-28

### Reviewed By: Quinn (Test Architect)

### Code Quality Assessment
实现整体清晰，prompt 与后处理约束强化了结构稳定性；单测覆盖新增了关键失败分支。主要缺口在于 AC2 的一致性关系未被显式校验（market_yes 与 context.market_odds.yes 以及 delta 关系），存在输出不一致风险。

### Refactoring Performed
无。

### Compliance Check
- Coding Standards: ✓（LLM 输出严格 JSON、边界分层未破坏）
- Project Structure: ✓
- Testing Strategy: ✓（LLM 相关单测为 mock，E2E 具备 live 路径）
- All ACs Met: ✗（AC2 缺少一致性校验与测试）

### Improvements Checklist
- [ ] 为 `ai_vs_market.market_yes` 与 `context.market_odds.yes` 的一致性及 `delta` 关系增加校验（`src/providers/llm/postprocess.ts`）
- [ ] 为上述一致性校验补充单测（`tests/providers/llm/provider.test.ts`）
- [ ] `time_remaining` 计算引入可注入时钟以提升可回放/可测试性（`src/orchestrator/steps/report.generate.step.ts`）

### Security Review
未发现直接安全问题；注意 `.env` 中密钥轮换与避免外泄（已被 `.gitignore` 排除）。

### Performance Considerations
Prompt 体积增大可能略增 LLM 延迟/成本，但当前可接受。

### Files Modified During Review
无。

### Gate Status
Gate: CONCERNS → docs/qa/gates/5.3-ai-vs-market-probability.yml  
Risk profile: docs/qa/assessments/5.3-risk-20260128.md（未执行）  
NFR assessment: docs/qa/assessments/5.3-nfr-20260128.md（未执行）

### Recommended Status
[✗ Changes Required - See unchecked items above]
(Story owner decides final status)
